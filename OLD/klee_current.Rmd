---
title: "klee_current"
author: "Carmen Ebel"
date: "4/18/2021"
output: html_document
---

# Data Prep
## Read in Data
```{r, echo=FALSE, include=FALSE}
## set working directory
setwd("~/Repositories/klee-stability")

## Load packages
library(tidyverse)
library(lubridate)
library(codyn)
library(tsvr)
library(forcats)
library(knitr)
library(ggpubr)
library(data.table)
library(segmented)
library(breakpoint)
library(ggrepel)
library(lme4)
library(nlme)

## source cleaned data
source("klee_allyears_cleaning.R")

## change Treatment to factor in all dataframes
avg_biomass$TREATMENT <- as.factor(avg_biomass$TREATMENT)
big5annual$TREATMENT <- as.factor(big5annual$TREATMENT)
klee_annual$TREATMENT <- as.factor(klee_annual$TREATMENT)
nondom$TREATMENT <- as.factor(nondom$TREATMENT)
totcov$TREATMENT <- as.factor(totcov$TREATMENT)
treats$TREATMENT <- as.factor(treats$TREATMENT)

## Change treatment to an ordered factor
klee_annual <- klee_annual %>%
  mutate(TREATMENT = fct_relevel(TREATMENT, "O", "W", "MW", "C", "WC", "MWC"))
big5annual <- big5annual %>%
  mutate(TREATMENT = fct_relevel(TREATMENT, "O", "W", "MW", "C", "WC", "MWC"))
nondom <- nondom %>%
  mutate(TREATMENT = fct_relevel(TREATMENT, "O", "W", "MW", "C", "WC", "MWC"))
avg_biomass <- avg_biomass %>%
  mutate(TREATMENT = fct_relevel(TREATMENT, "O", "W", "MW", "C", "WC", "MWC"))
totcov <- totcov %>%
  mutate(TREATMENT = fct_relevel(TREATMENT, "O", "W", "MW", "C", "WC", "MWC"))
treats <- treats %>%
  mutate(TREATMENT = fct_relevel(TREATMENT, "O", "W", "MW", "C", "WC", "MWC"))
```

# Calculations
## Calculate Stability & Variance
``` {r,  echo=FALSE}
## Calculate Community Stability for entire community
commstab <- community_stability(klee_annual, 
                                time.var = "Date_numeric", 
                                abundance.var = "Pin_Hits", 
                                replicate.var = "Unique_ID")

## Calculate Variance of the full community
v <- klee_annual %>%
  group_by(TREATMENT, Unique_ID) %>%
  summarise(variance = var(Pin_Hits))

## Calculate Total Cover
pinhits <- totcov %>% #this dataframe used in models
  group_by(TREATMENT, Unique_ID) %>%
  summarize(pinhits = mean(totcov))


## join stability measures with treatment info & calculate CV
tstab <- left_join(commstab, treats, by = "Unique_ID") %>% #join comm stability with treatment info
  mutate(CV = 1/stability) #calculate the CV as inverse of stability

variance <- left_join(v, pinhits, by = c("TREATMENT", "Unique_ID"))

stability <- left_join(tstab, variance, by = c("TREATMENT", "Unique_ID"))

rm(list = c("v", "commstab", "variance", "tstab"))
```

## Calculate Stability over a Moving Window ##
``` {r, echo = FALSE}
## create function
movingwindow_func <- function(input_data, timestep, ...) { ## function inputs = data frame and number of time steps
  
  n_samples <- length(unique(input_data$Date_final)) ## number of sampling points
  n_windows <- n_samples - timestep + 1 ## how many windows to iterate over 
  movingwindow <- data.frame(matrix(ncol=3,nrow=(n_windows*length(unique(input_data$Unique_ID))))) ## create empty dataframe to contain output ## dimensions = # cols (3) x (uniqueID x timesteps)
  colnames(movingwindow) <- c("Unique_ID", "stability", "timestep")
  sample_points <- sort(unique(input_data$Date_numeric)) ## create ordered list of sample points
  
  n_plots <- length(unique(input_data$Unique_ID)) ## number of unique plots
  
  for (i in 1:n_windows){
    
    temp_samplepts <- sample_points[i:(i+timestep-1)] ## create a vector of sample points for each iteration
    
    temp <- input_data %>%
      filter(Date_numeric %in% temp_samplepts) ## filter the correct sample points from input data to run through the community stability function
    
    temp_commstab <- community_stability(temp,  ## run the community stability function from codyn
                                time.var = "Date_numeric", 
                                abundance.var = "Pin_Hits", 
                                replicate.var = "Unique_ID")
    temp_commstab$timestep <- i ## create a column for timestep in the temporary data frame
    
    movingwindow[((i-1)*n_plots + 1):(i*n_plots),] <- temp_commstab ## add stability calculations for one iteration to the moving window data frame
    ## ((i-1)*n_plots + 1):(i*n_plots) -> where to put each iteration of the loop
    
  }
  
  return(movingwindow) ## retrieve data frame at the end
  
}

## Use moving window function to calculate stability with ONLY June sampling points
annual_stab5 <- movingwindow_func(input_data = klee_annual, timestep = 5) %>%
  mutate(window_size = 5)
annual_stab7 <- movingwindow_func(input_data = klee_annual, timestep = 7) %>%
  mutate(window_size = 7)
annual_stab10 <- movingwindow_func(input_data = klee_annual, timestep = 10) %>%
  mutate(window_size = 10)

#combine all
ann5_7 <- rbind(annual_stab5, annual_stab7)
stability_mw <- rbind(ann5_7, annual_stab10)

stab_mw_tx <- left_join(stability_mw, treats, by="Unique_ID") %>%
  group_by(TREATMENT, timestep, window_size) %>%
  summarize(mean_stability = mean(stability), SE = calcSE(stability))

rm(list = c("annual_stab5", "annual_stab7", "annual_stab10", "ann5_7"))
```

## Synchrony
### Calculate Loreau Synchrony
```{r,  echo=FALSE}
## Calculate Loreau synchrony metric
synchrony <- synchrony(
  klee_annual,
  time.var = "Date_numeric",
  species.var = "SPECIES",
  abundance.var = "Pin_Hits",
  metric = "Loreau",
  replicate.var = "Unique_ID"
)
colnames(synchrony) <- c("Unique_ID", "synchrony") #rename columns

big5synchrony <- synchrony(
  big5annual,
  time.var = "Date_numeric",
  species.var = "SPECIES",
  abundance.var = "Pin_Hits",
  metric = "Loreau",
  replicate.var = "Unique_ID"
)
colnames(big5synchrony) <- c("Unique_ID", "synchrony") #rename columns

nondomsynchrony <- synchrony(
  nondom,
  time.var = "Date_numeric",
  species.var = "SPECIES",
  abundance.var = "Pin_Hits",
  metric = "Loreau",
  replicate.var = "Unique_ID"
)
colnames(nondomsynchrony) <- c("Unique_ID", "synchrony") #rename columns
```

### Synchrony over a Moving Window
```{r, echo=FALSE}
## create function
synchronymw_func <- function(input_data, timestep, ...) { ## function inputs = data frame and the time step (window size)
  
  n_samples <- length(unique(input_data$Date_final)) ## number of sampling points
  n_windows <- n_samples - timestep + 1 ## how many windows to iterate over 
  mw_synchrony <- data.frame(matrix(ncol=3,nrow=(n_windows*length(unique(input_data$Unique_ID))))) ## create empty data frame to contain output ## dimensions = # cols (3) x (uniqueID x timesteps)
  colnames(mw_synchrony) <- c("Unique_ID", "loreau_synchrony", "timestep")
  
  sample_points <- sort(unique(input_data$Date_numeric)) ## create ordered list of sample points
  
  n_plots <- length(unique(input_data$Unique_ID)) ## number of unique plots
  
  for (k in 1:n_windows){
    
    temp_samplepts <- sample_points[k:(k+timestep-1)] ## create a vector of sample points for each iteration
    
    temp <- input_data %>%
      filter(Date_numeric %in% temp_samplepts) ## filter the correct sample points from input data to run through the community stability function
    
    ## Calculate Loreau synchrony metric
    temp_lsyn <- synchrony(
      temp,
      time.var = "Date_numeric",
      species.var = "SPECIES",
      abundance.var = "Pin_Hits",
      metric = "Loreau",
      replicate.var = "Unique_ID"
      )
    
    colnames(temp_lsyn) <- c("Unique_ID", "loreau_synchrony") #rename columns
    temp_lsyn$timestep <- k ## create a column for timestep in the temporary data frame
    
    mw_synchrony[((k-1)*n_plots + 1):(k*n_plots),] <- temp_lsyn ## add synchrony calculations for one iteration to the moving window data frame
    ## ((i-1)*n_plots + 1):(i*n_plots) -> where to put each iteration of the loop
    
  }
  return(mw_synchrony) ## retrieve data frame at the end
}

## Calculate synchrony over a moving window
synchrony5 <- synchronymw_func(input_data= klee_annual, timestep = 5)  %>%
  mutate(window_size = 5)
synchrony7 <- synchronymw_func(input_data = klee_annual, timestep = 7)  %>%
  mutate(window_size = 7)
synchrony10 <- synchronymw_func(input_data = klee_annual, timestep = 10)  %>%
  mutate(window_size = 10)

## Calculate for big5 species
big5synchrony5 <- synchronymw_func(input_data= big5annual, timestep = 5)  %>%
  mutate(window_size = 5)
big5synchrony7 <- synchronymw_func(input_data = big5annual, timestep = 7)  %>%
  mutate(window_size = 7)
big5synchrony10 <- synchronymw_func(input_data = big5annual, timestep = 10)  %>%
  mutate(window_size = 10)

## Calculate for nondominant species
nondomsynchrony5 <- synchronymw_func(input_data= nondom, timestep = 5)  %>%
  mutate(window_size = 5)
nondomsynchrony7 <- synchronymw_func(input_data = nondom, timestep = 7)  %>%
  mutate(window_size = 7)
nondomsynchrony10 <- synchronymw_func(input_data = nondom, timestep = 10)  %>%
  mutate(window_size = 10)

## join the dataframes
syn57 <- rbind(synchrony5, synchrony7)
synchrony_mw <- rbind(syn57, synchrony10)

syn_mw_tx <- left_join(synchrony_mw, treats, by="Unique_ID") %>%
  group_by(TREATMENT, timestep, window_size) %>%
  summarize(meanloreau = mean(loreau_synchrony), SEloreau = calcSE(loreau_synchrony))

## join big5 dataframes
big5syn57 <- rbind(big5synchrony5, big5synchrony7)
big5synchrony_mw <- rbind(big5syn57, big5synchrony10)

big5syn_mw_tx <- left_join(big5synchrony_mw, treats, by="Unique_ID") %>%
  group_by(TREATMENT, timestep, window_size) %>%
  summarize(meanloreau = mean(loreau_synchrony), SEloreau = calcSE(loreau_synchrony))

## join non-dominant dataframes
nondomsyn57 <- rbind(nondomsynchrony5, nondomsynchrony7)
nondomsynchrony_mw <- rbind(nondomsyn57, nondomsynchrony10)

nondomsyn_mw_tx <- left_join(nondomsynchrony_mw, treats, by="Unique_ID") %>%
  group_by(TREATMENT, timestep, window_size) %>%
  summarize(meanloreau = mean(loreau_synchrony), SEloreau = calcSE(loreau_synchrony))


syn_mw_tx$TREATMENT <- as.factor(syn_mw_tx$TREATMENT) #change treatment to factor
syn_mw_tx$TREATMENT <- factor(syn_mw_tx$TREATMENT, levels = c("O", "W", "MW", "C", "WC", "MWC"))

big5syn_mw_tx$TREATMENT <- as.factor(big5syn_mw_tx$TREATMENT) #change treatment to factor
big5syn_mw_tx$TREATMENT <- factor(big5syn_mw_tx$TREATMENT, levels = c("O", "W", "MW", "C", "WC", "MWC"))

nondomsyn_mw_tx$TREATMENT <- as.factor(nondomsyn_mw_tx$TREATMENT) #change treatment to factor
nondomsyn_mw_tx$TREATMENT <- factor(nondomsyn_mw_tx$TREATMENT, levels = c("O", "W", "MW", "C", "WC", "MWC"))

rm(list = c("syn57", "synchrony5", "synchrony7", "synchrony10", "big5syn57", "nondomsyn57", "big5synchrony5", "big5synchrony7", "big5synchrony10", "nondomsynchrony5", "nondomsynchrony7", "nondomsynchrony10"))
```


## Dominance
### Calculate Berger-Parker Dominance
```{r, echo=FALSE}
## calculate Berger-Parker Dominance for each unique ID at each date
BP_dominance <- klee_annual %>%
  group_by(TREATMENT, Unique_ID, Date_final) %>% #group by treatment, plot, and date
  mutate(rank = rank(Pin_Hits, na.last = NA, ties.method = "average")) %>% #rank species in order of abundance
  mutate(tot_abund = sum(Pin_Hits)) %>% #create column for total abundance in each plot
  filter(rank == max(rank)) %>% #only include most abundant species in each plot
  summarise(BP_dominance = Pin_Hits/tot_abund) #calculate Berger-Parker dominance index
  ## this data frame should be suitable for the ANOVA?

## Calculate the mean Berger-Parker dominance by: 
  ## TREATMENT and DATE - to graph mean dominance over time
meanann_BPdom <- BP_dominance %>%
  group_by(TREATMENT, Date_final) %>%
  summarize(mean_dom = mean(BP_dominance), SEdom = calcSE(BP_dominance), vardom = var(BP_dominance))

  ## TREATMENT and UNIQUE ID - to use eventually for models
meanplot_BPdom <- BP_dominance %>%
  group_by(TREATMENT, Unique_ID) %>%
  summarize(mean_dom = mean(BP_dominance), SEdom = calcSE(BP_dominance), vardom = var(BP_dominance))
```
  
### Calculate Dominance over a Moving Window
```{r, echo=FALSE}
dominancemw_func <- function(input_data, timestep, ...) { ## function inputs = data frame and number of time steps
  
  n_samples <- length(unique(input_data$Date_final)) ## number of sampling points
  n_windows <- n_samples - timestep + 1 ## how many windows to iterate over 
  
  movingwindow <- data.frame(TREATMENT = NA, timestep = NA, mean_dominance = NA, SE_dominance = NA)
  
  colnames(movingwindow) <- c("TREATMENT", "timestep", "mean_dominance", "SE_dominance")
  sample_points <- sort(unique(input_data$Date_numeric)) ## create ordered list of sample points
  
  n_plots <- length(unique(input_data$Unique_ID)) ## number of unique plots
  n_trt <- length(unique(input_data$TREATMENT))
  treatments <- unique(input_data$TREATMENT)
  
  for (i in 1:n_windows){
    
    temp_samplepts <- sample_points[i:(i+timestep-1)] ## create a vector of sample points for each iteration
    
    temp <- input_data %>%
      filter(Date_numeric %in% temp_samplepts) ## filter the correct sample points from input data to run through the community stability function
    
    temp_dom <- temp %>%
      group_by(TREATMENT, Unique_ID, Date_final) %>%
      mutate(rank = rank(Pin_Hits, na.last = NA, ties.method = "average")) %>% #rank species in order of abundance
      mutate(tot_abund = sum(Pin_Hits)) %>% #calculate total abundance
      filter(rank == max(rank)) %>% #only include most abundant species in each plot
      summarise(BP_dominance = Pin_Hits/tot_abund) #calculate Berger-Parker dominance index
      
    temp_dom$timestep <- i ## create a column for timestep in the temporary data frame
    
    mean_dom <- temp_dom %>%
      group_by(TREATMENT, timestep) %>%
      summarise(mean_dominance = mean(BP_dominance), SE_dominance = calcSE(BP_dominance))
    
    
    movingwindow <- rbind(movingwindow, mean_dom)
    
  }
  
  return(movingwindow) ## retrieve data frame at the end
  
}

## Run dominance over a moving window function
dom5 <- dominancemw_func(input_data = klee_annual, timestep = 5) %>%
  mutate(window_size = 5)
dom5 <- dom5[-1,]
dom7 <- dominancemw_func(input_data = klee_annual, timestep = 7) %>%
  mutate(window_size = 7)
dom7 <- dom7[-1,]
dom10 <- dominancemw_func(input_data = klee_annual, timestep = 10) %>%
  mutate(window_size = 10)
dom10 <- dom10[-1,]

## combine separate dataframes
dom57 <- rbind(dom5, dom7)
dominance_mw <- rbind(dom57, dom10)

dominance_mw$TREATMENT <- as.factor(dominance_mw$TREATMENT) #change treatment to factor
dominance_mw$TREATMENT <- factor(dominance_mw$TREATMENT, levels = c("O", "W", "MW", "C", "WC", "MWC"))

rm(list = c("dom57", "dom5", "dom7", "dom10"))
```


## Richness
### Calculate Species Richness
```{r, echo=FALSE}
## ALL SPECIES 
## Calculate species richness for each plot at each point in time
rich <- klee_annual %>%
  group_by(TREATMENT, Unique_ID, Date_final) %>% ## group by each plot at each date
  summarise(richness = n())
  ## use this dataframe for the ANOVA?

## Calculate the mean richness by: 
  ## TREATMENT and DATE
meanannrich <- rich %>%
  group_by(TREATMENT, Date_final) %>%
  summarise(meanrich = mean(richness), SErich = calcSE(richness))
  ## TREATMENT and UNIQUE_ID
meanrichplot <- rich %>%
  group_by(TREATMENT, Unique_ID) %>%
  summarise(meanrich = mean(richness, SErich = calcSE(richness)), varrich = var(richness))


## BIG 5 SPECIES 
## Calculate species richness for each plot at each point in time
big5rich <- big5annual %>%
  group_by(TREATMENT, Unique_ID, Date_final) %>% ## group by each plot at each date
  summarise(richness = n())

## Calculate the mean richness by: 
  ## TREATMENT and DATE
big5meanannrich <- big5rich %>%
  group_by(TREATMENT, Date_final) %>%
  summarise(meanrich = mean(richness), SErich = calcSE(richness))
  ## TREATMENT and UNIQUE_ID
big5meanrichplot <- big5rich %>%
  group_by(TREATMENT, Unique_ID) %>%
  summarise(meanrich = mean(richness, SErich = calcSE(richness)), varrich = var(richness))


## NON-DOMINANT SPECIES
## Calculate species richness for each plot at each point in time
nondomrich <- nondom %>%
  group_by(TREATMENT, Unique_ID, Date_final) %>% ## group by each plot at each date
  summarise(richness = n())

## Calculate the mean richness by: 
  ## TREATMENT and DATE
nondommeanannrich <- nondomrich %>%
  group_by(TREATMENT, Date_final) %>%
  summarise(meanrich = mean(richness), SErich = calcSE(richness))
  ## TREATMENT and UNIQUE_ID
nondommeanrichplot <- nondomrich %>%
  group_by(TREATMENT, Unique_ID) %>%
  summarise(meanrich = mean(richness, SErich = calcSE(richness)), varrich = var(richness))

rm(list = c("rich", "big5rich", "nondomrich"))
```


## Create one dataframe with all biotic mechanisms + stability 
```{r, echo = FALSE}
## Create data frame with one value of stability & mechanisms for each plot
synchrony_stability <- left_join(synchrony, stability, by = "Unique_ID")
tss <- left_join(synchrony_stability, meanplot_BPdom, by = c("Unique_ID", "TREATMENT")) 
stability_mechanisms <- left_join(tss, meanrichplot, by = c("Unique_ID", "TREATMENT"))

big5synchrony_stability <- left_join(big5synchrony, stability, by = "Unique_ID")
b5tss <- left_join(big5synchrony_stability, meanplot_BPdom, by = c("Unique_ID", "TREATMENT")) 
big5stability_mechanisms <- left_join(b5tss, big5meanrichplot, by = c("Unique_ID", "TREATMENT"))

nondomsynchrony_stability <- left_join(nondomsynchrony, stability, by = "Unique_ID")
ndtss <- left_join(nondomsynchrony_stability, meanplot_BPdom, by = c("Unique_ID", "TREATMENT")) 
nondomstability_mechanisms <- left_join(ndtss, nondommeanrichplot, by = c("Unique_ID", "TREATMENT"))

## Create data frame with one value of stability & mechanisms for each treatment
meanstab_mech <- stability_mechanisms %>%
  group_by(TREATMENT) %>%
  summarise(mean_st = mean(stability), SE_st = calcSE(stability), mean_syn = mean(synchrony), SE_syn = calcSE(synchrony), 
            mean_dom = mean(mean_dom), SE_dom = calcSE(mean_dom), mean_rich = mean(meanrich), SE_rich = calcSE(meanrich), 
            mean_var = mean(variance), SE_var = calcSE(variance), mean_bio = mean(pinhits), SE_bio = calcSE(pinhits), 
            mean_vardom = mean(vardom), SE_vardom = calcSE(vardom), mean_varrich = mean(varrich), SE_varrich = calcSE(varrich),
            mean_CV = mean(CV), SE_CV = calcSE(CV))

## Create Big 5 data frame with one value of stability & mechanisms for each treatment
big5meanstab_mech <- big5stability_mechanisms %>%
  group_by(TREATMENT) %>%
  summarise(mean_st = mean(stability), SE_st = calcSE(stability), mean_syn = mean(synchrony), SE_syn = calcSE(synchrony), 
            mean_dom = mean(mean_dom), SE_dom = calcSE(mean_dom), mean_rich = mean(meanrich), SE_rich = calcSE(meanrich), 
            mean_var = mean(variance), SE_var = calcSE(variance), mean_bio = mean(pinhits), SE_bio = calcSE(pinhits), 
            mean_vardom = mean(vardom), SE_vardom = calcSE(vardom), mean_varrich = mean(varrich), SE_varrich = calcSE(varrich),
            mean_CV = mean(CV), SE_CV = calcSE(CV))

nondommeanstab_mech <- nondomstability_mechanisms %>%
  group_by(TREATMENT) %>%
  summarise(mean_st = mean(stability), SE_st = calcSE(stability), mean_syn = mean(synchrony), SE_syn = calcSE(synchrony), 
            mean_dom = mean(mean_dom), SE_dom = calcSE(mean_dom), mean_rich = mean(meanrich), SE_rich = calcSE(meanrich), 
            mean_var = mean(variance), SE_var = calcSE(variance), mean_bio = mean(pinhits), SE_bio = calcSE(pinhits), 
            mean_vardom = mean(vardom), SE_vardom = calcSE(vardom), mean_varrich = mean(varrich), SE_varrich = calcSE(varrich),
            mean_CV = mean(CV), SE_CV = calcSE(CV))

rm(list = c("synchrony_stability", "big5synchrony_stability", "nondomsynchrony_stability", "tss", "b5tss", "ndtss"))
```


# Significance Testing
## ANOVAs
```{r}
## STABILITY AND GRAZING TREATMENT ----
## is stability significantly different by grazing treatment?
fitstability <- aov(stability~TREATMENT, data = stability)
summary(fitstability)

TukeyHSD(fitstability)
#significant differences: 
  ## MW-O (marginal)
  ## C-O
  ## MWC-O
  ## WC-O
  ## C-W (marginal)
  ## MWC-W
  ## WC-W

## is variance significantly different by grazing treatment?
fitvariance <- aov(variance~TREATMENT, data=variance)
summary(fitvariance)

TukeyHSD(fitvariance)
#significant differences
  ## C-O (marginal)
  ## MWC-O
  ## WC-O
  ## MWC-W (marginal)
  ## WC-W

## is total cover different by grazing treatment?
fitpinhits <- aov(pinhits~TREATMENT, data=variance)
summary(fitpinhits)
TukeyHSD(fitpinhits)
#significant differences
  ## MW-O (marginal)
  ## C-O
  ## MWC-O
  ## WC-O
  ## C-W
  ## MWC-W
  ## WC-W
  ## MWC-MW
  ## WC-MW


## DOMINANCE and GRAZING TREATMENT ----
  ## is berger-parker dominance significantly different by grazing treatment?
meanplot_BPdom <- meanplot_BPdom %>%
  mutate(TREATMENT = fct_relevel(TREATMENT, "O", "W", "MW", "C", "WC", "MWC"))
fitdom <- aov(mean_dom~TREATMENT, data=meanplot_BPdom)
summary(fitdom)
TukeyHSD(fitdom)
## significant differences
  ## MWC-O
  ## MWC-W (marginal)


## RICHNESS AND GRAZING TREATMENT ----
  ## is richness significantly different by grazing treatment?
fitrich <- aov(meanrich~TREATMENT, data = meanrichplot)
summary(fitrich)
## treatment not a significant effect

fitbig5rich <- aov(meanrich~TREATMENT, data = big5meanrichplot)
summary(fitbig5rich)
## treatment not a significant effect

fitnondomrich <- aov(meanrich~TREATMENT, data = nondommeanrichplot)
summary(fitnondomrich)
## treatment not a significant effect


## SYNCHRONY AND GRAZING TREATMENT ----
  ## is synchrony significantly different by grazing treatment?
fitsyn <- aov(loreau_synchrony~TREATMENT, data = synchrony_stability)
summary(fitsyn)
TukeyHSD(fitsyn)
## significant differences
  ## MWC-O
  ## WC-O
  ## MWC-W
  ## WC-W

fitbig5syn <- aov(loreau_synchrony~TREATMENT, data = big5synchrony_stability)
summary(fitbig5syn)
TukeyHSD(fitbig5syn)

fitnondomsyn <- aov(loreau_synchrony~TREATMENT, data = nondomsynchrony_stability)
summary(fitnondomsyn)
#not significant
```

## Linear Models
```{r}
## SYNCHRONY AND STABILITY ----
## Does synchrony predict stability?
fitstablsyn <- lm(stability~loreau_synchrony, data = synchrony_stability)
summary(fitstablsyn)
## significant

fitbig5synstab <- lm(stability~loreau_synchrony, data=big5synchrony_stability)
summary(fitbig5synstab)
## significant 

fitnondomsynstab <- lm(stability~loreau_synchrony, data = nondomsynchrony_stability)
summary(fitnondomsynstab)
## significant


## DOMINANCE AND STABILITY ----
## Does dominance predict stability
fitstabdom <- lm(stability~mean_dom+vardom, data = dominance_stability)
summary(fitstabdom)
## significant main effect of mean dominance, no significant effect of the variance of dominance or any interactions

## Does variation in species dominance predict stability?
fitstabvardom <- lm(stability~vardom, data = dominance_stability)
summary(fitstabvardom)
## this gives a marginally significant effect, but I'm not sure if it's incorrect to do two separate models like this?


## RICHNESS AND STABILITY ----
## Does richness predict stability
fitstabrich <- lm(stability~meanrich, data = richness_stability)
summary(fitstabrich)
## not significant

fitbig5stabrich <- lm(stability~meanrich, data = big5richness_stability)
summary(fitbig5stabrich)
## not significant

fitnondomstabrich <- lm(stability~meanrich, data = nondomrichness_stability)
summary(fitnondomstabrich)
## not significant
```

## Mixed Effects Models
```{r}
## Try Treatment vs. Stability & Mechanisms models using lme4 package
  ## BLOCK as a random effect
fitgrst <- lmer(stability~TREATMENT + (1|BLOCK), data = stability_mechanisms)
summary(fitgrst)

fitgrsy <- lmer(synchrony~TREATMENT + (1|BLOCK), data = stability_mechanisms)
summary(fitgrsy)

fitgrdo <- lmer(mean_dom~TREATMENT + (1|BLOCK), data = stability_mechanisms)
summary(fitgrdo)

fitgrri <- lmer(mean_rich~TREATMENT + (1|BLOCK), data = stability_mechanisms)
summary(fitgrri)


## Try Stability vs. Mechanism model variations
## non-linear mixed effects model in nlme
nlme(stability~SSasymp(mean_dom, meanrich, synchrony, vardom, varrich), 
     data = stability_mechanisms,
     random = ~1|BLOCK, 
     groups = TREATMENT
     )

## linear mixed effects model in nlme
lme(stability~mean_dom+meanrich+synchrony+TREATMENT, random = ~1|BLOCK, data = stability_mechanisms)

## linear mixed effects model in lme4
lmer(stability~mean_dom+meanrich+synchrony+TREATMENT +(1|BLOCK), data = stability_mechanisms)

```


## Correlation Analysis for Moving Windows
```{r, echo=FALSE}
## Stability Dominance Correlation test ---- 
##create data frame for correlation test
stab_dom_mw <- left_join(stab_mw_tx, dominance_mw, by = c("TREATMENT", "timestep", "window_size"))

## create vector of treatments
trt <- unique(stab_dom_mw$TREATMENT)

## create vector of window size
wsize <- unique(stab_dom_mw$window_size)

corr_dom <- data.frame(TREATMENT = NA, window_size = NA, corr_coefficient = NA, p_val = NA) ## create empty dataframe to contain output


for (i in 1:length(trt)) {
  
  ## select the ith treatment
  tx <- trt[i]
  
  ## filter by treatment
  temptx <- stab_dom_mw %>%
    filter(TREATMENT %in% tx)
  
  for (j in 1:length(wsize)){
    
    ## select window size
    wind <- wsize[j]
    
    ## filter by window size
    tempw <- temptx %>%
      filter(window_size %in% wind)
    
    ## feed through cor.test function
    cortst <- cor.test(tempw$mean_dominance, tempw$mean_stability, 
             alternative = "two.sided", 
             method = "pearson")
    
    t <- tempw %>%
      group_by(TREATMENT) %>%
      summarise(window_size = mean(window_size)) %>%
      mutate(corr_coefficient = cortst$estimate, p_val = cortst$p.value)
     
    corr_dom <- rbind(corr_dom, t)
    
  }
  
}
corr_dom <- corr_dom[-1,]

## create a variable indicating significance of p-value
corr_dom <- corr_dom %>%
  mutate(significant = ifelse(p_val < 0.051, "S", 
                              ifelse(p_val > 0.05 & p_val < 0.07, "M", "NS")))

print(corr_dom)


## Does Synchrony correlate with Stability changes over time? ----
stab_syn_mw <- left_join(stab_mw_tx, syn_mw_tx, by = c("TREATMENT", "timestep", "window_size"))

## create vector of treatments
trt <- unique(stab_syn_mw$TREATMENT)

## create vector of window size
wsize <- unique(stab_syn_mw$window_size)

corr_syn <- data.frame(TREATMENT = NA, window_size = NA, corr_coefficientl = NA, lp_val = NA) ## create empty dataframe to contain output


for (i in 1:length(trt)) {
  
  ## select the treatment
  tx <- trt[i]
  
  ## filter by treatment
  temptx <- stab_syn_mw %>%
    filter(TREATMENT %in% tx)
  
  for (j in 1:length(wsize)){
    
    ## select window size
    wind <- wsize[j]
    
    ## filter by window size
    tempw <- temptx %>%
      filter(window_size %in% wind)
    
    ## feed through cor.test function
    cortstl <- cor.test(tempw$meanloreau, tempw$mean_stability, 
             alternative = "two.sided", 
             method = "pearson")
    
     #cortstg <- cor.test(tempw$meangross, tempw$mean_stability, 
         #    alternative = "two.sided", 
          #   method = "pearson")
    
     t <- tempw %>%
       group_by(TREATMENT) %>% 
       summarise(window_size = mean(window_size)) %>%
       mutate(corr_coefficientl = cortstl$estimate, lp_val = cortstl$p.value) #%>%
      # mutate(corr_coefficientg = cortstg$estimate, gp_val = cortstg$p.value)
     
    corr_syn <- rbind(corr_syn, t)
  }
  
}

corr_syn <- corr_syn[-1,]

## create a variable indicating significance of p-value
corr_syn <- corr_syn %>%
  mutate(significant = ifelse(lp_val < 0.051, "S", 
                              ifelse(lp_val > 0.05 & lp_val < 0.07, "M", "NS")))

print(corr_syn)


## Big 5 Synchrony Stability Correlation Test ----
big5stab_syn_mw <- left_join(stab_mw_tx, big5syn_mw_tx, by = c("TREATMENT", "timestep", "window_size"))

## create vector of treatments
trt <- unique(big5stab_syn_mw$TREATMENT)

## create vector of window size
wsize <- unique(big5stab_syn_mw$window_size)

b5corr_syn <- data.frame(TREATMENT = NA, window_size = NA, corr_coefficientl = NA, lp_val = NA) ## create empty dataframe to contain output


for (i in 1:length(trt)) {
  
  ## select the treatment
  tx <- trt[i]
  
  ## filter by treatment
  temptx <- big5stab_syn_mw %>%
    filter(TREATMENT %in% tx)
  
  for (j in 1:length(wsize)){
    
    ## select window size
    wind <- wsize[j]
    
    ## filter by window size
    tempw <- temptx %>%
      filter(window_size %in% wind)
    
    ## feed through cor.test function
    cortstl <- cor.test(tempw$meanloreau, tempw$mean_stability, 
             alternative = "two.sided", 
             method = "pearson")
    
     t <- tempw %>%
       group_by(TREATMENT) %>% 
       summarise(window_size = mean(window_size)) %>%
       mutate(corr_coefficientl = cortstl$estimate, lp_val = cortstl$p.value) #%>%
      # mutate(corr_coefficientg = cortstg$estimate, gp_val = cortstg$p.value)

    b5corr_syn <- rbind(b5corr_syn, t)
  }
  
}

b5corr_syn <- b5corr_syn[-1,]

## create a variable indicating significance of p-value
b5corr_syn <- b5corr_syn %>%
  mutate(significant = ifelse(lp_val < 0.051, "S", 
                              ifelse(lp_val > 0.05 & lp_val < 0.07, "M", "NS")))
print(b5corr_syn)


## Non Dominant Synchrony Stability Correlation Test ----
nondomstab_syn_mw <- left_join(stab_mw_tx, nondomsyn_mw_tx, by = c("TREATMENT", "timestep", "window_size"))

## create vector of treatments
trt <- unique(nondomstab_syn_mw$TREATMENT)

## create vector of window size
wsize <- unique(nondomstab_syn_mw$window_size)

ndcorr_syn <- data.frame(TREATMENT = NA, window_size = NA, corr_coefficientl = NA, lp_val = NA) ## create empty dataframe to contain output


for (i in 1:length(trt)) {
  
  ## select the treatment
  tx <- trt[i]
  
  ## filter by treatment
  temptx <- nondomstab_syn_mw %>%
    filter(TREATMENT %in% tx)
  
  for (j in 1:length(wsize)){
    
    ## select window size
    wind <- wsize[j]
    
    ## filter by window size
    tempw <- temptx %>%
      filter(window_size %in% wind)
    
    ## feed through cor.test function
    cortstl <- cor.test(tempw$meanloreau, tempw$mean_stability, 
             alternative = "two.sided", 
             method = "pearson")
    
     t <- tempw %>%
       group_by(TREATMENT) %>% 
       summarise(window_size = mean(window_size)) %>%
       mutate(corr_coefficientl = cortstl$estimate, lp_val = cortstl$p.value)# %>%
     #  mutate(corr_coefficientg = cortstg$estimate, gp_val = cortstg$p.value)

    ndcorr_syn <- rbind(ndcorr_syn, t)
  }
}

ndcorr_syn <- ndcorr_syn[-1,]

## create a variable indicating significance of p-value
ndcorr_syn <- ndcorr_syn %>%
  mutate(significant = ifelse(lp_val < 0.051, "S", 
                              ifelse(lp_val > 0.05 & lp_val < 0.07, "M", "NS")))

print(ndcorr_syn)

corr_syn$TREATMENT <- as.factor(corr_syn$TREATMENT) #change treatment to factor
corr_syn$TREATMENT <- factor(corr_syn$TREATMENT, levels = c("O", "W", "MW", "C", "WC", "MWC"))

## Make one correlation data frame
corr_syn <- corr_syn %>%
  mutate(type = "all species")
b5corr_syn <- b5corr_syn %>%
  mutate(type = "big 5")
ndcorr_syn <- ndcorr_syn %>%
  mutate(type="non-dominant")

syncorr <- rbind(corr_syn, b5corr_syn)
syncorr_all <- rbind(syncorr, ndcorr_syn) 

## Synchrony and Dominance Correlation Test ----
syn_dom_mw <- left_join(syn_mw_tx, dominance_mw, by = c("TREATMENT", "timestep", "window_size"))

## create vector of treatments
trt <- unique(syn_dom_mw$TREATMENT)

## create vector of window size
wsize <- unique(syn_dom_mw$window_size)

corr_syndom <- data.frame(TREATMENT = NA, window_size = NA, corr_coefficient = NA, p_val = NA) ## create empty dataframe to contain output


for (i in 1:length(trt)) {
  
  ## select the ith treatment
  tx <- trt[i]
  
  ## filter by treatment
  temptx <- syn_dom_mw %>%
    filter(TREATMENT %in% tx)
  
  for (j in 1:length(wsize)){
    
    ## select window size
    wind <- wsize[j]
    
    ## filter by window size
    tempw <- temptx %>%
      filter(window_size %in% wind)
    
    ## feed through cor.test function
    cortst <- cor.test(tempw$mean_dominance, tempw$meanloreau, 
             alternative = "two.sided", 
             method = "pearson")
    
    t <- tempw %>%
      group_by(TREATMENT) %>%
      summarise(window_size = mean(window_size)) %>%
      mutate(corr_coefficient = cortst$estimate, p_val = cortst$p.value)
     
    corr_syndom <- rbind(corr_syndom, t)
    
  }
  
}
corr_syndom <- corr_syndom[-1,]

## create a variable indicating significance of p-value
corr_syndom <- corr_syndom %>%
  mutate(significant = ifelse(p_val < 0.051, "S", 
                              ifelse(p_val > 0.05 & p_val < 0.07, "M", "NS")))

print(corr_syndom)

```

# Figure Settings
```{r, echo=FALSE, include=FALSE}
green_scale <- c("#97e196", "#6cc08b", "#4c9b82", "#217a79", "#105965", "#074050") #make a vector of colors
colors <- c("#88CCEE", "#CC6677","#DDCC77","#117733","#332288","#AA4499","#44AA99","#999933","#882255","#661100","#6699CC","#888888")
theme_set(theme_classic()) #set the theme
```

# Main Text Figures

## Figure 1: Stability, Mean Pin Hits, and Variance
```{r, fig.width =12, fig.height=4, echo=FALSE}
#graph the mean variance by treatment
v <- ggplot(meanstab_mech, aes(x=TREATMENT, y=mean_var)) +
  geom_point(size=3) +
  geom_errorbar(aes(ymin = mean_var-SE_var, ymax = mean_var+SE_var), width=0.25) +
  ylab("Temporal Variance") + xlab("Treatment") +
  #annotate("text", x =1, y=23500, label = "a", size = 5) +
 # annotate("text", x =2, y=19800, label = "ab", size = 5) +
 # annotate("text", x =3, y=17500, label = "ab", size = 5) +
#  annotate("text", x =4, y=16000, label = "bc", size = 5) +
 # annotate("text", x =5, y=12500, label = "c", size = 5) +
#  annotate("text", x =6, y=11800, label = "c", size = 5) +
  theme(text = element_text(size = 16)) #change font size


#graph the mean total pin hits by treatment
b <- ggplot(meanstab_mech, aes(x=TREATMENT, y=mean_bio)) +
  geom_point(size=3) +
  geom_errorbar(aes(ymin=mean_bio-SE_bio, ymax=mean_bio+SE_bio), width = 0.2) + #include standard error bars
  ylab("Total Pin Hits") + xlab("Treatment") +
  #annotate("text", x =1, y=1420, label = "a", size = 5) +
#  annotate("text", x =2, y=1367, label = "ab", size = 5) +
#  annotate("text", x =3, y=1310, label = "bc", size = 5) +
#  annotate("text", x =4, y=1210, label = "cd", size = 5) +
#  annotate("text", x =5, y=1175, label = "d", size = 5) +
#  annotate("text", x =6, y=1110, label = "d", size = 5) +
  theme(text = element_text(size = 16)) #change font size


## visualize mean stability & standard error
s <- ggplot(meanstab_mech, aes(x=TREATMENT, y=mean_st)) +
  geom_point(size=3) +
  geom_errorbar(aes(ymin = mean_st-SE_st, ymax=mean_st+SE_st), width = 0.2) + #add standard error bars
  ylab("Stability (mean/sd)") + xlab("Treatment") + #label axes
#  annotate("text", x =1, y=4.75, label = "a", size = 5) +
#  annotate("text", x =2, y=4.5, label = "ab", size = 5) +
#  annotate("text", x =3, y=3.9, label = "bc", size = 5) +
#  annotate("text", x =4, y=3.95, label = "c", size = 5) +
#  annotate("text", x =5, y=3.3, label = "c", size = 5) +
 # annotate("text", x =6, y=3.2, label = "c", size = 5) +
  theme(text = element_text(size = 16)) #change font size

## plot 3 panel figure of stability, total pin hits, and temporal variance
ggarrange(s, b, v, 
          labels = "AUTO",
          ncol = 3, nrow = 1, 
          align = "hv")
```

## Figure 2: Mechanisms
```{r, echo = FALSE, fig.height=8, fig.width=8}

syngraz <- ggplot(meanstab_mech, aes(x=TREATMENT , y=mean_syn)) +
  geom_point(size=3) +
  geom_errorbar(aes(ymin = mean_syn-SE_syn, ymax=mean_syn+SE_syn), width = 0.3) +
  ylab("Synchrony (All)") + xlab("Treatment") +  
  theme(legend.title = element_text(size=12)) +  theme(text = element_text(size = 14)) + #change font sizes
  annotate("text", x =1, y=0.17, label = "a") +
  annotate("text", x =2, y=0.154, label = "a") +
  annotate("text", x =3, y=0.208, label = "ab") +
  annotate("text", x =4, y=0.21, label = "ab") +
  annotate("text", x =5, y=0.271, label = "b") +
  annotate("text", x =6, y=0.27, label = "b") +
  coord_cartesian(ylim = c(0.1, 0.4))

synstab <- ggplot(meanstab_mech, aes(x=mean_syn , y=mean_st, col = TREATMENT)) +
  geom_abline(slope = -10.943, intercept = 5.6823) + #double checked
  geom_point(size=3) +
  scale_color_manual(values = green_scale) +
  geom_errorbar(aes(ymin=mean_st-SE_st, ymax=mean_st+SE_st), width = 0.005) + #add standard error bars
  geom_errorbarh(aes(xmin = mean_syn-SE_syn, xmax=mean_syn+SE_syn), height = 0.1) + #add standard error bars
  ylab("Stability") + xlab("Synchrony (All)") +  #label axes
  theme(legend.title = element_text(size=12)) + theme(text = element_text(size = 14)) + #change font sizes
  labs(col = "Treatment") +
    coord_cartesian(xlim = c(0.1, 0.4))


big5syngraz <- ggplot(big5meanstab_mech, aes(x=TREATMENT , y=mean_syn)) +
  geom_point(size=3) +
  geom_errorbar(aes(ymin = mean_syn-SE_syn, ymax=mean_syn+SE_syn), width = 0.3) +
  ylab("Synchrony (Big 5)") + 
  xlab("Treatment") +  
  theme(legend.title = element_text(size=12)) +  theme(text = element_text(size = 14)) + #change font sizes
  #scale_shape_discrete(labels = c("Gross", "Loreau")) +
  annotate("text", x =1, y=0.3, label = "a") +
  annotate("text", x =2, y=0.28, label = "a") +
  annotate("text", x =3, y=0.33, label = "a") +
  annotate("text", x =4, y=0.31, label = "a") +
  annotate("text", x =5, y=0.31, label = "b") +
  annotate("text", x =6, y=0.31, label = "b") +
  coord_cartesian(ylim = c(0.1, 0.4))


big5synstab <- ggplot(big5meanstab_mech, aes(x=mean_syn , y=mean_st, col = TREATMENT)) +
  geom_point(size=3) +
  scale_color_manual(values = green_scale) +
  geom_errorbar(aes(ymin=mean_st-SE_st, ymax=mean_st+SE_st), width = 0.005) + #add standard error bars
  geom_errorbarh(aes(xmin = mean_syn-SE_syn, xmax=mean_syn+SE_syn), height = 0.1) + #add standard error bars
  ylab("Stability") + xlab("Synchrony (Big 5)") +  #label axes
  theme(legend.title = element_text(size=12)) + theme(text = element_text(size = 14)) + #change font sizes
  labs(col = "Treatment", shape = "Synchrony Metric") +
  scale_shape_discrete(labels = c("Gross", "Loreau")) +
  geom_abline(slope = -5.8979, intercept = 5.1794) + #double checked
  coord_cartesian(xlim = c(0.1, 0.4))


domgraz <- ggplot(meanstab_mech, aes(x=TREATMENT, y=mean_dom)) +
  geom_point(size = 3) +
  geom_errorbar(aes(ymin=mean_dom-SE_dom, ymax=mean_dom+SE_dom), width = 0.25) +
  xlab("Treatment") + ylab("Dominance") +  
  theme(legend.title = element_text(size=12)) +  theme(text = element_text(size = 14)) + #change font sizes
  annotate("text", x =1, y=0.43, label = "a") +
  annotate("text", x =2, y=0.425, label = "a") +
  annotate("text", x =3, y=0.405, label = "ab") +
  annotate("text", x =4, y=0.405, label = "ab") +
  annotate("text", x =5, y=0.335, label = "b") +
  annotate("text", x =6, y=0.356, label = "ab") +
  coord_cartesian(ylim = c(0.3,0.45))


domstab <- ggplot(meanstab_mech, aes(x=mean_dom, y=mean_st, col=TREATMENT)) +
  geom_point(size = 3) +
  ylab("Stability") + xlab("Dominance") +
  geom_errorbarh(aes(xmin=mean_dom-SE_dom, xmax=mean_dom+SE_dom)) +
  geom_errorbar(aes(ymin=mean_st-SE_st, ymax=mean_st+SE_st)) +
  scale_color_manual(values = green_scale) +
  theme(legend.title = element_text(size=12)) +
  theme(text = element_text(size = 14)) +
  labs(col = "Treatment") +
  geom_abline(intercept = 0.4003, slope = 8.9449) +
  coord_cartesian(xlim = c(0.3,0.45))


ggarrange(syngraz, synstab,
          big5syngraz, big5synstab, 
          domgraz, domstab, 
          ncol = 2, nrow = 3,
          align = "hv", 
          common.legend = TRUE, 
          labels = "AUTO", 
          legend = "bottom")
```

## Figure 4: Correlations
```{r, fig.height=5, fig.width=10, echo=FALSE}
## Dominance Correlations
mw7stab_dom_mw <- stab_dom_mw %>%
  filter(window_size == "7")

mw7synstabfig <- stab_syn_mw %>%
  filter(window_size == 7)

corrsynstab <- ggplot(mw7synstabfig, aes(x=meanloreau, y=mean_stability, color = timestep)) +
    geom_point() +
    ylab("Stability") + xlab("Synchrony") +
    facet_wrap(~TREATMENT, ncol = 6) +
    theme(legend.title = element_text(size=14)) +  theme(text = element_text(size = 14))

corrdomstab <- ggplot(mw7stab_dom_mw, aes(x=mean_dominance, y=mean_stability, color = timestep)) +
  geom_point() +
  ylab("Stability") + xlab("Dominance") +
  facet_wrap(~TREATMENT, ncol = 6) +
  theme(legend.title = element_text(size=14)) +  theme(text = element_text(size = 14)) +
  coord_cartesian(xlim = c(0.3, 0.45))


ggarrange(corrsynstab, corrdomstab, 
          common.legend = TRUE, 
          ncol = 1, 
          legend = "right", 
          labels = "AUTO")
```

## Figure 5: Correlation Coefficients
```{r, echo = FALSE, fig.width=9, fig.height=6}
syncoeff <- ggplot(syncorr_all, aes(x=TREATMENT, y=corr_coefficientl, color = type, shape = significant)) +
  geom_point(size = 3) +
  geom_hline(yintercept = 0, linetype = "dashed") +
  ylab("Synchrony and Stability") + xlab("") +
  scale_color_manual(values = c("#E58606", "#5D69B1", "#52BCA3")) +
  labs(col = "Type", shape = "Significance") +
  scale_shape_manual(values = c(10,1,16)) +
  facet_wrap(~window_size) +
  theme(legend.title = element_text(size=14)) +  theme(text = element_text(size = 14))


corr_dom$TREATMENT <- as.factor(corr_dom$TREATMENT) #change treatment to factor
corr_dom$TREATMENT <- factor(corr_dom$TREATMENT, levels = c("O", "W", "MW", "C", "WC", "MWC"))

domcoeff <- ggplot(corr_dom, aes(x=TREATMENT, y=corr_coefficient, shape = significant)) +
  geom_point(size = 3) +
  geom_hline(yintercept = 0, linetype = "dashed") +
  ylab("Dominance and Stability") + xlab("Treatment") +
  scale_color_manual(values = c("#ED645A","#CC3A8E","#A5AA99")) +
  labs(shape = "Significance") +
  scale_shape_manual(values = c(1,16)) +
  facet_wrap(~window_size) +
  theme(legend.title = element_text(size=14)) +  theme(text = element_text(size = 14)) +
  theme(legend.position = "none")
#E58606,#5D69B1,#52BCA3,#99C945,#CC61B0,#24796C,#DAA51B,#2F8AC4,#764E9F,#ED645A,#CC3A8E,#A5AA99


ggarrange(syncoeff,
          domcoeff, 
          ncol = 1, nrow = 2, 
          align = "hv", 
          common.legend = TRUE, 
          legend = "right")
```


# Supplementary Figures

## Figure S1: Rank Abundance Curve to support using the 'big 5' species
```{r, echo=FALSE, fig.width=15, fig.height=10}
rankabund <- klee_annual %>%
  group_by(TREATMENT, SPECIES) %>% #group by treatment and species
  summarise(abundance = mean(Pin_Hits)) %>%
  mutate(rank = rank(-abundance, na.last = NA, ties.method = "average")) #%>% 

ggplot(rankabund, aes(x=abundance, y=rank)) +
  geom_line() +
  geom_point(size = 2) +
  facet_wrap(~TREATMENT) +
  scale_y_reverse() +
  scale_x_reverse() +
  xlab("Abundance") + ylab("Rank") +
 # geom_text(aes(label = ifelse(rank<6, as.character(SPECIES), ''),hjust=0, vjust=10))
  geom_text_repel(aes(label=ifelse(rank<6, as.character(SPECIES), ''),hjust=0, vjust=0),
                  point.padding = 1,
                  xlim = c(-450, NA), 
                  ylim = c(-20, NA)) +
  theme(text = element_text(size = 20))


```

## Figure S2: Total Cover Time Series
```{r, echo=FALSE, fig.align='center'}
tcovtime <- totcov %>%
  group_by(TREATMENT, Date_final) %>%
  summarise(totcov = mean(totcov))

#graph the time series of total cover 
ggplot(tcovtime, aes(x=Date_final, y=totcov, col=TREATMENT)) + #separate treatments by color
  geom_line(size = 0.5) +
  scale_color_manual(values = green_scale) + #change color scheme
  ylab("Total Cover (# Pin Hits)") + xlab("Date") + labs(col = "Treatment") + #add labels
  theme(legend.title = element_text(size=12)) + theme(text = element_text(size = 14)) #change font sizes
```

## Figure S3: Dominance over time
```{r, echo=FALSE, fig.align='center', fig.height=4, fig.width=6}
## Graph dominance over time
ggplot(meanann_BPdom, aes(x=Date_final, y=mean_dom, col=TREATMENT)) +
  geom_line(size = 0.5) +
  ylab("Berger-Parker Dominance") + xlab("Date") +
  scale_color_manual(values = green_scale) +
  theme(legend.title = element_text(size=12)) +
  theme(text = element_text(size = 14)) +
  labs(col = "Treatment") #change legend title
```

## Figure S4: Mean-Variance relationships
```{r, echo=FALSE}
ggplot(meanvar, aes(x=log(meanbio), y= log(meanvar))) +
  geom_point(size = 3, aes(color= TREATMENT)) +
  geom_abline() +
  scale_color_manual(values = green_scale) + #change color scheme
  coord_cartesian(xlim = c(6.5,7.5), ylim = c(6.5,10)) +
  ylab("Mean Variance (Log)") + xlab("Mean Biomass (Log)") +
    theme(legend.title = element_text(size=12)) +  theme(text = element_text(size = 14)) #change font sizes
```

## Figure S5: Richness-Stability Figure
```{r, echo=FALSE, fig.height=4, fig.width=8}
## Richness by Grazing Treatment
richgraz <- ggplot(meanstab_mech, aes(x=TREATMENT, y=mean_rich)) +
  geom_point(size=3) +
  geom_errorbar(aes(ymin=mean_rich-SE_rich, ymax=mean_rich+SE_rich), width=0.25) +
  ylab("Species Richness") +xlab("Treatment") +
  theme(legend.title = element_text(size=12)) +  theme(text = element_text(size = 14)) #change font sizes

## Richness and Stability
richstab <- ggplot(meanstab_mech, aes(x=mean_rich, y=mean_st, color=TREATMENT)) +
  geom_point(size=3) +
  geom_errorbarh(aes(xmin=mean_rich-SE_rich, xmax=mean_rich+SE_rich)) +
  geom_errorbar(aes(ymin=mean_st-SE_st, ymax=mean_st+SE_st), width=0.15) +
  scale_color_manual(values = green_scale) +
  ylab("Stability") +xlab("Species Richness") +
  theme(legend.title = element_text(size=12)) +  theme(text = element_text(size = 14)) #+ #change font sizes

## Big 5 Richness and Stability
b5richstab <- ggplot(big5meanstab_mech, aes(x=mean_rich, y=mean_st, color = TREATMENT)) +
  #geom_abline(slope = -2.250, intercept = 14.754) +
  geom_point(size = 3) +
  geom_errorbar(aes(ymin=mean_st-SE_st, ymax=mean_st+SE_st))+
  xlab("Big 5 Species Richness") + ylab("Stability") +
  scale_color_manual(values = green_scale) +
  geom_errorbarh(aes(xmin=mean_rich-SE_rich, xmax=mean_rich+SE_rich)) +
  theme(legend.title = element_text(size=12)) +  theme(text = element_text(size = 14)) #+ #change font sizes

## Plot all together
ggarrange(richgraz, richstab, b5richstab,
          ncol = 3, nrow = 1,
          align = "hv", 
          common.legend = TRUE, 
          labels = "AUTO", 
          legend = "bottom")
```

## Figure S6: Non-Dominant Species Mechanism
```{r, echo=FALSE}
nondomsyngraz <- ggplot(nondommeanstab_mech, aes(x=TREATMENT , y=mean_syn)) +
  geom_point(size=3) +
  geom_errorbar(aes(ymin = mean_syn-SE_syn, ymax=mean_syn+SE_syn), width = 0.3) +
  ylab("Non-Dominant Synchrony") + 
  xlab("Treatment") +  
  theme(legend.title = element_text(size=12)) +  theme(text = element_text(size = 14))# + #change font sizes

nondomsynstab <- ggplot(nondommeanstab_mech, aes(x=mean_syn , y=mean_st, col = TREATMENT)) +
  geom_point(size=3) +
  scale_color_manual(values = green_scale) +
  geom_errorbar(aes(ymin=mean_st-SE_st, ymax=mean_st+SE_st), width = 0.005) + #add standard error bars
  geom_errorbarh(aes(xmin = mean_syn-SE_syn, xmax=mean_syn+SE_syn), height = 0.1) + #add standard error bars
  ylab("Stability") + xlab("Non-Dominant Synchrony") +  #label axes
  theme(legend.title = element_text(size=12)) + theme(text = element_text(size = 14)) + #change font sizes
  labs(col = "Treatment") 

ggarrange(nondomsyngraz, nondomsynstab,
          ncol = 2, nrow = 1,
          align = "hv", 
          common.legend = TRUE, 
          labels = "AUTO", 
          legend = "bottom")
```

## Figure S7: Moving Window Mechanisms
```{r, echo=FALSE, fig.height=9, fig.width=11}

mwstab<-ggplot(stab_mw_tx, aes(x=timestep, y=mean_stability, color = TREATMENT)) +
  geom_line() +
  geom_point() +
  scale_color_manual(values = colors) + #change color scheme
  ylab("Mean Stability (All)") + xlab("Timestep") +
  facet_wrap(~window_size) +
  theme(legend.title = element_text(size=14)) +  theme(text = element_text(size = 14))

mwsyn <- ggplot(syn_mw_tx, aes(x=timestep, y=meanloreau, color = TREATMENT)) +
  geom_line() +
  geom_point() +
  scale_color_manual(values = colors) + #change color scheme
  ylab("Mean Loreau Synchrony (All)") + xlab("Timestep") +
  facet_wrap(~window_size) +
  theme(legend.title = element_text(size=14)) +  theme(text = element_text(size = 14))

mwdom <- ggplot(dominance_mw, aes(x=timestep, y=mean_dominance, color = TREATMENT)) +
  geom_line() +
  geom_point() +
  scale_color_manual(values = colors) + #change color scheme
  ylab("Mean Berger-Parker Dominance") + xlab("Timestep") +
  facet_wrap(~window_size) +
  theme(legend.title = element_text(size=14)) +  theme(text = element_text(size = 14))

ggarrange(mwstab, mwsyn, mwdom,
          ncol = 1, nrow = 3,
          #align = "hv", 
          common.legend = TRUE, 
          #labels = c("A", "B", "C", "D", "E", "F"), 
          legend = "bottom")
```


## Figure S8: Synchrony over a moving window (Big 5 & Non Dom)
```{r, echo=FALSE, fig.width =8, fig.height=4}

ggplot(big5syn_mw_tx, aes(x=timestep, y=meanloreau, color = TREATMENT)) +
  geom_line() +
  geom_point() +
  scale_color_manual(values = colors) + #change color scheme
  ylab("Mean Loreau Synchrony (Big 5)") + xlab("Timestep") +
  facet_wrap(~window_size)


ggplot(nondomsyn_mw_tx, aes(x=timestep, y=meanloreau, color = TREATMENT)) +
  geom_line() +
  geom_point() +
  scale_color_manual(values = colors) + #change color scheme
  ylab("Mean Loreau Synchrony (Non-Dom)") + xlab("Timestep") +
  facet_wrap(~window_size)

```



## Figure S9: Richness over time
```{r, echo=FALSE, fig.cap='**Figure 14:** Mean richness over time.'}
## All species richness over time
ggplot(meanannrich, aes(x=Date_final, y=meanrich, color = TREATMENT)) +
  geom_line(size = 0.5) +
  geom_point() +
  theme_bw() +
  ylab("Richness") + xlab("Date") +
  scale_color_manual(values = green_scale) +
  theme(legend.title = element_text(size=12)) +
  theme(text = element_text(size = 14)) +
  labs(col = "Treatment") #change legend title

## Big 5 species richness over time
ggplot(big5meanannrich, aes(x=Date_final, y=meanrich, color = TREATMENT)) +
  geom_line(size = 0.5) +
  geom_point() +
  ylab("Richness") + xlab("Date") +
  scale_color_manual(values = green_scale) +
  theme(legend.title = element_text(size=12)) +
  theme(text = element_text(size = 14)) +
  labs(col = "Treatment") + #change legend title
  facet_wrap(~TREATMENT)

## Non-dominant species richness over time
ggplot(nondommeanannrich, aes(x=Date_final, y=meanrich, color = TREATMENT)) +
  geom_line(size = 0.5) +
  geom_point() +
  theme_bw() +
  ylab("Richness") + xlab("Date") +
  scale_color_manual(values = green_scale) +
  theme(legend.title = element_text(size=12)) +
  theme(text = element_text(size = 14)) +
  labs(col = "Treatment") #change legend title
```

## Figure S10: Synchrony-Stability Correlations Final Figs
```{r, fig.height=8, fig.width=8, echo=FALSE}
mw7synstabfig <- stab_syn_mw %>%
  filter(window_size == 7)

corrsynL <- ggplot(mw7synstabfig, aes(x=meanloreau, y=mean_stability, color = timestep)) +
    geom_point() +
    ylab("Stability") + xlab("Loreau Synchrony: All species") +
    facet_wrap(~TREATMENT, ncol = 6) +
    theme(legend.title = element_text(size=14)) +  theme(text = element_text(size = 14))

mw7big5synstabfig <- big5stab_syn_mw %>%
  filter(window_size == 7)

b5corrsynL <- ggplot(mw7big5synstabfig, aes(x=meanloreau, y=mean_stability, color = timestep)) +
    geom_point() +
    ylab("Stability") + xlab("Loreau Synchrony: Big 5 species") +
    facet_wrap(~TREATMENT, ncol = 6) +
    theme(legend.title = element_text(size=14)) +  theme(text = element_text(size = 14))


mw7nondomsynstabfig <- nondomstab_syn_mw %>%
  filter(window_size == 7)

ndcorrsynL <- ggplot(mw7nondomsynstabfig, aes(x=meanloreau, y=mean_stability, color = timestep)) +
    geom_point() +
    ylab("Stability") + xlab("Loreau Synchrony: Non-dominant species") +
    facet_wrap(~TREATMENT, ncol = 6) +
    theme(legend.title = element_text(size=14)) +  theme(text = element_text(size = 14))


ggarrange(corrsynL, b5corrsynL, ndcorrsynL,
          ncol = 1, nrow = 3, align = "hv", 
          common.legend = TRUE, 
          labels = "AUTO",
          legend = "bottom"
          )
```

# Currently Unused Figures
## Correlation Figures
```{r, echo=FALSE}
## Loreau Synchrony correlations
ggplot(stab_syn_mw, aes(x=meanloreau, y=mean_stability, color = timestep)) +
  geom_point() +
  ylab("Stability") + xlab("Loreau Synchrony") +
  facet_wrap(~window_size*TREATMENT, ncol = 6)


ggplot(mw7synstabfig, aes(x=meanloreau, y=mean_stability, color = timestep)) +
    geom_point() +
    ylab("Stability") + xlab("Loreau Synchrony") +
    facet_wrap(~TREATMENT, ncol = 3)


ggplot(big5stab_syn_mw, aes(x=meanloreau, y=mean_stability, color = timestep)) +
  geom_point() +
  ylab("Stability") + xlab("Loreau Synchrony") +
  facet_wrap(~window_size*TREATMENT, ncol = 6)

ggplot(nondomstab_syn_mw, aes(x=meanloreau, y=mean_stability, color = timestep)) +
  geom_point() +
  ylab("Stability") + xlab("Loreau Synchrony") +
  facet_wrap(~window_size*TREATMENT, ncol = 6)

## Dominance Correlations
ggplot(stab_dom_mw, aes(x=mean_dominance, y=mean_stability, color = timestep)) +
  geom_point() +
  ylab("Stability") + xlab("Dominance") +
  facet_wrap(~~window_size*TREATMENT, ncol = 6)



## Dominance and Synchrony Correlations
ggplot(syn_dom_mw, aes(x= mean_dominance, y=meanloreau, color = timestep)) +
  geom_point() +
  ylab("Synchrony") + xlab("Dominance") +
  facet_wrap(~~window_size*TREATMENT, ncol = 6) +
  ggtitle("Synchrony and Dominance Correlations")
```



## Variability in Mechanisms - Exploration
```{r, echo=FALSE, fig.width=8, fig.height=4}
dom <- ggplot(meanstab_mech, aes(x=TREATMENT, y=mean_vardom)) +
  geom_point(size = 3) +
  ylab("Variance of BP Dominance through Time") + xlab("")


rich <- ggplot(meanstab_mech, aes(x=TREATMENT, y=mean_varrich)) +
  geom_point(size = 3) +
  ylab("Variance of Richness through Time") + xlab("")

ggarrange(dom, rich, ncol = 2, align = "hv")
```

## Big 5 Species Over Time 
```{r, echo = FALSE, fig.width=8, fig.height=4}
## take the mean biomass of big 5 species in each treatment
big5time <- big5annual %>%
  group_by(TREATMENT, SPECIES, Date_final) %>%
  summarise(meanbio = mean(Pin_Hits))

ggplot(big5time, aes(x=Date_final, y=meanbio, color = SPECIES)) +
  geom_line(size = 0.8) +
  facet_wrap(~TREATMENT) +
  ylab("Mean Cover") + xlab("Date") +
  scale_color_manual(values = colors)
```


