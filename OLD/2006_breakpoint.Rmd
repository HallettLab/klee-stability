---
title: "PRC_comp_analysis"
author: "Carmen Ebel"
date: "6/1/2021"
output: html_document
---

## Load Data
```{r setup, echo=FALSE}
setwd("~/Repositories/klee-stability")

## Load packages
library(tidyverse)
library(vegan)
library(forcats)
library(lubridate)
library(codyn)
library(ggpubr)
library(lme4)
library(nlme)
library(emmeans)
library(car)
library(MuMIn)
library(scico)

## Load packages

library(tsvr)
library(knitr)
library(data.table)
library(segmented)
library(breakpoint)
library(ggrepel)
library(lme4)
library(nlme)


## source cleaned data
source("klee_allyears_cleaning.R")

klee_annual <- klee_annual %>%
  mutate(TREATMENT = fct_relevel(TREATMENT, "O", "W", "MW", "C", "WC", "MWC")) #reorder treatments

klee_annual$Date_numeric <- as.numeric(klee_annual$Date_numeric)

## based on Riginos paper: breakpoint is March 2006
## separate data frame into pre-2006 and post-2006
pre06 <- klee_annual %>%
  filter(Date_final < "2006-06-01")

post06 <- klee_annual %>%
  filter(Date_final > "2005-06-01")

## big 5
big5 <- c("Brachiaria_lachnantha", "Pennisetum_stramineum", "Lintonia_nutans", "Themeda_triandra", "Pennisetum_mezianum")

big5pre06 <- klee_annual %>%
  filter(SPECIES %in% big5, Date_final < "2006-06-01")

big5post06 <- klee_annual %>%
  filter(SPECIES %in% big5, Date_final > "2005-06-01")

nondompre06 <- klee_annual %>%
  filter(!SPECIES %in% big5, Date_final < "2006-06-01")

nondompost06 <- klee_annual %>%
  filter(!SPECIES %in% big5, Date_final > "2005-06-01")
```

## Calculate Stability
```{r, echo=FALSE}
## Calculate Community Stability for all years
commstab <- community_stability(klee_annual, 
                                time.var = "Date_numeric", 
                                abundance.var = "Pin_Hits", 
                                replicate.var = "Unique_ID")

## Calculate community stability pre-06
pre06stab <- community_stability(pre06, 
                                time.var = "Date_numeric", 
                                abundance.var = "Pin_Hits", 
                                replicate.var = "Unique_ID")

## Calculate community stability post-06
post06stab <- community_stability(post06, 
                                time.var = "Date_numeric", 
                                abundance.var = "Pin_Hits", 
                                replicate.var = "Unique_ID")

## Join with treatment info & calculate CV
stability <- left_join(commstab, treats, by = "Unique_ID") %>% 
  mutate(CV = 1/stability) %>% #calculate the CV as inverse of stability
  mutate(date = "all")

pre06stability <- left_join(pre06stab, treats, by = "Unique_ID") %>% 
  mutate(CV = 1/stability) %>% #calculate the CV by taking the inverse of stability
  mutate(date = "pre-06")

post06stability <- left_join(post06stab, treats, by = "Unique_ID") %>% 
  mutate(CV = 1/stability) %>% #calculate the CV by taking the inverse of stability
  mutate(date = "post-06")

rm(list = c("pre06stab", "post06stab", "commstab"))
```

## Calculate Synchrony
```{r, echo = FALSE}
## Calculate Loreau Synchrony metric
## ALL YEARS
synchrony <- synchrony(
  klee_annual,
  time.var = "Date_numeric",
  species.var = "SPECIES",
  abundance.var = "Pin_Hits",
  metric = "Loreau",
  replicate.var = "Unique_ID"
)
colnames(synchrony) <- c("Unique_ID", "synchrony") #rename columns

big5synchrony <- synchrony(
  big5annual,
  time.var = "Date_numeric",
  species.var = "SPECIES",
  abundance.var = "Pin_Hits",
  metric = "Loreau",
  replicate.var = "Unique_ID"
)
colnames(big5synchrony) <- c("Unique_ID", "big5synchrony") #rename columns

nondomsynchrony <- synchrony(
  nondom,
  time.var = "Date_numeric",
  species.var = "SPECIES",
  abundance.var = "Pin_Hits",
  metric = "Loreau",
  replicate.var = "Unique_ID"
)
colnames(nondomsynchrony) <- c("Unique_ID", "nondomsynchrony") #rename columns



## PRE 2006
pr6synchrony <- synchrony(
  pre06,
  time.var = "Date_numeric",
  species.var = "SPECIES",
  abundance.var = "Pin_Hits",
  metric = "Loreau",
  replicate.var = "Unique_ID"
)
colnames(pr6synchrony) <- c("Unique_ID", "synchrony") #rename columns

pr6big5synchrony <- synchrony(
  big5pre06,
  time.var = "Date_numeric",
  species.var = "SPECIES",
  abundance.var = "Pin_Hits",
  metric = "Loreau",
  replicate.var = "Unique_ID"
)
colnames(pr6big5synchrony) <- c("Unique_ID", "big5synchrony") #rename columns

pr6nondomsynchrony <- synchrony(
  nondompre06,
  time.var = "Date_numeric",
  species.var = "SPECIES",
  abundance.var = "Pin_Hits",
  metric = "Loreau",
  replicate.var = "Unique_ID"
)
colnames(pr6nondomsynchrony) <- c("Unique_ID", "nondomsynchrony") #rename columns


## POST 2006
pst6synchrony <- synchrony(
  post06,
  time.var = "Date_numeric",
  species.var = "SPECIES",
  abundance.var = "Pin_Hits",
  metric = "Loreau",
  replicate.var = "Unique_ID"
)
colnames(pst6synchrony) <- c("Unique_ID", "synchrony") #rename columns

pst6big5synchrony <- synchrony(
  big5post06,
  time.var = "Date_numeric",
  species.var = "SPECIES",
  abundance.var = "Pin_Hits",
  metric = "Loreau",
  replicate.var = "Unique_ID"
)
colnames(pst6big5synchrony) <- c("Unique_ID", "big5synchrony") #rename columns

pst6nondomsynchrony <- synchrony(
  nondompost06,
  time.var = "Date_numeric",
  species.var = "SPECIES",
  abundance.var = "Pin_Hits",
  metric = "Loreau",
  replicate.var = "Unique_ID"
)
colnames(pst6nondomsynchrony) <- c("Unique_ID", "nondomsynchrony") #rename columns
```

### Calculate TSVR
```{r,  echo=FALSE}
## Calculate Timescale Specific VR ##
#set up data frame to put tsvr into
outnames <- c("Unique_ID", "TREATMENT", "classicVR", "longVR", "shortVR") #column names
siteout <- as.data.frame(matrix(nrow=0, ncol = 5)) #make empty dataframe
names(siteout) <- outnames #set names for empty dataframe
plots <- unique(klee_annual$Unique_ID) #make vector of unique plots

## Use for loop to calculate TSVR for each plot
for (i in 1:length(plots)) {
  
  #subset by replicate (gives all observations from one plot over time)
  plot <- subset(klee_annual, Unique_ID == plots[i]) %>%
    tbl_df()
  
  #select species and fill 0's 
  plot2 <- plot %>%
    select(Date_numeric, SPECIES, Pin_Hits) %>% #selecting only these three columns
    spread(SPECIES, Pin_Hits, fill = 0) #changing to wide format
  
  #transpose the data 
  dat <- t(as.matrix(plot2[,2:dim(plot2)[2]]))
  
  #create a dataframe with replicate info to attach VR metrics to
  VR_plots <- plot %>%
    select(Unique_ID, TREATMENT, BLOCK) %>%
    unique()
  
  #calculate classic VR
  res0 <- vreq_classic(dat)
  VR_plots$classicVR <- res0[[3]]
  
  #calculate tsvr 
  res <- tsvreq_classic(dat)
  
  #aggregate short vs. long variance ratios
  resLong <- aggts(res, res$ts[res$ts>=4]) #grabbing tsvr with time period >= 4 years
  resShort <- aggts(res, res$ts[res$ts<4]) #grabbing tsvr with time period <4 years
  
  #attach short & long variance ratios
  VR_plots$longVR <- resLong[[3]]
  VR_plots$shortVR <- resShort[[3]]
  
  #append to external dataframe
  siteout<-rbind(siteout, VR_plots)
}

#rename data frame
tsVR <- siteout


## Calculate the mean and standard error of VR metrics
meantsVR <- tsVR %>%
  pivot_longer(cols = classicVR:shortVR, names_to = "VR_type", values_to = "VR_value" ) %>% #change to long format
  group_by(TREATMENT, VR_type) %>%
  summarise(meanVR = mean(VR_value), SEVR = calcSE(VR_value))

#reorder treatments to match grazing pressure.
meantsVR$TREATMENT <- as.factor(meantsVR$TREATMENT) #change treatment to factor
meantsVR$TREATMENT <- factor(meantsVR$TREATMENT, levels = c("O", "W",  "MW",  "C", "WC", "MWC"))




## Compare VR & Stability ##

## join mean stability & mean tsVR data frames. 
#tsvr_stab <- inner_join(mean_stability, meantsVR, by = "TREATMENT") 

## Create a data frame with all synchrony and variance ratio metrics in order to make a table.
## change mean synchrony to wide format
#meansyn <- mean_synchrony %>%
 # pivot_wider(names_from = "Metric_Name", values_from = "mean_value") %>% #make unique columns for each synchrony metric
  #group_by(TREATMENT) %>%
 # summarise(GS=mean(gross_synchrony, na.rm = T), LS=mean(loreau_synchrony, na.rm = T)) #calculate the mean for each treatment and remove NAs to get rid of the weird column format that pivot wider creates here

## change mean tsvr to wide format
#tsvrmean <- tsvr_stab %>%
 # pivot_wider(names_from = "VR_type", values_from = "meanVR") %>% #make unique column for each variance ratio metric
 # group_by(TREATMENT) %>%
 # summarise(classic=mean(classicVR, na.rm = TRUE), short = mean(shortVR, na.rm=TRUE), long=mean(longVR, na.rm = TRUE)) #calculate the mean for each treatment and remove NAs to get rid of the weird column format that pivot wider creates here

## join synchrony and variance ratio data frames
#comp_dyn <- left_join(meansyn, tsvrmean, by = "TREATMENT") 
```



## Calculate Dominance
```{r, echo=FALSE}
## Full Time Series
## calculate Berger-Parker Dominance for each unique ID at each date
BP_dominance <- klee_annual %>%
  group_by(TREATMENT, Unique_ID, Date_final) %>% #group by treatment, plot, and date
  mutate(rank = rank(Pin_Hits, na.last = NA, ties.method = "average")) %>% #rank species in order of abundance
  mutate(tot_abund = sum(Pin_Hits)) %>% #create column for total abundance in each plot
  filter(rank == max(rank)) %>% #only include most abundant species in each plot
  summarise(BP_dominance = Pin_Hits/tot_abund) %>% #calculate Berger-Parker dominance index
  mutate(date = "all")

## Calculate the mean Berger-Parker dominance by: 
  ## TREATMENT and UNIQUE ID - to use eventually for linear models
meanplot_BPdom <- BP_dominance %>%
  group_by(TREATMENT, Unique_ID) %>%
  summarize(mean_dom = mean(BP_dominance), SEdom = calcSE(BP_dominance), vardom = var(BP_dominance))


## Pre 2006
## calculate Berger-Parker Dominance for each unique ID at each date
pr6BP_dominance <- pre06 %>%
  group_by(TREATMENT, Unique_ID, Date_final) %>% #group by treatment, plot, and date
  mutate(rank = rank(Pin_Hits, na.last = NA, ties.method = "average")) %>% #rank species in order of abundance
  mutate(tot_abund = sum(Pin_Hits)) %>% #create column for total abundance in each plot
  filter(rank == max(rank)) %>% #only include most abundant species in each plot
  summarise(BP_dominance = Pin_Hits/tot_abund) %>% #calculate Berger-Parker dominance index
  mutate(date = "pre-06")

## Calculate the mean Berger-Parker dominance by: 
  ## TREATMENT and UNIQUE ID - to use eventually for linear models
pr6meanplot_BPdom <- pr6BP_dominance %>%
  group_by(TREATMENT, Unique_ID) %>%
  summarize(mean_dom = mean(BP_dominance), SEdom = calcSE(BP_dominance), vardom = var(BP_dominance))


## Post 2006
## calculate Berger-Parker Dominance for each unique ID at each date
pst6BP_dominance <- post06 %>%
  group_by(TREATMENT, Unique_ID, Date_final) %>% #group by treatment, plot, and date
  mutate(rank = rank(Pin_Hits, na.last = NA, ties.method = "average")) %>% #rank species in order of abundance
  mutate(tot_abund = sum(Pin_Hits)) %>% #create column for total abundance in each plot
  filter(rank == max(rank)) %>% #only include most abundant species in each plot
  summarise(BP_dominance = Pin_Hits/tot_abund) %>% #calculate Berger-Parker dominance index
  mutate(date = "post-06")

## Calculate the mean Berger-Parker dominance by: 
  ## TREATMENT and UNIQUE ID - to use eventually for linear models
pst6meanplot_BPdom <- pst6BP_dominance %>%
  group_by(TREATMENT, Unique_ID) %>%
  summarize(mean_dom = mean(BP_dominance), SEdom = calcSE(BP_dominance), vardom = var(BP_dominance))

rm(list = c("pr6BP_dominance", "pst6BP_dominance"))
```

## Calculate Richness
```{r, echo = FALSE}
## ALL YEARS ----
## Calculate species richness for each plot at each point in time
rich <- klee_annual %>%
  group_by(TREATMENT, Unique_ID, Date_final) %>% ## group by each plot at each date
  summarise(richness = n())
  ## use this dataframe for the ANOVA?

## Calculate the mean richness by: 
  ## TREATMENT and DATE
meanannrich <- rich %>%
  group_by(TREATMENT, Date_final) %>%
  summarise(meanrich = mean(richness), SErich = calcSE(richness)) %>%
  mutate(date = "all")
  ## TREATMENT and UNIQUE_ID
meanrichplot <- rich %>%
  group_by(TREATMENT, Unique_ID) %>%
  summarise(meanrich = mean(richness, SErich = calcSE(richness)), varrich = var(richness)) 

## BIG 5 SPECIES 
## Calculate species richness for each plot at each point in time
big5rich <- big5annual %>%
  group_by(TREATMENT, Unique_ID, Date_final) %>% ## group by each plot at each date
  summarise(richness = n())

## Calculate the mean richness by: 
  ## TREATMENT and DATE
big5meanannrich <- big5rich %>%
  group_by(TREATMENT, Date_final) %>%
  summarise(meanrich = mean(richness), SErich = calcSE(richness))
  ## TREATMENT and UNIQUE_ID
big5meanrichplot <- big5rich %>%
  group_by(TREATMENT, Unique_ID) %>%
  summarise(meanrich = mean(richness, SErich = calcSE(richness)), varrich = var(richness))

## NON-DOMINANT SPECIES
## Calculate species richness for each plot at each point in time
nondomrich <- nondom %>%
  group_by(TREATMENT, Unique_ID, Date_final) %>% ## group by each plot at each date
  summarise(richness = n())

## Calculate the mean richness by: 
  ## TREATMENT and DATE
nondommeanannrich <- nondomrich %>%
  group_by(TREATMENT, Date_final) %>%
  summarise(meanrich = mean(richness), SErich = calcSE(richness))
  ## TREATMENT and UNIQUE_ID
nondommeanrichplot <- nondomrich %>%
  group_by(TREATMENT, Unique_ID) %>%
  summarise(meanrich = mean(richness, SErich = calcSE(richness)), varrich = var(richness))



## PRE-2006 ----
## Calculate species richness for each plot at each point in time
pr6rich <- pre06 %>%
  group_by(TREATMENT, Unique_ID, Date_final) %>% ## group by each plot at each date
  summarise(richness = n())
  ## use this dataframe for the ANOVA?

## Calculate the mean richness by: 
  ## TREATMENT and DATE
pr6meanannrich <- pr6rich %>%
  group_by(TREATMENT, Date_final) %>%
  summarise(meanrich = mean(richness), SErich = calcSE(richness)) %>%
  mutate(date = "pre-06")
  ## TREATMENT and UNIQUE_ID
pr6meanrichplot <- pr6rich %>%
  group_by(TREATMENT, Unique_ID) %>%
  summarise(meanrich = mean(richness, SErich = calcSE(richness)), varrich = var(richness)) 

## POST-2006
## Calculate species richness for each plot at each point in time
pst6rich <- post06 %>%
  group_by(TREATMENT, Unique_ID, Date_final) %>% ## group by each plot at each date
  summarise(richness = n())
  ## use this dataframe for the ANOVA?

## Calculate the mean richness by: 
  ## TREATMENT and DATE
pst6meanannrich <- pst6rich %>%
  group_by(TREATMENT, Date_final) %>%
  summarise(meanrich = mean(richness), SErich = calcSE(richness)) %>%
  mutate(date = "post-06")
  ## TREATMENT and UNIQUE_ID
pst6meanrichplot <- pst6rich %>%
  group_by(TREATMENT, Unique_ID) %>%
  summarise(meanrich = mean(richness, SErich = calcSE(richness)), varrich = var(richness)) 
```

## Create combined Stability & Mechanisms Data Frames
```{r, echo = FALSE}
## ALL YEARS
## Create data frame with one value of stability & mechanisms for each plot
synchrony_stability <- left_join(synchrony, stability, by = "Unique_ID") %>%
  mutate(date = "all")
ssb5 <- left_join(synchrony_stability, big5synchrony, by = "Unique_ID")
ssnd <- left_join(ssb5, nondomsynchrony, by = "Unique_ID")
ssdom <- left_join(ssnd, meanplot_BPdom, by = c("Unique_ID", "TREATMENT"))
stability_mechanisms <- left_join(ssdom, meanrichplot, by = c("Unique_ID", "TREATMENT"))



## PRE 2006
pr6synchrony_stability <- left_join(pr6synchrony, pre06stability, by = "Unique_ID") %>%
  mutate(date = "pre-06")
pr6ssb5 <- left_join(pr6synchrony_stability, pr6big5synchrony, by = "Unique_ID")
pr6ssnd <- left_join(pr6ssb5, pr6nondomsynchrony, by = "Unique_ID")
pr6ssdom <- left_join(pr6ssnd, pr6meanplot_BPdom, by = c("Unique_ID", "TREATMENT"))
pr6stability_mechanisms <- left_join(pr6ssdom, pr6meanrichplot, by = c("Unique_ID", "TREATMENT"))


## POST 2006
pst6synchrony_stability <- left_join(pst6synchrony, post06stability, by = "Unique_ID") %>%
  mutate(date = "post-06")
pst6ssb5 <- left_join(pst6synchrony_stability, pst6big5synchrony, by = "Unique_ID")
pst6ssnd <- left_join(pst6ssb5, pst6nondomsynchrony, by = "Unique_ID")
pst6ssdom <- left_join(pst6ssnd, pst6meanplot_BPdom, by = c("Unique_ID", "TREATMENT"))
pst6stability_mechanisms <- left_join(pst6ssdom, pst6meanrichplot, by = c("Unique_ID", "TREATMENT"))


## Join all stability-mechanism data frames
st_temp <- rbind(stability_mechanisms, pr6stability_mechanisms)
stability_mechanisms_all <- rbind(st_temp, pst6stability_mechanisms)


## Create data frame with one value of stability & mechanisms for each treatment
## ALL YEARS
meanstab_mech <- stability_mechanisms %>%
  group_by(TREATMENT) %>%
  summarise(mean_st = mean(stability), SE_st = calcSE(stability), mean_syn = mean(synchrony), SE_syn = calcSE(synchrony),
            SE_dom = calcSE(mean_dom), mean_dom = mean(mean_dom), mean_rich = mean(meanrich), SE_rich = calcSE(meanrich), 
            b5mean_syn = mean(big5synchrony), b5SE_syn = calcSE(big5synchrony), ndmean_syn = mean(nondomsynchrony), 
            ndSE_syn = calcSE(nondomsynchrony), mean_vardom = mean(vardom), SE_vardom = calcSE(vardom), mean_varrich = mean(varrich), 
            SE_varrich = calcSE(varrich), mean_CV = mean(CV), SE_CV = calcSE(CV)) %>%
  mutate(TREATMENT = fct_relevel(TREATMENT, "O", "W", "MW", "C", "WC", "MWC")) #reorder treatments

## PRE 2006
pr6meanstab_mech <- pr6stability_mechanisms %>%
  group_by(TREATMENT) %>%
  summarise(mean_st = mean(stability), SE_st = calcSE(stability), mean_syn = mean(synchrony), SE_syn = calcSE(synchrony), 
            SE_dom = calcSE(mean_dom), mean_dom = mean(mean_dom), mean_rich = mean(meanrich), SE_rich = calcSE(meanrich),
            b5mean_syn = mean(big5synchrony), b5SE_syn = calcSE(big5synchrony), ndmean_syn = mean(nondomsynchrony), 
            ndSE_syn = calcSE(nondomsynchrony),  mean_vardom = mean(vardom), SE_vardom = calcSE(vardom), mean_varrich = mean(varrich), 
            SE_varrich = calcSE(varrich), mean_CV = mean(CV), SE_CV = calcSE(CV))

## POST 2006
pst6meanstab_mech <- pst6stability_mechanisms %>%
  group_by(TREATMENT) %>%
  summarise(mean_st = mean(stability), SE_st = calcSE(stability), mean_syn = mean(synchrony), SE_syn = calcSE(synchrony), 
            SE_dom = calcSE(mean_dom), mean_dom = mean(mean_dom), mean_rich = mean(meanrich), SE_rich = calcSE(meanrich),
            b5mean_syn = mean(big5synchrony), b5SE_syn = calcSE(big5synchrony), ndmean_syn = mean(nondomsynchrony), 
            ndSE_syn = calcSE(nondomsynchrony),
            mean_vardom = mean(vardom), SE_vardom = calcSE(vardom), mean_varrich = mean(varrich), SE_varrich = calcSE(varrich),
            mean_CV = mean(CV), SE_CV = calcSE(CV))

stability_mechanisms_all$TREATMENT <- as.factor(stability_mechanisms_all$TREATMENT)

## Combine all time points into one data frame with one value of stability & mechanisms for each treatment
meanstab_mech_all <- stability_mechanisms_all %>%
  group_by(TREATMENT, date) %>%
  summarise(mean_st = mean(stability), SE_st = calcSE(stability), mean_syn = mean(synchrony), SE_syn = calcSE(synchrony), 
            SE_dom = calcSE(mean_dom), mean_dom = mean(mean_dom), mean_rich = mean(meanrich), SE_rich = calcSE(meanrich),
            b5mean_syn = mean(big5synchrony), b5SE_syn = calcSE(big5synchrony), ndmean_syn = mean(nondomsynchrony), 
            ndSE_syn = calcSE(nondomsynchrony),
            mean_vardom = mean(vardom), SE_vardom = calcSE(vardom), mean_varrich = mean(varrich), SE_varrich = calcSE(varrich),
            mean_CV = mean(CV), SE_CV = calcSE(CV)) %>%
  mutate(TREATMENT = fct_relevel(TREATMENT, "O", "W", "MW", "C", "WC", "MWC")) #reorder treatments


rm(list = c("synchrony_stability", "ssdom", "pr6synchrony_stability", "pr6ssdom", "pst6synchrony_stability", "pst6ssdom", "st_temp", "ssb5", "ssnd"))
```

# Significance Testing
## Mixed Effects Models for ALL YEARS of Herbivory & Stability/Mechanisms
```{r}
## How does herbivore treatment change stability & stability mechanisms?
  ## use block as a random effect

## Stability by Herbivory Treatment
fitgrst <- lmer(stability~TREATMENT + (1|BLOCK), data = stability_mechanisms)
summary(fitgrst)

fitstnull <- lmer(stability~1 + (1|BLOCK), data = stability_mechanisms)
summary(fitstnull)
AIC(fitstnull)
AIC(fitgrst)
## use AIC to compare to model where Tx is taken out
## diff b/w AIC vals > 2; & lower AIC score is better
## treatment makes a diff here.
## do this for each of the models

## for diff b/w tx -> use emmeans 
emmeans(fitgrst, specs = pairwise ~ TREATMENT)



## Synchrony by Herbivory Treatment
fitgrsy <- lmer(synchrony~TREATMENT + (1|BLOCK), data = stability_mechanisms)
summary(fitgrsy)

fitsynull <- lmer(synchrony~1 + (1|BLOCK), data = stability_mechanisms)
summary(fitsynull)

AIC(fitsynull)
AIC(fitgrsy)
## treatment does make a difference here

## difference between treatments
emmeans(fitgrsy, specs = pairwise ~ TREATMENT)



## Big 5 Synchrony by Herbivory Treatment
fitgrsyb5 <- lmer(big5synchrony~TREATMENT + (1|BLOCK), data = stability_mechanisms)
summary(fitgrsyb5)

fitsyb5null <- lmer(big5synchrony~1 + (1|BLOCK), data = stability_mechanisms)
summary(fitsyb5null)

AIC(fitsyb5null)
AIC(fitgrsyb5)
## treatment does make a difference here

## difference between treatments
emmeans(fitgrsyb5, specs = pairwise ~ TREATMENT)


## Subordinate Synchrony by Herbivory Treatment
fitgrsynd <- lmer(nondomsynchrony~TREATMENT + (1|BLOCK), data = stability_mechanisms)
summary(fitgrsyb5)

fitsyndnull <- lmer(nondomsynchrony~1 + (1|BLOCK), data = stability_mechanisms)
summary(fitsyndnull)

AIC(fitsyndnull)
AIC(fitgrsynd)
## treatment does make a difference here

## difference between treatments
emmeans(fitgrsynd, specs = pairwise ~ TREATMENT)



## Dominance by Herbivory Treatment 
fitgrdo <- lmer(mean_dom~TREATMENT + (1|BLOCK), data = stability_mechanisms)
summary(fitgrdo)

fitdonull <- lmer(mean_dom~1 + (1|BLOCK), data = stability_mechanisms)
summary(fitdonull)
AIC(fitgrdo)
AIC(fitdonull)
## treatment does make a difference here

## difference between treatments
emmeans(fitgrdo, specs = pairwise ~ TREATMENT)


## Richness by Herbivory Treatment
fitgrri <- lmer(meanrich~TREATMENT + (1|BLOCK), data = stability_mechanisms)
summary(fitgrri)

fitrinull <- lmer(meanrich~1 + (1|BLOCK), data = stability_mechanisms)
summary(fitrinull)
AIC(fitgrri)
AIC(fitrinull)
## treatment slightly makes a difference 

## difference between treatments
emmeans(fitgrri, specs = pairwise ~ TREATMENT)


## Variance of Richness by Herbivory Treatment
fitgrvr <- lmer(varrich~TREATMENT + (1|BLOCK), data = stability_mechanisms)
summary(fitgrvr)

fitvrnull <- lmer(varrich~1 + (1|BLOCK), data = stability_mechanisms)
summary(fitvrnull)
AIC(fitgrvr)
AIC(fitvrnull)
## treatment slightly makes a difference 

## difference between treatments
emmeans(fitgrvr, specs = pairwise ~ TREATMENT)

```

## Mixed Effects Models for PRE 2006 Herbivory & Stability/Mechanisms
```{r}
## How does herbivore treatment change stability & stability mechanisms?
  ## use block as a random effect

## Stability by Herbivory Treatment
fitgrstpr6 <- lmer(stability~TREATMENT + (1|BLOCK), data = pr6stability_mechanisms)
summary(fitgrstpr6)

fitstpr6null <- lmer(stability~1 + (1|BLOCK), data = pr6stability_mechanisms)
summary(fitstpr6null)
AIC(fitstpr6null)
AIC(fitgrstpr6)
## use AIC to compare to model where Tx is taken out
## diff b/w AIC vals > 2; & lower AIC score is better
## treatment makes a diff here.
## do this for each of the models

## for diff b/w tx -> use emmeans 
emmeans(fitgrstpr6, specs = pairwise ~ TREATMENT)



## Synchrony by Herbivory Treatment
fitgrsypr6 <- lmer(synchrony~TREATMENT + (1|BLOCK), data = pr6stability_mechanisms)
summary(fitgrsypr6)

fitsypr6null <- lmer(synchrony~1 + (1|BLOCK), data = pr6stability_mechanisms)
summary(fitsypr6null)

AIC(fitsypr6null)
AIC(fitgrsypr6)
## treatment does make a difference here

## difference between treatments
emmeans(fitgrsypr6, specs = pairwise ~ TREATMENT)



## Big 5 Synchrony by Herbivory Treatment
fitgrsyb5pr6 <- lmer(big5synchrony~TREATMENT + (1|BLOCK), data = pr6stability_mechanisms)
summary(fitgrsyb5pr6)

fitsyb5pr6null <- lmer(big5synchrony~1 + (1|BLOCK), data = pr6stability_mechanisms)
summary(fitsyb5pr6null)

AIC(fitsyb5pr6null)
AIC(fitgrsyb5pr6)
## What do you do if there's a negative AIC value?

## difference between treatments
emmeans(fitgrsyb5pr6, specs = pairwise ~ TREATMENT)



## Subordinate Synchrony by Herbivory Treatment
fitgrsyndpr6 <- lmer(nondomsynchrony~TREATMENT + (1|BLOCK), data = pr6stability_mechanisms)
summary(fitgrsyb5pr6)

fitsyndpr6null <- lmer(nondomsynchrony~1 + (1|BLOCK), data = pr6stability_mechanisms)
summary(fitsyndnull)

AIC(fitsyndpr6null)
AIC(fitgrsyndpr6)
## What do you do if there's a negative AIC value?

## difference between treatments
emmeans(fitgrsyndpr6, specs = pairwise ~ TREATMENT)



## Dominance by Herbivory Treatment 
fitgrdopr6 <- lmer(mean_dom~TREATMENT + (1|BLOCK), data = pr6stability_mechanisms)
summary(fitgrdopr6)

fitdopr6null <- lmer(mean_dom~1 + (1|BLOCK), data = pr6stability_mechanisms)
summary(fitdopr6null)
AIC(fitgrdopr6)
AIC(fitdopr6null)
## What do you do if there's a negative AIC value?

## difference between treatments
emmeans(fitgrdopr6, specs = pairwise ~ TREATMENT)


## Richness by Herbivory Treatment
fitgrripr6 <- lmer(meanrich~TREATMENT + (1|BLOCK), data = pr6stability_mechanisms)
summary(fitgrripr6)

fitripr6null <- lmer(meanrich~1 + (1|BLOCK), data = pr6stability_mechanisms)
summary(fitripr6null)
AIC(fitgrripr6)
AIC(fitripr6null)
## no difference between null & Treatment model

## difference between treatments
emmeans(fitgrripr6, specs = pairwise ~ TREATMENT)



## Variance of Richness by Herbivory Treatment
fitgrvrpr6 <- lmer(varrich~TREATMENT + (1|BLOCK), data = pr6stability_mechanisms)
summary(fitgrvrpr6)

fitvrpr6null <- lmer(varrich~1 + (1|BLOCK), data = pr6stability_mechanisms)
summary(fitvrpr6null)
AIC(fitgrvrpr6)
AIC(fitvrpr6null)
## treatment makes a difference 

## difference between treatments
emmeans(fitgrvrpr6, specs = pairwise ~ TREATMENT)

```

## Mixed Effects Models for POST 2006 Herbivory & Stability/Mechanisms
```{r}
## How does herbivore treatment change stability & stability mechanisms?
  ## use block as a random effect

## Stability by Herbivory Treatment
fitgrstpst6 <- lmer(stability~TREATMENT + (1|BLOCK), data = pst6stability_mechanisms)
summary(fitgrstpst6)

fitstpst6null <- lmer(stability~1 + (1|BLOCK), data = pst6stability_mechanisms)
summary(fitstpst6null)
AIC(fitstpst6null)
AIC(fitgrstpst6)
## use AIC to compare to model where Tx is taken out
## diff b/w AIC vals > 2; & lower AIC score is better
## treatment makes a diff here.
## do this for each of the models

## for diff b/w tx -> use emmeans 
emmeans(fitgrstpst6, specs = pairwise ~ TREATMENT)



## Synchrony by Herbivory Treatment
fitgrsypst6 <- lmer(synchrony~TREATMENT + (1|BLOCK), data = pst6stability_mechanisms)
summary(fitgrsypst6)

fitsypst6null <- lmer(synchrony~1 + (1|BLOCK), data = pst6stability_mechanisms)
summary(fitsypst6null)

AIC(fitsypst6null)
AIC(fitgrsypst6)
## treatment does make a difference here

## difference between treatments
emmeans(fitgrsypst6, specs = pairwise ~ TREATMENT)



## Big 5 Synchrony by Herbivory Treatment
fitgrsyb5pst6 <- lmer(big5synchrony~TREATMENT + (1|BLOCK), data = pst6stability_mechanisms)
summary(fitgrsyb5pst6)

fitsyb5pst6null <- lmer(big5synchrony~1 + (1|BLOCK), data = pst6stability_mechanisms)
summary(fitsyb5pst6null)

AIC(fitsyb5pst6null)
AIC(fitgrsyb5pst6)
## What do you do if there's a negative AIC value?

## difference between treatments
emmeans(fitgrsyb5pst6, specs = pairwise ~ TREATMENT)



## Subordinate Synchrony by Herbivory Treatment
fitgrsyndpst6 <- lmer(nondomsynchrony~TREATMENT + (1|BLOCK), data = pst6stability_mechanisms)
summary(fitgrsyb5pst6)

fitsyndpst6null <- lmer(nondomsynchrony~1 + (1|BLOCK), data = pst6stability_mechanisms)
summary(fitsyndpst6null)

AIC(fitsyndpst6null)
AIC(fitgrsyndpst6)
## What do you do if there's a negative AIC value?

## difference between treatments
emmeans(fitgrsyndpst6, specs = pairwise ~ TREATMENT)



## Dominance by Herbivory Treatment 
fitgrdopst6 <- lmer(mean_dom~TREATMENT + (1|BLOCK), data = pst6stability_mechanisms)
summary(fitgrdopst6)

fitdopst6null <- lmer(mean_dom~1 + (1|BLOCK), data = pst6stability_mechanisms)
summary(fitdopst6null)
AIC(fitgrdopst6)
AIC(fitdopst6null)
## What do you do if there's a negative AIC value?

## difference between treatments
emmeans(fitgrdopst6, specs = pairwise ~ TREATMENT)


## Richness by Herbivory Treatment
fitgrripst6 <- lmer(meanrich~TREATMENT + (1|BLOCK), data = pst6stability_mechanisms)
summary(fitgrripst6)

fitripst6null <- lmer(meanrich~1 + (1|BLOCK), data = pst6stability_mechanisms)
summary(fitripst6null)
AIC(fitgrripst6)
AIC(fitripst6null)
## no difference between null & Treatment model

## difference between treatments
emmeans(fitgrripst6, specs = pairwise ~ TREATMENT)



## Variance of Richness by Herbivory Treatment
fitgrvrpst6 <- lmer(varrich~TREATMENT + (1|BLOCK), data = pst6stability_mechanisms)
summary(fitgrvrpst6)

fitvrpst6null <- lmer(varrich~1 + (1|BLOCK), data = pst6stability_mechanisms)
summary(fitvrpst6null)
AIC(fitgrvrpst6)
AIC(fitvrpst6null)
## treatment makes a difference 

## difference between treatments
emmeans(fitgrvrpst6, specs = pairwise ~ TREATMENT)

```

## Mixed Effects Models for Stability & Mechanisms (ALL YEARS)
```{r}
## Try Stability vs. Mechanism model variations
## linear mixed effects model in lme4

## Check whether any factors are highly correlated (above 0.7 wouldn't put in a multiple regression together)
## Test Correlations b/w variables
cor.test(stability_mechanisms$mean_dom, stability_mechanisms$synchrony)
## borderline

cor.test(stability_mechanisms$meanrich, stability_mechanisms$synchrony)

cor.test(stability_mechanisms$meanrich, stability_mechanisms$mean_dom)


## Model with all 3 stability mechanisms included as predictors
fitstabmech <- lmer(stability~mean_dom+meanrich+synchrony +(1|BLOCK), data = stability_mechanisms, na.action = "na.fail")
summary(fitstabmech)

## test to see if the model converges with just synchrony
fitstabsyn <- lmer(stability~synchrony +(1|BLOCK), data = stability_mechanisms, na.action = "na.fail")
summary(fitstabsyn)

fitb5stabsyn <- lmer(stability~big5synchrony +(1|BLOCK), data = stability_mechanisms, na.action = "na.fail")
summary(fitb5stabsyn)

AIC(fitstabsyn)
AIC(fitb5stabsyn)
## not different enough from each other

## test again to see if any of the predictors are highly correlated using the variance inflation factor
vif(fitstabmech)
## reasonably low vif values

## Use the dredge function from the MuMIn package to compare models with all combinations of these predictors, ranked by AIC
dredge(fitstabmech)
  ## looks like just synchrony is the most parsimonious model 
```

## Mixed Effects Models for Stability & Mechanisms (PRE AND POST 2006)
```{r}
## Try Stability vs. Mechanism model variations
## linear mixed effects model in lme4

## PRE 2006 ## 
## Check whether any factors are highly correlated (above 0.7 wouldn't put in a multiple regression together)
## Test Correlations b/w variables
cor.test(pr6stability_mechanisms$mean_dom, pr6stability_mechanisms$synchrony)
## good

cor.test(pr6stability_mechanisms$meanrich, pr6stability_mechanisms$synchrony)
## good

cor.test(pr6stability_mechanisms$meanrich, pr6stability_mechanisms$mean_dom)
## good

## Model with all 3 stability mechanisms included as predictors
fitstabmechpr6 <- lmer(stability~mean_dom+meanrich+synchrony +(1|BLOCK), data = pr6stability_mechanisms, na.action = "na.fail")
summary(fitstabmechpr6)

## test to see if the model converges with just synchrony
fitstabsynpr6 <- lmer(stability~synchrony +(1|BLOCK), data = pr6stability_mechanisms, na.action = "na.fail")
summary(fitstabsynpr6)


## test again to see if any of the predictors are highly correlated using the variance inflation factor
vif(fitstabmechpr6)
## reasonably low vif values

## Use the dredge function from the MuMIn package to compare models with all combinations of these predictors, ranked by AIC
dredge(fitstabmechpr6)
  ## looks like just synchrony is the most parsimonious model 
  ## again, dominance and synchrony have the lowest AIC score, 
  ## but it is less than 2 away from the AIC score of the model with only synchrony


## POST 2006 ##
## Check whether any factors are highly correlated (above 0.7 wouldn't put in a multiple regression together)
## Test Correlations b/w variables
cor.test(pst6stability_mechanisms$mean_dom, pst6stability_mechanisms$synchrony)
## good

cor.test(pst6stability_mechanisms$meanrich, pst6stability_mechanisms$synchrony)
## good

cor.test(pst6stability_mechanisms$meanrich, pst6stability_mechanisms$mean_dom)
## good

## Model with all 3 stability mechanisms included as predictors
fitstabmechpst6 <- lmer(stability~mean_dom+meanrich+synchrony +(1|BLOCK), data = pst6stability_mechanisms, na.action = "na.fail")
summary(fitstabmechpst6)

## test to see if the model converges with just synchrony
fitstabsydopst6 <- lmer(stability~mean_dom+synchrony +(1|BLOCK), data = pr6stability_mechanisms, na.action = "na.fail")
summary(fitstabsydopst6)


## test again to see if any of the predictors are highly correlated using the variance inflation factor
vif(fitstabmechpst6)
## reasonably low vif values

## Use the dredge function from the MuMIn package to compare models with all combinations of these predictors, ranked by AIC
dredge(fitstabmechpst6)
  ## here the model with dominance AND synchrony has the lowest AIC score by > 2

```

# Figure Settings
```{r, echo=FALSE, include=FALSE}
green_scale <- c("#97e196", "#6cc08b", "#4c9b82", "#217a79", "#105965", "#074050") #make a vector of colors
colors <- c("#88CCEE", "#CC6677","#DDCC77","#117733","#332288","#AA4499","#44AA99","#999933","#882255","#661100","#6699CC","#888888")
theme_set(theme_classic()) #set the theme
```

# Figures
## Stability and Mechanisms vs. Herbivory Figure
```{r, echo=FALSE, fig.width=10, fig.height=6}
## create a stability by herbivory figure
stab <- ggplot(meanstab_mech_all, aes(x=TREATMENT, y=mean_st, color = date)) +
  geom_point(size=3) +
  geom_errorbar(aes(ymin = mean_st-SE_st, ymax=mean_st+SE_st), width = 0.2) + #add standard error bars
  ylab("Stability (mean/sd)") + xlab("") +
  scale_color_manual(values = colors) +
  theme(legend.title = element_text(size=12)) +  theme(text = element_text(size = 14)) + #change font sizes
  labs(col = "Time Period")

## synchrony by herbivory
syn <- ggplot(meanstab_mech_all, aes(x=TREATMENT , y=mean_syn, color = date)) +
  geom_point(size=3) +
  scale_color_manual(values = colors) + 
  geom_errorbar(aes(ymin = mean_syn-SE_syn, ymax=mean_syn+SE_syn), width = 0.3) +
  ylab("Synchrony (All)") + xlab("") +  
  theme(legend.title = element_text(size=12)) +  theme(text = element_text(size = 14)) + #change font sizes
  labs(col = "Time Period")

b5syn <- ggplot(meanstab_mech_all, aes(x=TREATMENT , y=b5mean_syn, color = date)) +
  geom_point(size = 3) +
  scale_color_manual(values = colors) + 
  geom_errorbar(aes(ymin = b5mean_syn-b5SE_syn, ymax=b5mean_syn+b5SE_syn), width = 0.3) +
  ylab("Big 5 Synchrony") + xlab("") +  
  theme(legend.title = element_text(size=12)) +  theme(text = element_text(size = 14)) + #change font sizes
  labs(col = "Time Period")


ndsyn <- ggplot(meanstab_mech_all, aes(x=TREATMENT , y=ndmean_syn, color = date)) +
  geom_point(size=3) +
  scale_color_manual(values = colors) + 
  geom_errorbar(aes(ymin = ndmean_syn-ndSE_syn, ymax=ndmean_syn+ndSE_syn), width = 0.3) +
  ylab("ND Synchrony") + xlab("") +  
  theme(legend.title = element_text(size=12)) +  theme(text = element_text(size = 14)) + #change font sizes
  labs(col = "Time Period")

## dominance by herbivory
dom <- ggplot(meanstab_mech_all, aes(x=TREATMENT , y=mean_dom, color = date)) +
  geom_point(size=3) +
  scale_color_manual(values = colors) + 
  geom_errorbar(aes(ymin = mean_dom-SE_dom, ymax=mean_dom+SE_dom), width = 0.3) +
  ylab("Dominance") + xlab("") +  
  theme(legend.title = element_text(size=12)) +  theme(text = element_text(size = 14)) + #change font sizes
  labs(col = "Time Period") 

## richness by herbivory
rich <- ggplot(meanstab_mech_all, aes(x=TREATMENT , y=mean_rich, color = date)) +
  geom_point(size=3) +
  scale_color_manual(values = colors) + 
  geom_errorbar(aes(ymin = mean_rich-SE_rich, ymax=mean_rich+SE_rich), width = 0.3) +
  ylab("Richness") + xlab("") +  
  theme(legend.title = element_text(size=12)) +  theme(text = element_text(size = 14)) + #change font sizes
  labs(col = "Time Period")

ggarrange(stab, dom, rich, syn, b5syn, ndsyn,
          ncol = 3, nrow = 2,
          align = "hv",
          labels = "AUTO",
          common.legend = TRUE)
```

## Poster Figure 
```{r, fig.width=12.5, fig.height=3.5}
pstab <- ggplot(meanstab_mech, aes(x=TREATMENT, y=mean_st)) +
  geom_errorbar(aes(ymin = mean_st-SE_st, ymax=mean_st+SE_st), width = 0.2) + #add standard error bars
  geom_point(aes(fill=TREATMENT), 
       colour="black",pch=21, size=4) +
  scale_fill_scico_d(palette = "batlow", direction = -1) +
  ylab("Stability") + xlab("") +
  theme(legend.title = element_text(size=14)) +  theme(text = element_text(size = 16)) + #change font sizes
  labs(col = "Time Period") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

## dominance by herbivory
pdom <- ggplot(meanstab_mech, aes(x=TREATMENT , y=mean_dom)) +
  geom_errorbar(aes(ymin = mean_dom-SE_dom, ymax=mean_dom+SE_dom), width = 0.3) +
  geom_point(aes(fill=TREATMENT), 
       colour="black",pch=21, size=4) +
  scale_fill_scico_d(palette = "batlow", direction = -1) +
  ylab("Dominance") + xlab("") +  
  theme(legend.title = element_text(size=14)) +  theme(text = element_text(size = 16)) + #change font sizes
  labs(col = "Time Period") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

## synchrony by herbivory
psyn <- ggplot(meanstab_mech, aes(x=TREATMENT , y=mean_syn)) +
  geom_point(size=4) +
  scale_color_manual(values = colors) + 
  geom_errorbar(aes(ymin = mean_syn-SE_syn, ymax=mean_syn+SE_syn), width = 0.3) +
  ylab("Synchrony (All)") + xlab("") +  
  theme(legend.title = element_text(size=14)) +  theme(text = element_text(size = 16)) + #change font sizes
  labs(col = "Time Period")

pb5syn <- ggplot(meanstab_mech, aes(x=TREATMENT , y=b5mean_syn)) +
  geom_point(size = 3.5) +
  scale_color_manual(values = colors) + 
  geom_errorbar(aes(ymin = b5mean_syn-b5SE_syn, ymax=b5mean_syn+b5SE_syn), width = 0.3) +
  ylab("Big 5 Synchrony") + xlab("Treatment") +  
  theme(legend.title = element_text(size=14)) +  theme(text = element_text(size = 15)) + #change font sizes
  labs(col = "Time Period")



colnames(big5synchrony) <- c("Unique_ID", "synchrony")
colnames(nondomsynchrony) <- c("Unique_ID", "synchrony")

b5synchrony <- big5synchrony %>% 
  mutate(community_type = "Dominant")
ndsynchrony <- nondomsynchrony %>% 
  mutate(community_type = "Subordinate")
allsynchrony <- synchrony %>% 
  mutate(community_type = "All_Species")

syn2 <- rbind(b5synchrony, ndsynchrony)
syn3 <- rbind(syn2, allsynchrony) 
synstabtemp <- left_join(syn3, stability, by = "Unique_ID")

synstabtemp$TREATMENT <- as.factor(synstabtemp$TREATMENT)


syn_plot <- synstabtemp %>%
  group_by(TREATMENT, community_type) %>%
  summarise(mean_st = mean(stability), SE_st = calcSE(stability), mean_syn = mean(synchrony), SE_syn = calcSE(synchrony), mean_CV = mean(CV), SE_CV = calcSE(CV)) %>%
  mutate(TREATMENT = fct_relevel(TREATMENT, "O", "W", "MW", "C", "WC", "MWC")) #reorder treatments

ggplot(syn_plot, aes(x=TREATMENT, y=mean_syn, color = community_type, shape = community_type)) +
  geom_point(size = 3.5) +
  scale_color_manual(values = c("#000000", "#4f4f4f", "#919191")) + 
  scale_shape_manual(values = c(16,17,18)) +
  theme(legend.title = element_text(size=14)) +  theme(text = element_text(size = 15)) + #change font sizes
  geom_errorbar(aes(ymin = mean_syn-SE_syn, ymax=mean_syn+SE_syn), width = 0.2) +
  xlab("") + ylab("Synchrony") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

psynall <- ggplot(syn_plot, aes(x=TREATMENT, y=mean_syn, fill = TREATMENT, shape = community_type)) +
  geom_errorbar(aes(ymin = mean_syn-SE_syn, ymax=mean_syn+SE_syn), width = 0.2) +
  geom_point(size = 4) +
  geom_point(size = 4, fill = NA, colour = "black") +
  scale_shape_manual(values = c(24,22,18)) +
  #geom_point(aes(color=TREATMENT), size=3.6) +
  scale_fill_scico_d(palette = "batlow", direction = -1) +
 # scale_shape_manual(values = c(16,17,18)) +
  theme(legend.title = element_text(size=14)) +  theme(text = element_text(size = 16)) + #change font sizes
  xlab("") + ylab("Synchrony") +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))


ggplot(syn_plot, aes(x=TREATMENT, y=mean_syn, fill = TREATMENT, shape = community_type)) +
  geom_errorbar(aes(ymin = mean_syn-SE_syn, ymax=mean_syn+SE_syn), width = 0.2) +
  geom_point(size = 4) +
  geom_point(size = 4, fill = NA, colour = "black") +
  scale_shape_manual(values = c(24,22,18)) +
  #geom_point(aes(color=TREATMENT), size=3.6) +
  scale_fill_scico_d(palette = "batlow", direction = -1) +
 # scale_shape_manual(values = c(16,17,18)) +
  theme(legend.title = element_text(size=14)) +  theme(text = element_text(size = 16)) + #change font sizes
  xlab("") + ylab("Synchrony") +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))


ggplot(syn_plot, aes(x=TREATMENT, y=mean_syn, shape = community_type)) +
  geom_errorbar(aes(ymin = mean_syn-SE_syn, ymax=mean_syn+SE_syn), width = 0.2) +
  geom_point(aes(y=mean_syn, shape = community_type), size = 4.25) +
  geom_point(aes(color=TREATMENT), size=3.6) +
  scale_color_scico_d(palette = "batlow", direction = -1) +
  scale_shape_manual(values = c(16,17,18)) +
  theme(legend.title = element_text(size=14)) +  theme(text = element_text(size = 15)) + #change font sizes
  xlab("Treatment") + ylab("Synchrony") #+
  facet_wrap(~community_type)


prich <- ggplot(meanstab_mech, aes(x=TREATMENT , y=mean_rich)) +
  geom_errorbar(aes(ymin = mean_rich-SE_rich, ymax=mean_rich+SE_rich), width = 0.3) +
  geom_point(aes(fill=TREATMENT), 
       colour="black",pch=21, size=4) +
  scale_fill_scico_d(palette = "batlow", direction = -1) +
  ylab("Richness") + xlab("") +  
  theme(legend.title = element_text(size=14)) +  theme(text = element_text(size = 16)) + #change font sizes
  labs(col = "Time Period") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))


ggarrange(pstab, psynall, pdom, prich,
          ncol = 4,
          align = "hv",
          labels = "AUTO",
          common.legend = TRUE, 
          legend = "none")

ggarrange(pstab, psynall, pdom, prich,
          ncol = 4,
          align = "hv",
          labels = "AUTO",
          common.legend = TRUE, 
          legend = "right")

```


## Stability vs. Mechanisms Figure
```{r, echo = FALSE, fig.width=10, fig.height=6}
synstab <- ggplot(meanstab_mech_all, aes(x=mean_syn, y=mean_st, color = date)) +
  geom_point(size=3) +
  geom_errorbar(aes(ymin = mean_st-SE_st, ymax=mean_st+SE_st), width = 0.01) +
  geom_errorbarh(aes(xmin = mean_syn-SE_syn, xmax=mean_syn+SE_syn), height = 0.1) + #add standard error bars
  scale_color_manual(values = colors) + 
  ylab("Stability") + xlab("Synchrony (All)") +  
  theme(legend.title = element_text(size=12)) +  theme(text = element_text(size = 14)) #change font sizes

b5synstab <- ggplot(meanstab_mech_all, aes(x=b5mean_syn, y=mean_st, color = date)) +
  geom_point(size=3) +
  geom_errorbar(aes(ymin = mean_st-SE_st, ymax=mean_st+SE_st), width = 0.01) +
  geom_errorbarh(aes(xmin = b5mean_syn-b5SE_syn, xmax=b5mean_syn+b5SE_syn), height = 0.1) + #add standard error bars
  scale_color_manual(values = colors) + 
  ylab("Stability") + xlab("Synchrony (Big 5)") +  
  theme(legend.title = element_text(size=12)) +  theme(text = element_text(size = 14)) #change font sizes

ndsynstab <- ggplot(meanstab_mech_all, aes(x=ndmean_syn, y=mean_st, color = date)) +
  geom_point(size=3) +
  geom_errorbar(aes(ymin = mean_st-SE_st, ymax=mean_st+SE_st), width = 0.01) +
  geom_errorbarh(aes(xmin = ndmean_syn-ndSE_syn, xmax=ndmean_syn+ndSE_syn), height = 0.1) + #add standard error bars
  scale_color_manual(values = colors) + 
  ylab("Stability") + xlab("Synchrony (ND)") +  
  theme(legend.title = element_text(size=12)) +  theme(text = element_text(size = 14)) #change font sizes

domstab <- ggplot(meanstab_mech_all, aes(x=mean_dom, y=mean_st, color = date)) +
  geom_point(size=3) +
  geom_errorbar(aes(ymin = mean_st-SE_st, ymax=mean_st+SE_st), width = 0.01) +
  geom_errorbarh(aes(xmin = mean_dom-SE_dom, xmax=mean_dom+SE_dom), height = 0.1) + #add standard error bars
  scale_color_manual(values = colors) + 
  ylab("Stability") + xlab("Dominance") +  
  theme(legend.title = element_text(size=12)) +  theme(text = element_text(size = 14)) #change font sizes

richstab <- ggplot(meanstab_mech_all, aes(x=mean_rich, y=mean_st, color = date)) +
  geom_point(size=3) +
  geom_errorbar(aes(ymin = mean_st-SE_st, ymax=mean_st+SE_st), width = 0.01) +
  geom_errorbarh(aes(xmin = mean_rich-SE_rich, xmax=mean_rich+SE_rich), height = 0.1) + #add standard error bars
  scale_color_manual(values = colors) + 
  ylab("Stability") + xlab("Richness") +  
  theme(legend.title = element_text(size=12)) +  theme(text = element_text(size = 14)) #change font sizes

ggarrange(synstab, b5synstab, ndsynstab, domstab, richstab,
          ncol = 3, nrow = 2,
          align = "hv",
          labels = "AUTO",
          common.legend = TRUE)

```



## Mechanisms Poster Figure
```{r, echo = FALSE, fig.width=12, fig.height=3.5}
psynstab <- ggplot(meanstab_mech, aes(x=mean_syn, y=mean_st)) +
  geom_errorbar(aes(ymin = mean_st-SE_st, ymax=mean_st+SE_st), width = 0.01) +
  geom_errorbarh(aes(xmin = mean_syn-SE_syn, xmax=mean_syn+SE_syn), height = 0.1) + #add standard error bars
  #scale_color_manual(values = colors) + 
  geom_point(aes(fill=TREATMENT), 
       colour="black",pch=21, size=4) +
  scale_fill_scico_d(palette = "batlow", direction = -1) +
  ylab("Stability") + xlab("Synchrony: All Sp.") +  
  theme(legend.title = element_text(size=14)) +  theme(text = element_text(size = 16))  + #change font sizes
  geom_abline(slope = -10.8462, intercept = 5.6445) +
  labs(col = "Treatment")

pb5synstab <- ggplot(meanstab_mech, aes(x=b5mean_syn, y=mean_st)) +
  geom_errorbar(aes(ymin = mean_st-SE_st, ymax=mean_st+SE_st), width = 0.01) +
  geom_errorbarh(aes(xmin = b5mean_syn-b5SE_syn, xmax=b5mean_syn+b5SE_syn), height = 0.1) + #add standard error bars
  geom_point(aes(fill=TREATMENT), 
       colour="black",pch=21, size=4) +
  scale_fill_scico_d(palette = "batlow", direction = -1) +
  ylab("Stability") + xlab("Synchrony: Dominant Sp") +  
  theme(legend.title = element_text(size=14)) +  theme(text = element_text(size = 16)) + #change font sizes 
  labs(col = "Treatment")

pdomstab <- ggplot(meanstab_mech, aes(x=mean_dom, y=mean_st)) +
  geom_errorbar(aes(ymin = mean_st-SE_st, ymax=mean_st+SE_st), width = 0.01) +
  geom_errorbarh(aes(xmin = mean_dom-SE_dom, xmax=mean_dom+SE_dom), height = 0.1) + #add standard error bars
  geom_point(aes(fill=TREATMENT), 
       colour="black",pch=21, size=4) +
  scale_fill_scico_d(palette = "batlow", direction = -1) +  ylab("Stability") + xlab("Dominance") +  
  theme(legend.title = element_text(size=14)) +  theme(text = element_text(size = 16)) + #change font sizes
  labs(col = "Treatment")

prichstab <- ggplot(meanstab_mech, aes(x=mean_rich, y=mean_st)) +
  geom_errorbar(aes(ymin = mean_st-SE_st, ymax=mean_st+SE_st), width = 0.01) +
  geom_errorbarh(aes(xmin = mean_rich-SE_rich, xmax=mean_rich+SE_rich), height = 0.1) + #add standard error bars
  geom_point(aes(fill=TREATMENT), 
       colour="black",pch=21, size=4) +
  scale_fill_scico_d(palette = "batlow", direction = -1) +  ylab("Stability") + xlab("Richness") +  
  theme(legend.title = element_text(size=14)) +  theme(text = element_text(size = 16))  + #change font sizes
    labs(col = "Treatment")


ggarrange(psynstab, pb5synstab, pdomstab, prichstab,
          ncol = 4, nrow = 1,
          align = "hv",
          labels = "AUTO",
          common.legend = TRUE, 
          legend = "none")

ggarrange(psynstab, pb5synstab, pdomstab, prichstab,
          ncol = 4, nrow = 1,
          align = "hv",
          labels = "AUTO",
          common.legend = TRUE, 
          legend = "right")
```

```{r, fig.width=9, fig.height=3.5}

ggarrange(psynstab, pdomstab, prichstab, 
          ncol = 3, nrow = 1,
          align = "hv",
          labels = "AUTO",
          common.legend = TRUE, 
          legend = "none")

ggarrange(psynstab, pdomstab, prichstab, 
          ncol = 3, nrow = 1,
          align = "hv",
          labels = "AUTO",
          common.legend = TRUE, 
          legend = "bottom")

```




## Variance difference by time period
```{r, echo=FALSE, fig.width=8, fig.height=4}
domvar <- ggplot(meanstab_mech_all, aes(x=TREATMENT, y=mean_vardom, color = date)) +
  geom_point(size = 3) +
  geom_errorbar(aes(ymin = mean_vardom-SE_vardom, ymax = mean_vardom+SE_vardom), width = 0.2)+
  ylab("Variance of BP Dominance through Time") + xlab("") +
  scale_color_manual(values = colors)

richvar <- ggplot(meanstab_mech_all, aes(x=TREATMENT, y=mean_varrich, color = date)) +
  geom_point(size = 3) +
  geom_errorbar(aes(ymin = mean_varrich-SE_varrich, ymax = mean_varrich+SE_varrich), width = 0.2)+
  ylab("Variance of Richness through Time") + xlab("") +
  scale_color_manual(values = colors)

ggarrange(dom, rich, ncol = 2, align = "hv", 
          common.legend = TRUE)
```

```{r, echo=FALSE}
ggplot(meantsVR, aes(x=TREATMENT, y=meanVR, color = VR_type)) +
  geom_point(size = 4) +
  geom_errorbar(aes(ymin = meanVR-SEVR, ymax=meanVR+SEVR), width = 0.2) +
  geom_hline(yintercept = 1, linetype = "dashed") +
  scale_color_manual(values = c("#117733", "#332288", "#AA4499")) +
  ylab("Timescale Specific Variance Ratio") + xlab("")


#88CCEE,#CC6677,#DDCC77,#117733,#332288,#AA4499,#44AA99,#999933,#882255,#661100,#6699CC,#888888
```







## Figure S3: Dominance over time
```{r, echo=FALSE, fig.align='center', fig.height=4, fig.width=6}
## Graph dominance over time
ggplot(BP_dominance, aes(x=Date_final, y=BP_dominance, col=TREATMENT)) +
  geom_line(size = 0.5) +
  ylab("Berger-Parker Dominance") + xlab("Date") +
  scale_color_manual(values = green_scale) +
  theme(legend.title = element_text(size=15)) +
  theme(text = element_text(size = 16)) +
  labs(col = "Treatment") #change legend title
```