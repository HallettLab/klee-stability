---
title: "Top-Down effects and Temporal dynamics"
author: "Carmen Ebel"
date: "9/23/2021"
output: html_document
---

## Load Data
```{r setup, echo=FALSE}
setwd("~/Repositories/klee-stability")

## Load packages
library(tidyverse)
library(vegan)
library(forcats)
library(lubridate)
library(codyn)
library(ggpubr)
library(lme4)
library(nlme)
library(emmeans)
library(car)
library(MuMIn)
library(scico)
library(tsvr)
library(knitr)
library(data.table)
library(segmented)
library(breakpoint)
library(ggrepel)
library(lme4)

## source cleaned data
source("klee_allyears_cleaning.R")

ppt <- read.csv("drought_record.csv")

klee_annual <- klee_annual %>%
  mutate(TREATMENT = fct_relevel(TREATMENT, "O", "W", "MW", "C", "WC", "MWC")) #reorder treatments

klee_annual$Date_numeric <- as.numeric(klee_annual$Date_numeric)
```

# Calculations
## Calculate Stability
```{r, echo=FALSE}
## Calculate Community Stability for all years
commstab <- community_stability(klee_annual, 
                                time.var = "Date_numeric", 
                                abundance.var = "Pin_Hits", 
                                replicate.var = "Unique_ID")

## Calculate Variance of the full community
v <- klee_annual %>%
  group_by(TREATMENT, Unique_ID) %>%
  summarise(variance = var(Pin_Hits))

## Calculate Total Cover
pinhits <- totcov %>% #this dataframe used in models
  group_by(TREATMENT, Unique_ID) %>%
  summarize(pinhits = mean(totcov))


## join stability measures with treatment info & calculate CV
tstab <- left_join(commstab, treats, by = "Unique_ID") %>% #join comm stability with treatment info
  mutate(CV = 1/stability) #calculate the CV as inverse of stability

variance <- left_join(v, pinhits, by = c("TREATMENT", "Unique_ID"))

stability <- left_join(tstab, variance, by = c("TREATMENT", "Unique_ID"))

rm(list = c("v", "commstab", "variance", "tstab"))
```

## Calculate TSVR
### for full community
```{r,  echo=FALSE}
## Calculate Timescale Specific VR ##
#set up data frame to put tsvr into
outnames <- c("Unique_ID", "TREATMENT", "classicVR", "longVR", "shortVR") #column names
siteout <- as.data.frame(matrix(nrow=0, ncol = 5)) #make empty dataframe
names(siteout) <- outnames #set names for empty dataframe
plots <- unique(klee_annual$Unique_ID) #make vector of unique plots

## Use for loop to calculate TSVR for each plot
for (i in 1:length(plots)) {
  
  #subset by replicate (gives all observations from one plot over time)
  plot <- subset(klee_annual, Unique_ID == plots[i]) %>%
    tbl_df()
  
  #select species and fill 0's 
  plot2 <- plot %>%
    select(Date_numeric, SPECIES, Pin_Hits) %>% #selecting only these three columns
    spread(SPECIES, Pin_Hits, fill = 0) #changing to wide format
  
  #transpose the data 
  dat <- t(as.matrix(plot2[,2:dim(plot2)[2]]))
  
  #create a dataframe with replicate info to attach VR metrics to
  VR_plots <- plot %>%
    select(Unique_ID, TREATMENT, BLOCK) %>%
    unique()
  
  #calculate classic VR
  res0 <- vreq_classic(dat)
  VR_plots$classicVR <- res0[[3]] #extracting classic VR
  
  #calculate tsvr 
  res <- tsvreq_classic(dat)
  
  #aggregate short vs. long variance ratios
  resLong <- aggts(res, res$ts[res$ts>=4]) #grabbing tsvr with time period >= 4 years
  resShort <- aggts(res, res$ts[res$ts<4]) #grabbing tsvr with time period <4 years
  
  #attach short & long variance ratios
  VR_plots$longVR <- resLong[[3]]
  VR_plots$shortVR <- resShort[[3]]
  
  #append to external dataframe
  siteout<-rbind(siteout, VR_plots)
}

#rename data frame
tsVR <- siteout #%>%
 # mutate(community_type = "All_Species")

## Calculate the mean and standard error of VR metrics
meantsVR <- tsVR %>%
  pivot_longer(cols = classicVR:shortVR, names_to = "VR_type", values_to = "VR_value" ) %>% #change to long format
  group_by(TREATMENT, VR_type) %>%
  summarise(meanVR = mean(VR_value), SEVR = calcSE(VR_value))

#reorder treatments to match grazing pressure.
meantsVR$TREATMENT <- as.factor(meantsVR$TREATMENT) #change treatment to factor
meantsVR$TREATMENT <- factor(meantsVR$TREATMENT, levels = c("O", "W",  "MW",  "C", "WC", "MWC"))
```

### for dominant 5 species
```{r,  echo=FALSE}
## Calculate Timescale Specific VR ##
#set up data frame to put tsvr into
b5outnames <- c("Unique_ID", "TREATMENT", "classicVR", "longVR", "shortVR") #column names
b5siteout <- as.data.frame(matrix(nrow=0, ncol = 5)) #make empty dataframe
names(b5siteout) <- b5outnames #set names for empty dataframe
b5plots <- unique(big5annual$Unique_ID) #make vector of unique plots

## Use for loop to calculate TSVR for each plot
for (i in 1:length(b5plots)) {
  
  #subset by replicate (gives all observations from one plot over time)
  plot <- subset(big5annual, Unique_ID == b5plots[i]) %>%
    tbl_df()
  
  #select species and fill 0's 
  plot2 <- plot %>%
    select(Date_numeric, SPECIES, Pin_Hits) %>% #selecting only these three columns
    spread(SPECIES, Pin_Hits, fill = 0) #changing to wide format
  
  #transpose the data 
  dat <- t(as.matrix(plot2[,2:dim(plot2)[2]]))
  
  #create a dataframe with replicate info to attach VR metrics to
  VR_plots <- plot %>%
    select(Unique_ID, TREATMENT, BLOCK) %>%
    unique()
  
  #calculate classic VR
  res0 <- vreq_classic(dat)
  VR_plots$b5classicVR <- res0[[3]] #extracting classic VR
  
  #calculate tsvr 
  res <- tsvreq_classic(dat)
  
  #aggregate short vs. long variance ratios
  resLong <- aggts(res, res$ts[res$ts>=4]) #grabbing tsvr with time period >= 4 years
  resShort <- aggts(res, res$ts[res$ts<4]) #grabbing tsvr with time period <4 years
  
  #attach short & long variance ratios
  VR_plots$b5longVR <- resLong[[3]]
  VR_plots$b5shortVR <- resShort[[3]]
  
  #append to external dataframe
  b5siteout<-rbind(b5siteout, VR_plots)
}

#rename data frame
b5tsVR <- b5siteout #%>%
 # mutate(community_type = "Dominant")


## Calculate the mean and standard error of VR metrics
b5meantsVR <- b5tsVR %>%
  pivot_longer(cols = b5classicVR:b5shortVR, names_to = "VR_type", values_to = "VR_value" ) %>% #change to long format
  group_by(TREATMENT, VR_type) %>%
  summarise(meanVR = mean(VR_value), SEVR = calcSE(VR_value))

#reorder treatments to match grazing pressure.
b5meantsVR$TREATMENT <- as.factor(b5meantsVR$TREATMENT) #change treatment to factor
b5meantsVR$TREATMENT <- factor(b5meantsVR$TREATMENT, levels = c("O", "W",  "MW",  "C", "WC", "MWC"))
```


## Calculate Dominance
```{r, echo=FALSE}
## Full Time Series
## calculate Berger-Parker Dominance for each unique ID at each date
BP_dominance <- klee_annual %>%
  group_by(TREATMENT, Unique_ID, Date_final) %>% #group by treatment, plot, and date
  mutate(rank = rank(Pin_Hits, na.last = NA, ties.method = "average")) %>% #rank species in order of abundance
  mutate(tot_abund = sum(Pin_Hits)) %>% #create column for total abundance in each plot
  filter(rank == max(rank)) %>% #only include most abundant species in each plot
  summarise(BP_dominance = Pin_Hits/tot_abund) %>% #calculate Berger-Parker dominance index
  mutate(date = "all")

## Calculate the mean Berger-Parker dominance by: 
  ## TREATMENT and UNIQUE ID - to use eventually for linear models
meanplot_BPdom <- BP_dominance %>%
  group_by(TREATMENT, Unique_ID) %>%
  summarize(mean_dom = mean(BP_dominance), SEdom = calcSE(BP_dominance), vardom = var(BP_dominance),
            CVdom = mean_dom/sd(BP_dominance))

dominance <- BP_dominance %>%
  group_by(TREATMENT, Date_final) %>%
  summarize(mean_dom = mean(BP_dominance), SE_dom = calcSE(BP_dominance))
```

## Calculate Dominant species Pop Stability
```{r, echo=FALSE}
## Calculate population stability of individual dominant species
dompopstab <- big5annual %>%
    group_by(TREATMENT, Unique_ID, SPECIES) %>%
    summarise(temp_mean = mean(Pin_Hits), sdhits = sd(Pin_Hits), sp_stability = temp_mean/sdhits) 

meandompopstab <- dompopstab %>%
    #ungroup() %>%
    group_by(TREATMENT, SPECIES) %>%
    summarise(popstability = mean(sp_stability), SEpop = calcSE(sp_stability)) #%>%

dompopstab$TREATMENT <- as.factor(dompopstab$TREATMENT)

dompopstab <- dompopstab %>%
  mutate(TREATMENT = fct_relevel(TREATMENT, "O", "W", "MW", "C", "WC", "MWC"))


## Calculate aggregate stability of dominant 5 species
## Calculate Community Stability for all years
domsp_agg_stab <- community_stability(big5annual, 
                                time.var = "Date_numeric", 
                                abundance.var = "Pin_Hits", 
                                replicate.var = "Unique_ID")

colnames(domsp_agg_stab) <- c("Unique_ID", "Domsp_stability")

## I don't think this is the right way to do this... this is then just looking at does the stability of a subset of the community correlate with the stability of the full community - which is highly likely especially if picking the most abundant species... 


## Could try the average population stability of dominant species or pick the most dominant species across the time series

## Average population stability of dominant species
meanpopstab <- dompopstab %>%
  group_by(TREATMENT, Unique_ID) %>%
  summarize(meanpopstab = mean(sp_stability))
```

## Calculate Richness
```{r, echo = FALSE}
## Calculate species richness for each plot at each point in time
rich <- klee_annual %>%
  group_by(TREATMENT, Unique_ID, Date_final) %>% ## group by each plot at each date
  summarise(richness = n())
  ## use this dataframe for the ANOVA?

## Calculate the mean richness by: 
  ## TREATMENT and DATE
meanannrich <- rich %>%
  group_by(TREATMENT, Date_final) %>%
  summarise(meanrich = mean(richness), SErich = calcSE(richness)) %>%
  mutate(date = "all")
  ## TREATMENT and UNIQUE_ID
meanrichplot <- rich %>%
  group_by(TREATMENT, Unique_ID) %>%
  summarise(meanrich = mean(richness, SErich = calcSE(richness)), varrich = var(richness), 
            CVrich = (meanrich/sd(richness))) 

## BIG 5 SPECIES 
## Calculate species richness for each plot at each point in time
big5rich <- big5annual %>%
  group_by(TREATMENT, Unique_ID, Date_final) %>% ## group by each plot at each date
  summarise(richness = n())

## Calculate the mean richness by: 
  ## TREATMENT and DATE
big5meanannrich <- big5rich %>%
  group_by(TREATMENT, Date_final) %>%
  summarise(meanrich = mean(richness), SErich = calcSE(richness))
  ## TREATMENT and UNIQUE_ID
big5meanrichplot <- big5rich %>%
  group_by(TREATMENT, Unique_ID) %>%
  summarise(meanrich = mean(richness, SErich = calcSE(richness)), varrich = var(richness))

## NON-DOMINANT SPECIES
## Calculate species richness for each plot at each point in time
nondomrich <- nondom %>%
  group_by(TREATMENT, Unique_ID, Date_final) %>% ## group by each plot at each date
  summarise(richness = n())

## Calculate the mean richness by: 
  ## TREATMENT and DATE
nondommeanannrich <- nondomrich %>%
  group_by(TREATMENT, Date_final) %>%
  summarise(meanrich = mean(richness), SErich = calcSE(richness))
  ## TREATMENT and UNIQUE_ID
nondommeanrichplot <- nondomrich %>%
  group_by(TREATMENT, Unique_ID) %>%
  summarise(meanrich = mean(richness, SErich = calcSE(richness)), varrich = var(richness))
```

## Create combined Stability & Mechanisms Data Frames
```{r, echo = FALSE}
## ALL YEARS
## Create data frame with one value of stability & mechanisms for each plot
ssdom <- left_join(stability, meanplot_BPdom, by = c("Unique_ID", "TREATMENT"))
tsvrssdom <- left_join(ssdom, tsVR, by = c("Unique_ID", "TREATMENT", "BLOCK"))
b5tsvrdom <- left_join(tsvrssdom, b5tsVR, by = c("Unique_ID", "TREATMENT", "BLOCK"))
domspstsvr <- left_join(b5tsvrdom, meanpopstab, by = c("Unique_ID", "TREATMENT"))
#ndtsvrdom <- left_join(b5tsvrdom, ndtsVR, by = c("Unique_ID", "TREATMENT", "BLOCK"))
stability_mechanisms <- left_join(domspstsvr, meanrichplot, by = c("Unique_ID", "TREATMENT"))

## Create data frame with one value of stability & mechanisms for each treatment
meanstab_mech <- stability_mechanisms %>%
  group_by(TREATMENT) %>%
  summarise(mean_st = mean(stability), SE_st = calcSE(stability), mean_classicVR = mean(classicVR),
            SEclassicVR = calcSE(classicVR), b5meanclassicVR = mean(b5classicVR), 
            SEb5classicVR = calcSE(b5classicVR), SE_dom = calcSE(mean_dom), mean_dom = mean(mean_dom),
            mean_rich = mean(meanrich), SE_rich = calcSE(meanrich), mean_vardom = mean(vardom), 
            SE_vardom = calcSE(vardom), mean_varrich = mean(varrich), SE_varrich = calcSE(varrich),
            mean_CV = mean(CV), SE_CV = calcSE(CV), meanlongVR = mean(longVR), SElVR = calcSE(longVR),
            meanshortVR = mean(shortVR), SEsVR = calcSE(shortVR), b5meanlongVR = mean(b5longVR), 
            SEb5lVR = calcSE(b5longVR), b5meanshortVR = mean(b5shortVR), SEb5sVR = calcSE(b5shortVR),
            meanCV_dom = mean(CVdom), SECV_dom = calcSE(CVdom), meanCV_rich = mean(CVrich), 
            SECV_rich = calcSE(CVrich), avgpopstab = mean(meanpopstab), 
            SEpopstab = calcSE(meanpopstab), mean_bio = mean(pinhits), SE_bio = calcSE(pinhits),
            mean_var = mean(variance), SE_var = calcSE(variance)) %>%
  mutate(TREATMENT = fct_relevel(TREATMENT, "O", "W", "MW", "C", "WC", "MWC")) #reorder treatments

## clean up environment
rm(list = c("ssdom",  "tsvrssdom", "b5tsvrdom", "domspstsvr"))


## create cows & wildlife columns 
stability_mechanisms$cows <- 0
stability_mechanisms$cows[stability_mechanisms$TREATMENT %in% c('C','WC', 'MWC')] <- 1
stability_mechanisms$cows <- factor(stability_mechanisms$cows)

stability_mechanisms$wildlife <- 0
stability_mechanisms$wildlife[stability_mechanisms$TREATMENT %in% c('W','WC','MW','MWC')] <- 1
#stability_mechanisms$wildlife[stability_mechanisms$TREATMENT %in% c('MW','MWC')] <- 2
stability_mechanisms$wildlife <- factor(stability_mechanisms$wildlife)

stability_mechanisms$mega <- 0
stability_mechanisms$mega[stability_mechanisms$TREATMENT %in% c('MW','MWC')] <- 1
stability_mechanisms$mega <- factor(stability_mechanisms$mega)

write.csv(stability_mechanisms, "stability_mechanisms.csv")
write.csv(meanstab_mech, "mean_stability_mech.csv")
```


# Significance Testing

## Models for Stability, Total Cover, & Variance with Cow vs. Wildlife split
```{r}
## MODELS for FIGURE 1 ##
## how is stability predicted by varying groups of herbivores?
fitsth <- lmer(stability~cows+wildlife+mega + (1|BLOCK), data = stability_mechanisms, na.action = "na.fail")
summary(fitsth)
fitsth
dredge(fitsth)

## best fitting model for stability
fitsth_best <- lmer(stability~cows+wildlife + (1|BLOCK), data = stability_mechanisms, na.action = "na.fail")
summary(fitsth_best)



## how is total cover predicted by varying groups of herbivores?
fittch <- lmer(pinhits~cows+wildlife+mega + (1|BLOCK), data = stability_mechanisms, na.action = "na.fail")
summary(fittch)
fittch
dredge(fittch)

## how is variance predicted by varying groups of herbivores?
fitvarh <- lmer(variance~cows+wildlife+mega + (1|BLOCK), data = stability_mechanisms, na.action = "na.fail")
summary(fitvarh)
fitvarh
dredge(fitvarh)
```


## Models for Biotic Mechanisms with Cow vs. Wildlife split
```{r}
## how is the variance ratio predicted by varying groups of herbivores?
fitcvrh <- lmer(classicVR~cows+wildlife+mega + (1|BLOCK), data = stability_mechanisms, na.action = "na.fail")
summary(fitcvrh)
fitcvrh
dredge(fitcvrh)

fitcvr_best <- lmer(classicVR~cows+mega + (1|BLOCK), data = stability_mechanisms, na.action = "na.fail")
summary(fitcvr_best)


## how is dominant species population stability predicted by varying groups of herbivores?
fitdpsh <- lmer(meanpopstab~cows+wildlife+mega + (1|BLOCK), data = stability_mechanisms, na.action = "na.fail")
summary(fitdpsh)
fitdpsh
dredge(fitdpsh)

fitdpsh_best <- lmer(meanpopstab~1 + (1|BLOCK), data = stability_mechanisms, na.action = "na.fail")
summary(fitdpsh_best)


## how is richness predicted by varying groups of herbivores?
fitrih <- lmer(meanrich~cows+wildlife+mega + (1|BLOCK), data = stability_mechanisms, na.action = "na.fail")
summary(fitrih)
fitrih
dredge(fitrih)

fitrih_best <- lmer(meanrich~wildlife + (1|BLOCK), data = stability_mechanisms, na.action = "na.fail")
summary(fitrih_best)
```


## Mixed Effects Models for Stability vs Mechanisms
```{r}
## Stability vs. Mechanisms model 

## Check whether any factors are highly correlated (above 0.7 wouldn't put in a multiple regression together)

## Test Correlations b/w variables
cor.test(stability_mechanisms$meanpopstab, stability_mechanisms$classicVR)
## - 0.14

cor.test(stability_mechanisms$meanrich, stability_mechanisms$classicVR)
## 0.25

cor.test(stability_mechanisms$meanrich, stability_mechanisms$meanpopstab)
## -0.21


## Model with all 3 stability mechanisms included as predictors
fitstabmech <- lmer(stability~meanrich+classicVR+meanpopstab +(1|BLOCK), data = stability_mechanisms, na.action = "na.fail")
summary(fitstabmech)
dredge(fitstabmech)

## test again to see if any of the predictors are highly correlated using the variance inflation factor
vif(fitstabmech)
## reasonably low vif values


fitstabmech_best <- lmer(stability~classicVR + meanpopstab + (1|BLOCK), data = stability_mechanisms, na.action = "na.fail")

summary(fitstabmech_best)

```




# Figure Settings
```{r, echo=FALSE, include=FALSE}
green_scale <- c("#97e196", "#6cc08b", "#4c9b82", "#217a79", "#105965", "#074050") #make a vector of colors
colors <- c("#88CCEE", "#CC6677","#DDCC77","#117733","#332288","#AA4499","#44AA99","#999933","#882255","#661100","#6699CC","#888888")
theme_set(theme_classic()) #set the theme
```

# Figures
## Average Mech figures
### Figure 1: Stability, Mean Pin Hits, and Variance
```{r, fig.width =12, fig.height=4, echo=FALSE}
#graph the mean variance by treatment
v <- ggplot(meanstab_mech, aes(x=TREATMENT, y=mean_var)) +
  geom_point(size=4) +
  geom_errorbar(aes(ymin = mean_var-SE_var, ymax = mean_var+SE_var), width=0.25) +
  ylab("Temporal Variance") + xlab("") + 
 # annotate("text", x =1, y=23500, label = "a", size = 5) + ## O
 # annotate("text", x =2, y=19800, label = "ab", size = 5) + ## W
 # annotate("text", x =3, y=17500, label = "abc", size = 5) + ## MW
 # annotate("text", x =4, y=16000, label = "bc", size = 5) + ## C
 # annotate("text", x =5, y=11800, label = "c", size = 5) + ## WC
 # annotate("text", x =6, y=12500, label = "c", size = 5) + ## MWC
  theme(text = element_text(size = 16)) #change font size


#graph the mean total pin hits by treatment
b <- ggplot(meanstab_mech, aes(x=TREATMENT, y=mean_bio)) +
  geom_point(size=4) +
  geom_errorbar(aes(ymin=mean_bio-SE_bio, ymax=mean_bio+SE_bio), width = 0.2) + #include standard error bars
  ylab("Total Cover (Pin Hits)") + xlab("Treatment") +
 # annotate("text", x =1, y=1420, label = "a", size = 5) + ## O
 # annotate("text", x =2, y=1367, label = "ab", size = 5) + ## W
 # annotate("text", x =3, y=1310, label = "bc", size = 5) + ## MW
 # annotate("text", x =4, y=1210, label = "cd", size = 5) + ## C
 # annotate("text", x =5, y=1110, label = "d", size = 5) + ## WC
 # annotate("text", x =6, y=1175, label = "d", size = 5) + ## MWC
  theme(text = element_text(size = 16)) #change font size


## visualize mean stability & standard error
s <- ggplot(meanstab_mech, aes(x=TREATMENT, y=mean_st)) +
  geom_point(size=4) +
  geom_errorbar(aes(ymin = mean_st-SE_st, ymax=mean_st+SE_st), width = 0.2) + #add standard error bars
  ylab("Stability (mean/sd)") + xlab("") + #label axes
 # annotate("text", x =1, y=4.75, label = "a", size = 5) + ## O
 # annotate("text", x =2, y=4.5, label = "a", size = 5) + ## W
 # annotate("text", x =3, y=3.9, label = "b", size = 5) + ## MW
 # annotate("text", x =4, y=3.95, label = "bc", size = 5) + ## C
 # annotate("text", x =5, y=3.2, label = "c", size = 5) + ## WC
 # annotate("text", x =6, y=3.3, label = "c", size = 5) + ## MWC
  theme(text = element_text(size = 16)) #change font size

## plot 3 panel figure of stability, total pin hits, and temporal variance
ggarrange(s, b, v, 
          labels = "AUTO",
          ncol = 3, nrow = 1, 
          align = "hv")
```

### Make Stability & Mechanisms Figs
```{r, echo=FALSE, fig.height=4, fig.width=8}
## combine both VR dataframes into one in order to put all in the same panel
colnames(b5tsVR) <- c("Unique_ID", "TREATMENT", "BLOCK", "classicVR", "longVR", "shortVR")

## add column to differentiate community type
big5tsVR <- b5tsVR %>% 
  mutate(community_type = "Dominant") 
alltsVR <- tsVR %>% 
  mutate(community_type = "All Species")

## join data frames
tsVRalldom <- rbind(big5tsVR, alltsVR)

## set treatment as a factor
tsVRalldom$TREATMENT <- as.factor(tsVRalldom$TREATMENT)

## make one data frame with means calculated for graphing
tsVR_plot <- tsVRalldom %>%
  group_by(TREATMENT, community_type) %>%
  summarise(mean_cVR = mean(classicVR), SE_cVR = calcSE(classicVR), mean_lVR = mean(longVR), SE_lVR = calcSE(longVR), mean_sVR = mean(shortVR), SE_sVR = calcSE(shortVR)) %>%
  mutate(TREATMENT = fct_relevel(TREATMENT, "O", "W", "MW", "C", "WC", "MWC")) #reorder treatments

write.csv(tsVR_plot, "VR_plotting.csv")


## VR by herbivory
VRtrt <- ggplot(tsVR_plot, aes(x=TREATMENT, y=mean_cVR, fill = TREATMENT, shape = community_type, color = TREATMENT)) +
  geom_hline(yintercept = 1, linetype = "dashed") +
  geom_errorbar(aes(ymin = mean_cVR-SE_cVR, ymax=mean_cVR+SE_cVR), width = 0.2, color = "black") +
  geom_point(size = 4) +
  geom_point(size = 4, fill = NA, colour = "black") +
  scale_shape_manual(values = c(21,22,18)) +
  scale_fill_scico_d(palette = "batlow", direction = -1) +
  theme(legend.title = element_text(size=14)) +  theme(text = element_text(size = 14)) + #change font sizes
  xlab("") + ylab("Variance Ratio") +
  #theme(axis.text.x = element_text(angle = 30, hjust = 1)) +
  #labs(shape = "Community Type", color = "Treatment") +
  scale_color_scico_d(palette = "batlow", direction = -1) +
  guides(color=guide_legend("Treatment"), fill = FALSE, shape =guide_legend("Species"))# +
  
 # annotate("text", x =1, y=1.2, label = "a", size = 5) + ## O
 # annotate("text", x =2, y=1.2, label = "ab", size = 5) + ## W
 # annotate("text", x =3, y=1.7, label = "b", size = 5) + ## MW
 # annotate("text", x =4, y=1.5, label = "abc", size = 5) + ## C
 # annotate("text", x =5, y=2.1, label = "cd", size = 5) + ## WC
 # annotate("text", x =6, y=2.3, label = "d", size = 5) + ## MWC
 # theme(text = element_text(size = 16)) + #change font size
  
 # annotate("text", x =1, y=0.39, label = "a", size = 5) + ## O
 # annotate("text", x =2, y=0.43, label = "a", size = 5) + ## W
 # annotate("text", x =3, y=0.76, label = "a", size = 5) + ## MW
#  annotate("text", x =4, y=0.66, label = "a", size = 5) + ## C
#  annotate("text", x =5, y=1.1, label = "b", size = 5) + ## WC
#  annotate("text", x =6, y=1.3, label = "b", size = 5) ## MWC



## aggregate dom sp stability by herbivore
pdomspstab <- ggplot(meanstab_mech, aes(x=TREATMENT, y=avgpopstab)) +
  geom_errorbar(aes(ymin = avgpopstab-SEpopstab, ymax=avgpopstab+SEpopstab), width = 0.3) +
  geom_point(aes(fill=TREATMENT), 
       colour="black",pch=22, size=4) + 
  scale_fill_scico_d(palette = "batlow", direction = -1) +
  ylab("Dominant Sp Stability") + xlab("") +  
  theme(legend.title = element_text(size=14)) +  theme(text = element_text(size = 14))#+
 # annotate("text", x =1, y=2.43, label = "a", size = 5) + ## O
 # annotate("text", x =2, y=2.05, label = "a", size = 5) + ## W
 # annotate("text", x =3, y=2.15, label = "a", size = 5) + ## MW
 # annotate("text", x =4, y=2, label = "a", size = 5) + ## C
 # annotate("text", x =5, y=1.9, label = "a", size = 5) + ## WC
 # annotate("text", x =6, y=2.05, label = "a", size = 5) #+ ## MWC
 # theme(text = element_text(size = 16)) #change font size
## No differences explained by treatment here


## richness by herbivory
prich <- ggplot(meanstab_mech, aes(x=TREATMENT , y=mean_rich)) +
  geom_errorbar(aes(ymin = mean_rich-SE_rich, ymax=mean_rich+SE_rich), width = 0.3) +
  geom_point(aes(fill=TREATMENT), 
       colour="black",pch=21, size=4) +
  scale_fill_scico_d(palette = "batlow", direction = -1) +
  ylab("Richness") + xlab("") +  
  theme(legend.title = element_text(size=14)) +  theme(text = element_text(size = 14)) + #change font sizes
  labs(col = "Time Period") #+ 
 # annotate("text", x =1, y=20.2, label = "a", size = 5) + ## O
 # annotate("text", x =2, y=21.7, label = "a", size = 5) + ## W
 # annotate("text", x =3, y=20.9, label = "a", size = 5) + ## MW
 # annotate("text", x =4, y=20.28, label = "a", size = 5) + ## C
 # annotate("text", x =5, y=21.3, label = "a", size = 5) + ## WC
 # annotate("text", x =6, y=21.9, label = "a", size = 5) #+ ## MWC
  #theme(text = element_text(size = 16)) #change font size
#+
  #theme(axis.text.x = element_text(angle = 30, hjust = 1))


```

### Figure 2: All Mechanisms & Stability 
#```{r, echo = FALSE, fig.width=10, fig.height=6}
ggarrange(VRtrt, pdomspstab, prich,
          VRstab, domspstabst, prichstab,
          ncol = 3, nrow=2,
          align = "hv",
          labels = "AUTO",
          common.legend = TRUE, 
          legend = "right")
#```

### Figure 4: Mechanisms & Stability
```{r, fig.height=4, fig.width=9.5}
## VR and stability
VRstab <- ggplot(meanstab_mech, aes(x=mean_classicVR, y=mean_st)) +
  geom_smooth(method = "lm", se = FALSE, fullrange = T, color = "black")+
  geom_vline(xintercept = 1, linetype = "dashed") +
  geom_errorbar(aes(ymin = mean_st-SE_st, ymax=mean_st+SE_st), width = 0.06) +
  geom_errorbarh(aes(xmin = mean_classicVR-SEclassicVR, xmax=mean_classicVR+SEclassicVR), height = 0.1) + #add standard error bars
  geom_point(aes(fill=TREATMENT), 
       colour="black",pch=21, size=4) +
  scale_fill_scico_d(palette = "batlow", direction = -1) +
  ylab("Stability") + xlab("Variance Ratio") +  
  theme(legend.title = element_text(size=14)) +  theme(text = element_text(size = 14))  + #change font sizes
  #geom_abline(slope = -10.8462, intercept = 5.6445) +
  labs(col = "Treatment") +
  annotate("text", x =1.07, y=3.3, label = "synchronous", size = 5, angle='90', fontface = 'italic') +
  annotate("text", x =0.9, y=3.3, label = "compensatory", size = 5, angle='90',fontface = 'italic')
  


## Aggregate dominant sp stability by stability
domspstabst <- ggplot(meanstab_mech, aes(x=avgpopstab, y=mean_st)) +
  geom_smooth(method = "lm", se = FALSE, fullrange = T, color = "black") +
  geom_errorbar(aes(ymin = mean_st-SE_st, ymax=mean_st+SE_st), width = 0.06) +
  geom_errorbarh(aes(xmin = avgpopstab-SEpopstab, xmax=avgpopstab+SEpopstab), height = 0.1) + #add standard error bars
  geom_point(aes(fill=TREATMENT), 
       colour="black",pch=22, size=4) +
  scale_fill_scico_d(palette = "batlow", direction = -1) +  ylab("Stability") + xlab("Dominant Sp Stability") +  
  theme(legend.title = element_text(size=14)) +  theme(text = element_text(size = 14)) + #change font sizes
  labs(col = "Treatment") #+

  

## richness and stability
prichstab <- ggplot(meanstab_mech, aes(x=mean_rich, y=mean_st)) +
  geom_errorbar(aes(ymin = mean_st-SE_st, ymax=mean_st+SE_st), width = 0.2) +
  geom_errorbarh(aes(xmin = mean_rich-SE_rich, xmax=mean_rich+SE_rich), height = 0.1) + #add standard error bars
  geom_point(aes(fill=TREATMENT), 
       colour="black",pch=21, size=4) +
  scale_fill_scico_d(palette = "batlow", direction = -1) +  ylab("Stability") + xlab("Richness") +  
  theme(legend.title = element_text(size=14)) +  theme(text = element_text(size = 14))  + #change font sizes
    labs(col = "Treatment")



ggarrange(VRstab, domspstabst, prichstab,
          ncol = 3, nrow=1,
          align = "hv",
          labels = "AUTO",
          common.legend = TRUE, 
           legend = "bottom")
```


## Temporal Dynamics Figures
### Figure 3: TSVR Plot
```{r, echo=FALSE, fig.width=6, fig.height=3.5}
tsvrplot <- meantsVR %>%
  filter(VR_type != "classicVR") 

full <- ggplot(tsvrplot, aes(x=TREATMENT, y=meanVR)) +
  geom_point(size = 2.5) +
  geom_errorbar(aes(ymin = meanVR-SEVR, ymax=meanVR+SEVR), width = 0.4) +
  geom_hline(yintercept = 1, linetype = "dashed") +
  geom_point(aes(fill=VR_type), 
       colour="black",pch=21, size=3.5) +
  scale_fill_manual(values = c("#c8c8c8", "#4f4f4f")) +
  ylab("TSVR full community") + xlab("") +
  coord_cartesian(ylim = c(0.2, 3.75)) +
  labs(fill = "Variance Ratio Type") +
  theme(legend.title = element_text(size=12)) +  theme(text = element_text(size = 14)) #+ #change font sizes
  
  ## long tsvr
  #annotate("text", x =1, y=1.2, label = "a", size = 5) + ## O
 # annotate("text", x =2, y=1.2, label = "a", size = 5) + ## W
 # annotate("text", x =3, y=1.5, label = "ab", size = 5) + ## MW
#  annotate("text", x =4, y=1.5, label = "ab", size = 5) + ## C
 # annotate("text", x =5, y=1.9, label = "bc", size = 5) + ## WC
 # annotate("text", x =6, y=2.1, label = "c", size = 5) + ## MWC

  ## short tsvr 
 # annotate("text", x =1, y=2.1, label = "a", size = 5) + ## O
 # annotate("text", x =2, y=2.9,  label = "ab", size = 5) + ## W
 # annotate("text", x =3, y=3.2, label = "b", size = 5) + ## MW
 # annotate("text", x =4, y=3.2, label = "ab", size = 5) + ## C
 # annotate("text", x =5, y=3.5, label = "b", size = 5) + ## WC
 # annotate("text", x =6, y=3.7, label = "b", size = 5) ## MWC
  
  

b5tsvrplot <- b5meantsVR %>%
  filter(VR_type != "b5classicVR")

b5 <- ggplot(b5tsvrplot, aes(x=TREATMENT, y=meanVR)) +
  geom_point(size = 2.5) +
  geom_errorbar(aes(ymin = meanVR-SEVR, ymax=meanVR+SEVR), width = 0.4) +
  geom_hline(yintercept = 1, linetype = "dashed") +
  geom_point(aes(fill=VR_type), 
       colour="black",pch=22, size=3) +
  scale_fill_manual(values = c("#c8c8c8", "#4f4f4f")) +  
  ylab("TSVR dominant sp") + xlab("") +
  coord_cartesian(ylim = c(0.2, 3.75)) +
  theme(legend.title = element_text(size=12)) +  
  theme(text = element_text(size = 14)) #+ #change font sizes
  
  ## long tsvr
 # annotate("text", x =1, y=1.25, label = "a", size = 5) + ## O
 # annotate("text", x =2, y=1.7, label = "a", size = 5) + ## W
 # annotate("text", x =3, y=2, label = "ab", size = 5) + ## MW
 # annotate("text", x =4, y=1.9, label = "ab", size = 5) + ## C
 # annotate("text", x =5, y=2.3, label = "b", size = 5) + ## WC
 # annotate("text", x =6, y=2.2, label = "b", size = 5) + ## MWC

  ## short tsvr 
 # annotate("text", x =1, y=0.2, label = "a", size = 5) + ## O
 # annotate("text", x =2, y=0.25,  label = "a", size = 5) + ## W
 # annotate("text", x =3, y=0.5, label = "a", size = 5) + ## MW
 # annotate("text", x =4, y=0.5, label = "a", size = 5) + ## C
 # annotate("text", x =5, y=0.85, label = "b", size = 5) + ## WC
 # annotate("text", x =6, y=1.1, label = "b", size = 5) ## MWC

ggarrange(full, b5, 
          ncol= 2, nrow = 1, 
          align = "hv", 
          common.legend = TRUE, 
          labels = "AUTO", 
          legend = "bottom")
```

### Total Cover Over Time
```{r, echo = FALSE, fig.width=9, fig.height=3.5}
meancov <- totcov %>%
  mutate(type = "Full") %>%
  group_by(TREATMENT, Date_final, type) %>%
  summarise(meancov = mean(totcov))

meancov$TREATMENT <- as.factor(meancov$TREATMENT)
meancov <- meancov %>%
  mutate(TREATMENT = fct_relevel(TREATMENT, "O", "W", "MW", "C", "WC", "MWC"))

ppt_date <- ppt %>%
  mutate(Date_final = ymd(sample_date)) %>%
  filter(drought == 1)

## make a vector of all sample dates to use for axis labels
dates <- meancov[['Date_final']]
june <- unique(dates[dates %like% "06-"])

ggplot(meancov, aes(x=Date_final, y=meancov, color = TREATMENT)) +
  geom_vline(data = ppt_date, mapping = aes(xintercept = Date_final), linetype = "dashed") +
  geom_line(size = 1) +
  scale_color_scico_d(palette = "batlow", direction = -1) +
  ylab("Total Cover") + xlab("") +
  scale_x_date(breaks = june, date_labels = "%Y-%m") +
  theme(legend.title = element_text(size=14)) +  theme(text = element_text(size = 14)) +
  labs(col = "Treatment") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

### Cover, Dominance, & Richness over time
```{r, echo=FALSE, fig.align='center', fig.height=4.5, fig.width=7}
tcov_drought <- ggplot(meancov, aes(x=Date_final, y=meancov, color = TREATMENT)) +
  geom_vline(data = ppt_date, mapping = aes(xintercept = Date_final), linetype = "dashed") +
  geom_line(size = 1) +
  scale_color_scico_d(palette = "batlow", direction = -1) +
  ylab("Total Cover") + xlab("") +
  scale_x_date(breaks = june, labels = NULL) +
  theme(legend.title = element_text(size=14)) +  theme(text = element_text(size = 14)) +
  labs(col = "Treatment") 

## Graph dominance over time
domtime <- ggplot(dominance, aes(x=Date_final, y=mean_dom, col=TREATMENT)) +
  geom_vline(data = ppt_date, mapping = aes(xintercept = Date_final), linetype = "dashed") +
  geom_line(size = 0.72) +
  ylab("Dominance") + xlab("") +
  scale_color_scico_d(palette = "batlow", direction = -1) +
  #theme(legend.title = element_text(size=14)) +
  theme(text = element_text(size = 12)) +
  theme(legend.position = "none") +
  scale_x_date(breaks = june, date_labels = "%Y") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
 # scale_x_date(breaks = june, labels = NULL) #+
  #labs(col = "Treatment") #change legend title

## Graph richness over time
richtime <- ggplot(meanannrich, aes(x=Date_final, y=meanrich, col=TREATMENT)) +
  geom_vline(data = ppt_date, mapping = aes(xintercept = Date_final), linetype = "dashed") +
  geom_line(size = 0.72) +
  ylab("Richness") + xlab("") +
  scale_color_scico_d(palette = "batlow", direction = -1) +
  theme(legend.title = element_text(size=14)) +
  theme(text = element_text(size = 14)) +
  scale_x_date(breaks = june, date_labels = "%Y") +
  theme(legend.position = "none") +

  labs(col = "Treatment") + #change legend title
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggarrange(tcov_drought, richtime, ncol = 1, nrow = 2, 
          common.legend = TRUE,
          legend = "right",
          labels = "AUTO", 
          align = "v")
```



### Variance in richness & dominance
```{r, echo=FALSE, fig.height=3, fig.width=7}
domvar <- ggplot(meanstab_mech, aes(x=TREATMENT, y=meanCV_dom)) +
  geom_point(size = 1.5) +
  geom_errorbar(aes(ymin = meanCV_dom-SECV_dom, ymax = meanCV_dom+SECV_dom), width = 0.2)+
  ylab("CV Dominance") + xlab("") +
  geom_point(aes(fill=TREATMENT), 
       colour="black",pch=21, size=3) +
  scale_fill_scico_d(palette = "batlow", direction = -1) +
  theme(legend.position = "none")

richvar <- ggplot(meanstab_mech, aes(x=TREATMENT, y=meanCV_rich)) +
  geom_point(size = 1.5) +
  geom_errorbar(aes(ymin = meanCV_rich-SECV_rich, ymax = meanCV_rich+SECV_rich), width = 0.2)+
  ylab("CV Richness") + xlab("") +
  geom_point(aes(fill=TREATMENT), 
       colour="black",pch=21, size=3) +
  scale_fill_scico_d(palette = "batlow", direction = -1) +
  theme(legend.position = "none")

```

## another temporal dynamics figure
```{r}
library(cowplot)

richvarleg <- ggplot(meanstab_mech, aes(x=TREATMENT, y=mean_varrich)) +
  geom_point(size = 1.5) +
  geom_errorbar(aes(ymin = mean_varrich-SE_varrich, ymax = mean_varrich+SE_varrich), width = 0.2)+
  ylab("Variance: Richness") + xlab("") +
  geom_point(aes(fill=TREATMENT), 
       colour="black",pch=21, size=3) +
  scale_fill_scico_d(palette = "batlow", direction = -1) +
  theme(legend.direction = "horizontal") +
  labs(fill = "Treatment") +
  guides(fill = guide_legend(nrow = 1, byrow = TRUE))


legend <- get_legend(
  richvarleg + theme(legend.box.margin = margin(0,0,0,8))
  )

bottom_row <- plot_grid(richtime, richvar, labels = c('C','D'), rel_widths = c(2,1), align = "h", label_size = 12)
top_row <- plot_grid(domtime, domvar, labels = c('A','B'), rel_widths = c(2,1), align = "h", label_size = 12)



leftcol <- plot_grid(domtime, richtime, labels = c('A', 'C'), ncol = 1, align = "v", label_size = 12)
rightcol <- plot_grid(domvar, richvar, labels = c('B', 'D'), ncol = 1, align = "v", label_size = 12, hjust = 0.1)


plots <- plot_grid(leftcol, rightcol, ncol = 2, rel_widths = c(2.15, 1))

plot_grid(plots, legend, ncol = 1, rel_heights = c(15,1))


```







## Population Stability Figure
#```{r, echo=FALSE, fig.width=6, fig.height=7}
ggplot(dompopstab, aes(x=SPECIES, y=popstability)) +
  geom_point(size = 1) +
  geom_errorbar(aes(ymin = popstability-SEpop, ymax = popstability+SEpop), width = 0.2) +
  geom_point(aes(fill=TREATMENT), 
       colour="black",pch=21, size=4) +
  scale_fill_scico_d(palette = "batlow", direction = -1) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  ylab("Population Stability") + xlab("")
#```

## Dominant Sp Stability & Community Stability
```{r, fig.width=8.5, fig.height=4}
meanstab <- stability %>%
  group_by(TREATMENT) %>%
  summarise(mean_st = mean(stability), SE_st = calcSE(stability))


dompopst_fullst <- left_join(meandompopstab, meanstab, by = "TREATMENT")

dompopst_fullst$TREATMENT <- as.factor(dompopst_fullst$TREATMENT)

dompopst_fullst <- dompopst_fullst %>%
  mutate(TREATMENT = fct_relevel(TREATMENT, "O", "W", "MW", "C", "WC", "MWC")) #reorder treatments

popst_st <- ggplot(dompopst_fullst, aes(x=popstability, y=mean_st)) +
  #geom_point() +
  geom_errorbarh(aes(xmin = popstability - SEpop, xmax = popstability + SEpop), height = 0.25) +
  geom_errorbar(aes(ymin = mean_st - SE_st, ymax = mean_st +SE_st), width = 0.25) +
  facet_wrap(~SPECIES, ncol = 5) +
  xlab("Population Stability") + ylab("Temporal Stability") +
  geom_point(aes(fill=TREATMENT), 
       colour="black",pch=21, size=3) +
  scale_fill_scico_d(palette = "batlow", direction = -1) +
  theme(legend.position = "bottom")

popst_trt <- ggplot(dompopst_fullst, aes(x = TREATMENT, y=popstability)) +
    geom_errorbar(aes(ymin = popstability-SEpop, ymax = popstability + SEpop), width = 0.6) +
  geom_point(aes(fill=TREATMENT), 
       colour="black",pch=21, size=3) +
  scale_fill_scico_d(palette = "batlow", direction = -1) +
  facet_wrap(~SPECIES, ncol = 5) +
  ylab("Population Stability") + xlab("Treatment") +
  theme(legend.position = "bottom")
```

```{r,  fig.width=9.5, fig.height=5}

ggarrange(popst_trt, popst_st, 
          ncol = 1, 
          common.legend = TRUE, 
          legend = "bottom")
  
```


