---
title: "PRC_comp_analysis"
author: "Carmen Ebel"
date: "6/1/2021"
output: html_document
---

## Load Data
```{r setup, echo=FALSE}
setwd("~/Repositories/klee-stability")

## Load packages
library(tidyverse)
library(vegan)
library(forcats)
library(lubridate)
library(codyn)
library(ggpubr)
library(lme4)
library(nlme)
library(emmeans)
library(car)
library(MuMIn)
library(scico)
library(tsvr)
library(knitr)
library(data.table)
library(segmented)
library(breakpoint)
library(ggrepel)
library(lme4)
library(nlme)

## source cleaned data
source("klee_allyears_cleaning.R")

klee_annual <- klee_annual %>%
  mutate(TREATMENT = fct_relevel(TREATMENT, "O", "W", "MW", "C", "WC", "MWC")) #reorder treatments

klee_annual$Date_numeric <- as.numeric(klee_annual$Date_numeric)
```

# Calculations
## Calculate Stability
```{r, echo=FALSE}
## Calculate Community Stability for all years
commstab <- community_stability(klee_annual, 
                                time.var = "Date_numeric", 
                                abundance.var = "Pin_Hits", 
                                replicate.var = "Unique_ID")

## Calculate Variance of the full community
v <- klee_annual %>%
  group_by(TREATMENT, Unique_ID) %>%
  summarise(variance = var(Pin_Hits))

## Calculate Total Cover
pinhits <- totcov %>% #this dataframe used in models
  group_by(TREATMENT, Unique_ID) %>%
  summarize(pinhits = mean(totcov))


## join stability measures with treatment info & calculate CV
tstab <- left_join(commstab, treats, by = "Unique_ID") %>% #join comm stability with treatment info
  mutate(CV = 1/stability) #calculate the CV as inverse of stability

variance <- left_join(v, pinhits, by = c("TREATMENT", "Unique_ID"))

stability <- left_join(tstab, variance, by = c("TREATMENT", "Unique_ID"))

rm(list = c("v", "commstab", "variance", "tstab"))
```

## Calculate Synchrony
```{r, echo = FALSE}
## Calculate Loreau Synchrony metric
synchrony <- synchrony(
  klee_annual,
  time.var = "Date_numeric",
  species.var = "SPECIES",
  abundance.var = "Pin_Hits",
  metric = "Loreau",
  replicate.var = "Unique_ID"
)

big5synchrony <- synchrony(
  big5annual,
  time.var = "Date_numeric",
  species.var = "SPECIES",
  abundance.var = "Pin_Hits",
  metric = "Loreau",
  replicate.var = "Unique_ID"
)

colnames(big5synchrony) <- c("Unique_ID", "big5synchrony")

nondomsynchrony <- synchrony(
  nondom,
  time.var = "Date_numeric",
  species.var = "SPECIES",
  abundance.var = "Pin_Hits",
  metric = "Loreau",
  replicate.var = "Unique_ID"
)
colnames(nondomsynchrony) <- c("Unique_ID", "nondomsynchrony")

```

## Calculate TSVR
### for full community
```{r,  echo=FALSE}
## Calculate Timescale Specific VR ##
#set up data frame to put tsvr into
outnames <- c("Unique_ID", "TREATMENT", "classicVR", "longVR", "shortVR") #column names
siteout <- as.data.frame(matrix(nrow=0, ncol = 5)) #make empty dataframe
names(siteout) <- outnames #set names for empty dataframe
plots <- unique(klee_annual$Unique_ID) #make vector of unique plots

## Use for loop to calculate TSVR for each plot
for (i in 1:length(plots)) {
  
  #subset by replicate (gives all observations from one plot over time)
  plot <- subset(klee_annual, Unique_ID == plots[i]) %>%
    tbl_df()
  
  #select species and fill 0's 
  plot2 <- plot %>%
    select(Date_numeric, SPECIES, Pin_Hits) %>% #selecting only these three columns
    spread(SPECIES, Pin_Hits, fill = 0) #changing to wide format
  
  #transpose the data 
  dat <- t(as.matrix(plot2[,2:dim(plot2)[2]]))
  
  #create a dataframe with replicate info to attach VR metrics to
  VR_plots <- plot %>%
    select(Unique_ID, TREATMENT, BLOCK) %>%
    unique()
  
  #calculate classic VR
  res0 <- vreq_classic(dat)
  VR_plots$classicVR <- res0[[3]] #extracting classic VR
  
  #calculate tsvr 
  res <- tsvreq_classic(dat)
  
  #aggregate short vs. long variance ratios
  resLong <- aggts(res, res$ts[res$ts>=4]) #grabbing tsvr with time period >= 4 years
  resShort <- aggts(res, res$ts[res$ts<4]) #grabbing tsvr with time period <4 years
  
  #attach short & long variance ratios
  VR_plots$longVR <- resLong[[3]]
  VR_plots$shortVR <- resShort[[3]]
  
  #append to external dataframe
  siteout<-rbind(siteout, VR_plots)
}

#rename data frame
tsVR <- siteout #%>%
 # mutate(community_type = "All_Species")

## Calculate the mean and standard error of VR metrics
meantsVR <- tsVR %>%
  pivot_longer(cols = classicVR:shortVR, names_to = "VR_type", values_to = "VR_value" ) %>% #change to long format
  group_by(TREATMENT, VR_type) %>%
  summarise(meanVR = mean(VR_value), SEVR = calcSE(VR_value))

#reorder treatments to match grazing pressure.
meantsVR$TREATMENT <- as.factor(meantsVR$TREATMENT) #change treatment to factor
meantsVR$TREATMENT <- factor(meantsVR$TREATMENT, levels = c("O", "W",  "MW",  "C", "WC", "MWC"))
```

### for dominant 5 species
```{r,  echo=FALSE}
## Calculate Timescale Specific VR ##
#set up data frame to put tsvr into
b5outnames <- c("Unique_ID", "TREATMENT", "classicVR", "longVR", "shortVR") #column names
b5siteout <- as.data.frame(matrix(nrow=0, ncol = 5)) #make empty dataframe
names(b5siteout) <- b5outnames #set names for empty dataframe
b5plots <- unique(big5annual$Unique_ID) #make vector of unique plots

## Use for loop to calculate TSVR for each plot
for (i in 1:length(b5plots)) {
  
  #subset by replicate (gives all observations from one plot over time)
  plot <- subset(big5annual, Unique_ID == b5plots[i]) %>%
    tbl_df()
  
  #select species and fill 0's 
  plot2 <- plot %>%
    select(Date_numeric, SPECIES, Pin_Hits) %>% #selecting only these three columns
    spread(SPECIES, Pin_Hits, fill = 0) #changing to wide format
  
  #transpose the data 
  dat <- t(as.matrix(plot2[,2:dim(plot2)[2]]))
  
  #create a dataframe with replicate info to attach VR metrics to
  VR_plots <- plot %>%
    select(Unique_ID, TREATMENT, BLOCK) %>%
    unique()
  
  #calculate classic VR
  res0 <- vreq_classic(dat)
  VR_plots$b5classicVR <- res0[[3]] #extracting classic VR
  
  #calculate tsvr 
  res <- tsvreq_classic(dat)
  
  #aggregate short vs. long variance ratios
  resLong <- aggts(res, res$ts[res$ts>=4]) #grabbing tsvr with time period >= 4 years
  resShort <- aggts(res, res$ts[res$ts<4]) #grabbing tsvr with time period <4 years
  
  #attach short & long variance ratios
  VR_plots$b5longVR <- resLong[[3]]
  VR_plots$b5shortVR <- resShort[[3]]
  
  #append to external dataframe
  b5siteout<-rbind(b5siteout, VR_plots)
}

#rename data frame
b5tsVR <- b5siteout #%>%
 # mutate(community_type = "Dominant")


## Calculate the mean and standard error of VR metrics
b5meantsVR <- b5tsVR %>%
  pivot_longer(cols = b5classicVR:b5shortVR, names_to = "VR_type", values_to = "VR_value" ) %>% #change to long format
  group_by(TREATMENT, VR_type) %>%
  summarise(meanVR = mean(VR_value), SEVR = calcSE(VR_value))

#reorder treatments to match grazing pressure.
b5meantsVR$TREATMENT <- as.factor(b5meantsVR$TREATMENT) #change treatment to factor
b5meantsVR$TREATMENT <- factor(b5meantsVR$TREATMENT, levels = c("O", "W",  "MW",  "C", "WC", "MWC"))
```

### for subordinate species
```{r,  echo=FALSE}
## Calculate Timescale Specific VR ##
#set up data frame to put tsvr into
ndoutnames <- c("Unique_ID", "TREATMENT", "classicVR", "longVR", "shortVR") #column names
ndsiteout <- as.data.frame(matrix(nrow=0, ncol = 5)) #make empty dataframe
names(ndsiteout) <- ndoutnames #set names for empty dataframe
ndplots <- unique(nondom$Unique_ID) #make vector of unique plots

## Use for loop to calculate TSVR for each plot
for (i in 1:length(ndplots)) {
  
  #subset by replicate (gives all observations from one plot over time)
  plot <- subset(nondom, Unique_ID == ndplots[i]) %>%
    tbl_df()
  
  #select species and fill 0's 
  plot2 <- plot %>%
    select(Date_numeric, SPECIES, Pin_Hits) %>% #selecting only these three columns
    spread(SPECIES, Pin_Hits, fill = 0) #changing to wide format
  
  #transpose the data 
  dat <- t(as.matrix(plot2[,2:dim(plot2)[2]]))
  
  #create a dataframe with replicate info to attach VR metrics to
  VR_plots <- plot %>%
    select(Unique_ID, TREATMENT, BLOCK) %>%
    unique()
  
  #calculate classic VR
  res0 <- vreq_classic(dat)
  VR_plots$ndclassicVR <- res0[[3]] #extracting classic VR
  
  #calculate tsvr 
  res <- tsvreq_classic(dat)
  
  #aggregate short vs. long variance ratios
  resLong <- aggts(res, res$ts[res$ts>=4]) #grabbing tsvr with time period >= 4 years
  resShort <- aggts(res, res$ts[res$ts<4]) #grabbing tsvr with time period <4 years
  
  #attach short & long variance ratios
  VR_plots$ndlongVR <- resLong[[3]]
  VR_plots$ndshortVR <- resShort[[3]]
  
  #append to external dataframe
  ndsiteout<-rbind(ndsiteout, VR_plots)
}

#rename data frame
ndtsVR <- ndsiteout #%>%
 #mutate(community_type = "Subordinate")


## Calculate the mean and standard error of VR metrics
ndmeantsVR <- ndtsVR %>%
  pivot_longer(cols = ndclassicVR:ndshortVR, names_to = "VR_type", values_to = "VR_value" ) %>% #change to long format
  group_by(TREATMENT, VR_type) %>%
  summarise(meanVR = mean(VR_value), SEVR = calcSE(VR_value))

#reorder treatments to match grazing pressure.
ndmeantsVR$TREATMENT <- as.factor(ndmeantsVR$TREATMENT) #change treatment to factor
ndmeantsVR$TREATMENT <- factor(ndmeantsVR$TREATMENT, levels = c("O", "W",  "MW",  "C", "WC", "MWC"))
```

## Calculate Dominance
```{r, echo=FALSE}
## Full Time Series
## calculate Berger-Parker Dominance for each unique ID at each date
BP_dominance <- klee_annual %>%
  group_by(TREATMENT, Unique_ID, Date_final) %>% #group by treatment, plot, and date
  mutate(rank = rank(Pin_Hits, na.last = NA, ties.method = "average")) %>% #rank species in order of abundance
  mutate(tot_abund = sum(Pin_Hits)) %>% #create column for total abundance in each plot
  filter(rank == max(rank)) %>% #only include most abundant species in each plot
  summarise(BP_dominance = Pin_Hits/tot_abund) %>% #calculate Berger-Parker dominance index
  mutate(date = "all")

## Calculate the mean Berger-Parker dominance by: 
  ## TREATMENT and UNIQUE ID - to use eventually for linear models
meanplot_BPdom <- BP_dominance %>%
  group_by(TREATMENT, Unique_ID) %>%
  summarize(mean_dom = mean(BP_dominance), SEdom = calcSE(BP_dominance), vardom = var(BP_dominance))

dominance <- BP_dominance %>%
  group_by(TREATMENT, Date_final) %>%
  summarize(mean_dom = mean(BP_dominance), SE_dom = calcSE(BP_dominance))
```

## Calculate Dominant species Pop Stability
```{r, echo=FALSE}
## Calculate population stability of dominant species
dompopstab <- big5annual %>%
    group_by(TREATMENT, Unique_ID, SPECIES) %>%
    summarise(temp_mean = mean(Pin_Hits), sdhits = sd(Pin_Hits), sp_stability = temp_mean/sdhits) %>%
    ungroup() %>%
    group_by(TREATMENT, SPECIES) %>%
    summarise(popstability = mean(sp_stability), SEpop = calcSE(sp_stability)) #%>%

dompopstab$TREATMENT <- as.factor(dompopstab$TREATMENT)

dompopstab <- dompopstab %>%
  mutate(TREATMENT = fct_relevel(TREATMENT, "O", "W", "MW", "C", "WC", "MWC"))
```

## Calculate Richness
```{r, echo = FALSE}
## ALL YEARS ----
## Calculate species richness for each plot at each point in time
rich <- klee_annual %>%
  group_by(TREATMENT, Unique_ID, Date_final) %>% ## group by each plot at each date
  summarise(richness = n())
  ## use this dataframe for the ANOVA?

## Calculate the mean richness by: 
  ## TREATMENT and DATE
meanannrich <- rich %>%
  group_by(TREATMENT, Date_final) %>%
  summarise(meanrich = mean(richness), SErich = calcSE(richness)) %>%
  mutate(date = "all")
  ## TREATMENT and UNIQUE_ID
meanrichplot <- rich %>%
  group_by(TREATMENT, Unique_ID) %>%
  summarise(meanrich = mean(richness, SErich = calcSE(richness)), varrich = var(richness)) 

## BIG 5 SPECIES 
## Calculate species richness for each plot at each point in time
big5rich <- big5annual %>%
  group_by(TREATMENT, Unique_ID, Date_final) %>% ## group by each plot at each date
  summarise(richness = n())

## Calculate the mean richness by: 
  ## TREATMENT and DATE
big5meanannrich <- big5rich %>%
  group_by(TREATMENT, Date_final) %>%
  summarise(meanrich = mean(richness), SErich = calcSE(richness))
  ## TREATMENT and UNIQUE_ID
big5meanrichplot <- big5rich %>%
  group_by(TREATMENT, Unique_ID) %>%
  summarise(meanrich = mean(richness, SErich = calcSE(richness)), varrich = var(richness))

## NON-DOMINANT SPECIES
## Calculate species richness for each plot at each point in time
nondomrich <- nondom %>%
  group_by(TREATMENT, Unique_ID, Date_final) %>% ## group by each plot at each date
  summarise(richness = n())

## Calculate the mean richness by: 
  ## TREATMENT and DATE
nondommeanannrich <- nondomrich %>%
  group_by(TREATMENT, Date_final) %>%
  summarise(meanrich = mean(richness), SErich = calcSE(richness))
  ## TREATMENT and UNIQUE_ID
nondommeanrichplot <- nondomrich %>%
  group_by(TREATMENT, Unique_ID) %>%
  summarise(meanrich = mean(richness, SErich = calcSE(richness)), varrich = var(richness))
```

## Create combined Stability & Mechanisms Data Frames
```{r, echo = FALSE}
## ALL YEARS
## Create data frame with one value of stability & mechanisms for each plot
synchrony_stability <- left_join(synchrony, stability, by = "Unique_ID")
ssb5 <- left_join(synchrony_stability, big5synchrony, by = "Unique_ID")
ssnd <- left_join(ssb5, nondomsynchrony, by = "Unique_ID")
ssdom <- left_join(ssnd, meanplot_BPdom, by = c("Unique_ID", "TREATMENT"))
tsvrssdom <- left_join(ssdom, tsVR, by = c("Unique_ID", "TREATMENT", "BLOCK"))
b5tsvrdom <- left_join(tsvrssdom, b5tsVR, by = c("Unique_ID", "TREATMENT", "BLOCK"))
ndtsvrdom <- left_join(b5tsvrdom, ndtsVR, by = c("Unique_ID", "TREATMENT", "BLOCK"))
stability_mechanisms <- left_join(ndtsvrdom, meanrichplot, by = c("Unique_ID", "TREATMENT"))

## Create data frame with one value of stability & mechanisms for each treatment
meanstab_mech <- stability_mechanisms %>%
  group_by(TREATMENT) %>%
  summarise(mean_st = mean(stability), SE_st = calcSE(stability), mean_syn = mean(synchrony), SE_syn = calcSE(synchrony),
            SE_dom = calcSE(mean_dom), mean_dom = mean(mean_dom), mean_rich = mean(meanrich), SE_rich = calcSE(meanrich), 
            b5mean_syn = mean(big5synchrony), b5SE_syn = calcSE(big5synchrony), ndmean_syn = mean(nondomsynchrony), 
            ndSE_syn = calcSE(nondomsynchrony), mean_vardom = mean(vardom), SE_vardom = calcSE(vardom), mean_varrich = mean(varrich), 
            SE_varrich = calcSE(varrich), mean_CV = mean(CV), SE_CV = calcSE(CV), 
            meanlongVR = mean(longVR), SElVR = calcSE(longVR), meanshortVR = mean(shortVR), SEsVR = calcSE(shortVR),
            b5meanlongVR = mean(b5longVR), SEb5lVR = calcSE(b5longVR), b5meanshortVR = mean(b5shortVR), SEb5sVR = calcSE(b5shortVR),
            ndmeanlongVR = mean(ndlongVR), SEndlVR = calcSE(ndlongVR), ndmeanshortVR = mean(ndshortVR), SEndsVR = calcSE(ndshortVR), mean_bio = mean(pinhits), SE_bio = calcSE(pinhits), mean_var = mean(variance), SE_var = calcSE(variance)) %>%
  mutate(TREATMENT = fct_relevel(TREATMENT, "O", "W", "MW", "C", "WC", "MWC")) #reorder treatments

## clean up environment
rm(list = c("synchrony_stability", "ssdom", "ssb5", "ssnd", "tsvrssdom", "b5tsvrdom", "ndtsvrdom"))
```

# Significance Testing
## Mixed Effects Models for ALL YEARS of Herbivory & Stability/Mechanisms
```{r}
## How does herbivore treatment change stability & stability mechanisms?
  ## use block as a random effect

## Stability by Herbivory Treatment
fitgrst <- lmer(stability~TREATMENT + (1|BLOCK), data = stability_mechanisms)
summary(fitgrst)

fitstnull <- lmer(stability~1 + (1|BLOCK), data = stability_mechanisms)
summary(fitstnull)
AIC(fitstnull)
AIC(fitgrst)
## use AIC to compare to model where Tx is taken out
## diff b/w AIC vals > 2; & lower AIC score is better
## treatment makes a diff here.
## do this for each of the models

## for diff b/w tx -> use emmeans 
emmeans(fitgrst, specs = pairwise ~ TREATMENT)



## Synchrony by Herbivory Treatment
fitgrsy <- lmer(synchrony~TREATMENT + (1|BLOCK), data = stability_mechanisms)
summary(fitgrsy)

fitsynull <- lmer(synchrony~1 + (1|BLOCK), data = stability_mechanisms)
summary(fitsynull)

AIC(fitsynull)
AIC(fitgrsy)
## treatment does make a difference here

## difference between treatments
emmeans(fitgrsy, specs = pairwise ~ TREATMENT)



## Big 5 Synchrony by Herbivory Treatment
fitgrsyb5 <- lmer(big5synchrony~TREATMENT + (1|BLOCK), data = stability_mechanisms)
summary(fitgrsyb5)

fitsyb5null <- lmer(big5synchrony~1 + (1|BLOCK), data = stability_mechanisms)
summary(fitsyb5null)

AIC(fitsyb5null)
AIC(fitgrsyb5)
## treatment does make a difference here

## difference between treatments
emmeans(fitgrsyb5, specs = pairwise ~ TREATMENT)


## Subordinate Synchrony by Herbivory Treatment
fitgrsynd <- lmer(nondomsynchrony~TREATMENT + (1|BLOCK), data = stability_mechanisms)
summary(fitgrsyb5)

fitsyndnull <- lmer(nondomsynchrony~1 + (1|BLOCK), data = stability_mechanisms)
summary(fitsyndnull)

AIC(fitsyndnull)
AIC(fitgrsynd)
## treatment does make a difference here

## difference between treatments
emmeans(fitgrsynd, specs = pairwise ~ TREATMENT)



## Dominance by Herbivory Treatment 
fitgrdo <- lmer(mean_dom~TREATMENT + (1|BLOCK), data = stability_mechanisms)
summary(fitgrdo)

fitdonull <- lmer(mean_dom~1 + (1|BLOCK), data = stability_mechanisms)
summary(fitdonull)
AIC(fitgrdo)
AIC(fitdonull)
## treatment does make a difference here

## difference between treatments
emmeans(fitgrdo, specs = pairwise ~ TREATMENT)


## Richness by Herbivory Treatment
fitgrri <- lmer(meanrich~TREATMENT + (1|BLOCK), data = stability_mechanisms)
summary(fitgrri)

fitrinull <- lmer(meanrich~1 + (1|BLOCK), data = stability_mechanisms)
summary(fitrinull)
AIC(fitgrri)
AIC(fitrinull)
## treatment slightly makes a difference 

## difference between treatments
emmeans(fitgrri, specs = pairwise ~ TREATMENT)


## Variance of Richness by Herbivory Treatment
fitgrvr <- lmer(varrich~TREATMENT + (1|BLOCK), data = stability_mechanisms)
summary(fitgrvr)

fitvrnull <- lmer(varrich~1 + (1|BLOCK), data = stability_mechanisms)
summary(fitvrnull)
AIC(fitgrvr)
AIC(fitvrnull)
## treatment slightly makes a difference 

## difference between treatments
emmeans(fitgrvr, specs = pairwise ~ TREATMENT)

```


## Mixed Effects Models for Stability & Mechanisms (ALL YEARS)
```{r}
## Try Stability vs. Mechanism model variations
## linear mixed effects model in lme4

## Check whether any factors are highly correlated (above 0.7 wouldn't put in a multiple regression together)
## Test Correlations b/w variables
cor.test(stability_mechanisms$mean_dom, stability_mechanisms$synchrony)
## borderline

cor.test(stability_mechanisms$meanrich, stability_mechanisms$synchrony)

cor.test(stability_mechanisms$meanrich, stability_mechanisms$mean_dom)


## Model with all 3 stability mechanisms included as predictors
fitstabmech <- lmer(stability~mean_dom+meanrich+synchrony +(1|BLOCK), data = stability_mechanisms, na.action = "na.fail")
summary(fitstabmech)

## test to see if the model converges with just synchrony
fitstabsyn <- lmer(stability~synchrony +(1|BLOCK), data = stability_mechanisms, na.action = "na.fail")
summary(fitstabsyn)

fitb5stabsyn <- lmer(stability~big5synchrony +(1|BLOCK), data = stability_mechanisms, na.action = "na.fail")
summary(fitb5stabsyn)

AIC(fitstabsyn)
AIC(fitb5stabsyn)
## not different enough from each other

## test again to see if any of the predictors are highly correlated using the variance inflation factor
vif(fitstabmech)
## reasonably low vif values

## Use the dredge function from the MuMIn package to compare models with all combinations of these predictors, ranked by AIC
dredge(fitstabmech)
  ## looks like just synchrony is the most parsimonious model 
```

# Figure Settings
```{r, echo=FALSE, include=FALSE}
green_scale <- c("#97e196", "#6cc08b", "#4c9b82", "#217a79", "#105965", "#074050") #make a vector of colors
colors <- c("#88CCEE", "#CC6677","#DDCC77","#117733","#332288","#AA4499","#44AA99","#999933","#882255","#661100","#6699CC","#888888")
theme_set(theme_classic()) #set the theme
```

# Figures
## Figure 1: Stability, Mean Pin Hits, and Variance
```{r, fig.width =12, fig.height=4, echo=FALSE}
#graph the mean variance by treatment
v <- ggplot(meanstab_mech, aes(x=TREATMENT, y=mean_var)) +
  geom_point(size=4) +
  geom_errorbar(aes(ymin = mean_var-SE_var, ymax = mean_var+SE_var), width=0.25) +
  ylab("Temporal Variance") + xlab("") +
  #annotate("text", x =1, y=23500, label = "a", size = 5) +
 # annotate("text", x =2, y=19800, label = "ab", size = 5) +
 # annotate("text", x =3, y=17500, label = "ab", size = 5) +
#  annotate("text", x =4, y=16000, label = "bc", size = 5) +
 # annotate("text", x =5, y=12500, label = "c", size = 5) +
#  annotate("text", x =6, y=11800, label = "c", size = 5) +
  theme(text = element_text(size = 16)) #change font size


#graph the mean total pin hits by treatment
b <- ggplot(meanstab_mech, aes(x=TREATMENT, y=mean_bio)) +
  geom_point(size=4) +
  geom_errorbar(aes(ymin=mean_bio-SE_bio, ymax=mean_bio+SE_bio), width = 0.2) + #include standard error bars
  ylab("Total Cover (Pin Hits)") + xlab("Treatment") +
  #annotate("text", x =1, y=1420, label = "a", size = 5) +
#  annotate("text", x =2, y=1367, label = "ab", size = 5) +
#  annotate("text", x =3, y=1310, label = "bc", size = 5) +
#  annotate("text", x =4, y=1210, label = "cd", size = 5) +
#  annotate("text", x =5, y=1175, label = "d", size = 5) +
#  annotate("text", x =6, y=1110, label = "d", size = 5) +
  theme(text = element_text(size = 16)) #change font size


## visualize mean stability & standard error
s <- ggplot(meanstab_mech, aes(x=TREATMENT, y=mean_st)) +
  geom_point(size=4) +
  geom_errorbar(aes(ymin = mean_st-SE_st, ymax=mean_st+SE_st), width = 0.2) + #add standard error bars
  ylab("Stability (mean/sd)") + xlab("") + #label axes
#  annotate("text", x =1, y=4.75, label = "a", size = 5) +
#  annotate("text", x =2, y=4.5, label = "ab", size = 5) +
#  annotate("text", x =3, y=3.9, label = "bc", size = 5) +
#  annotate("text", x =4, y=3.95, label = "c", size = 5) +
#  annotate("text", x =5, y=3.3, label = "c", size = 5) +
 # annotate("text", x =6, y=3.2, label = "c", size = 5) +
  theme(text = element_text(size = 16)) #change font size

## plot 3 panel figure of stability, total pin hits, and temporal variance
ggarrange(s, b, v, 
          labels = "AUTO",
          ncol = 3, nrow = 1, 
          align = "hv")
```

## Figure 2: Stability & Mechanisms
```{r, echo=FALSE}
## combine all 3 synchrony dataframes into one in order to put all in the same panel
colnames(big5synchrony) <- c("Unique_ID", "synchrony")
colnames(nondomsynchrony) <- c("Unique_ID", "synchrony")

b5synchrony <- big5synchrony %>% 
  mutate(community_type = "Dominant") ## add column to differentiate community type
ndsynchrony <- nondomsynchrony %>% 
  mutate(community_type = "Subordinate")
allsynchrony <- synchrony %>% 
  mutate(community_type = "All Species")

## join data frames
syn2 <- rbind(b5synchrony, ndsynchrony)
syn3 <- rbind(syn2, allsynchrony) 
synstabtemp <- left_join(syn3, stability, by = "Unique_ID")

## set treatment as a factor
synstabtemp$TREATMENT <- as.factor(synstabtemp$TREATMENT)

## make one data frame with means calculated for graphing
syn_plot <- synstabtemp %>%
  group_by(TREATMENT, community_type) %>%
  summarise(mean_st = mean(stability), SE_st = calcSE(stability), mean_syn = mean(synchrony), SE_syn = calcSE(synchrony), mean_CV = mean(CV), SE_CV = calcSE(CV)) %>%
  mutate(TREATMENT = fct_relevel(TREATMENT, "O", "W", "MW", "C", "WC", "MWC")) #reorder treatments


## synchrony by herbivory
psynall <- ggplot(syn_plot, aes(x=TREATMENT, y=mean_syn, fill = TREATMENT, shape = community_type)) +
  geom_errorbar(aes(ymin = mean_syn-SE_syn, ymax=mean_syn+SE_syn), width = 0.2) +
  geom_point(size = 4) +
  geom_point(size = 4, fill = NA, colour = "black") +
  scale_shape_manual(values = c(21,22,18)) +
  scale_fill_scico_d(palette = "batlow", direction = -1) +
  theme(legend.title = element_text(size=14)) +  theme(text = element_text(size = 16)) + #change font sizes
  xlab("") + ylab("Synchrony") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(shape = "Community Type", fill = "Treatment")


## dominance by herbivory
pdom <- ggplot(meanstab_mech, aes(x=TREATMENT , y=mean_dom)) +
  geom_errorbar(aes(ymin = mean_dom-SE_dom, ymax=mean_dom+SE_dom), width = 0.3) +
  geom_point(aes(fill=TREATMENT), 
       colour="black",pch=21, size=4) +
  scale_fill_scico_d(palette = "batlow", direction = -1) +
  ylab("Dominance") + xlab("") +  
  theme(legend.title = element_text(size=14)) +  theme(text = element_text(size = 16)) + #change font sizes
  labs(col = "Time Period") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

## richness by herbivory
prich <- ggplot(meanstab_mech, aes(x=TREATMENT , y=mean_rich)) +
  geom_errorbar(aes(ymin = mean_rich-SE_rich, ymax=mean_rich+SE_rich), width = 0.3) +
  geom_point(aes(fill=TREATMENT), 
       colour="black",pch=21, size=4) +
  scale_fill_scico_d(palette = "batlow", direction = -1) +
  ylab("Richness") + xlab("") +  
  theme(legend.title = element_text(size=14)) +  theme(text = element_text(size = 16)) + #change font sizes
  labs(col = "Time Period") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

## synchrony and stability
psynstab <- ggplot(meanstab_mech, aes(x=mean_syn, y=mean_st)) +
  geom_errorbar(aes(ymin = mean_st-SE_st, ymax=mean_st+SE_st), width = 0.01) +
  geom_errorbarh(aes(xmin = mean_syn-SE_syn, xmax=mean_syn+SE_syn), height = 0.1) + #add standard error bars
  geom_point(aes(fill=TREATMENT), 
       colour="black",pch=21, size=4) +
  scale_fill_scico_d(palette = "batlow", direction = -1) +
  ylab("Stability") + xlab("Synchrony: All Sp.") +  
  theme(legend.title = element_text(size=14)) +  theme(text = element_text(size = 16))  + #change font sizes
  geom_abline(slope = -10.8462, intercept = 5.6445) +
  labs(col = "Treatment")

## dominance and stability
pdomstab <- ggplot(meanstab_mech, aes(x=mean_dom, y=mean_st)) +
  geom_errorbar(aes(ymin = mean_st-SE_st, ymax=mean_st+SE_st), width = 0.01) +
  geom_errorbarh(aes(xmin = mean_dom-SE_dom, xmax=mean_dom+SE_dom), height = 0.1) + #add standard error bars
  geom_point(aes(fill=TREATMENT), 
       colour="black",pch=21, size=4) +
  scale_fill_scico_d(palette = "batlow", direction = -1) +  ylab("Stability") + xlab("Dominance") +  
  theme(legend.title = element_text(size=14)) +  theme(text = element_text(size = 16)) + #change font sizes
  labs(col = "Treatment")

## richness and stability
prichstab <- ggplot(meanstab_mech, aes(x=mean_rich, y=mean_st)) +
  geom_errorbar(aes(ymin = mean_st-SE_st, ymax=mean_st+SE_st), width = 0.01) +
  geom_errorbarh(aes(xmin = mean_rich-SE_rich, xmax=mean_rich+SE_rich), height = 0.1) + #add standard error bars
  geom_point(aes(fill=TREATMENT), 
       colour="black",pch=21, size=4) +
  scale_fill_scico_d(palette = "batlow", direction = -1) +  ylab("Stability") + xlab("Richness") +  
  theme(legend.title = element_text(size=14)) +  theme(text = element_text(size = 16))  + #change font sizes
    labs(col = "Treatment")
```


```{r, echo = FALSE, fig.width=10, fig.height=5.5}
ggarrange(psynall, pdom, prich,
          psynstab, pdomstab, prichstab,
          ncol = 3, nrow=2,
          align = "hv",
          labels = "AUTO",
          common.legend = TRUE, 
          legend = "right")

```


## Temporal Dynamics Figures
### TSVR Plot
```{r, echo=FALSE, fig.width=8.25, fig.height=3.25}

tsvrplot <- meantsVR %>%
  filter(VR_type != "classicVR")

full <- ggplot(tsvrplot, aes(x=TREATMENT, y=meanVR)) +
  geom_point(size = 2.5) +
  geom_errorbar(aes(ymin = meanVR-SEVR, ymax=meanVR+SEVR), width = 0.4) +
  geom_hline(yintercept = 1, linetype = "dashed") +
  geom_point(aes(fill=VR_type), 
       colour="black",pch=21, size=4) +
  scale_fill_manual(values = c("#c8c8c8", "#4f4f4f")) +
 # scale_color_manual(values = c("#000000", "#4f4f4f")) +
  ylab("TSVR full community") + xlab("") +
  coord_cartesian(ylim = c(0.4, 3.75)) +
  labs(fill = "Variance Ratio Type") +
  theme(legend.title = element_text(size=14)) +  theme(text = element_text(size = 14)) #change font sizes


#88CCEE,#CC6677,#DDCC77,#117733,#332288,#AA4499,#44AA99,#999933,#882255,#661100,#6699CC,#888888

b5tsvrplot <- b5meantsVR %>%
  filter(VR_type != "b5classicVR")

b5 <- ggplot(b5tsvrplot, aes(x=TREATMENT, y=meanVR)) +
  geom_point(size = 2.5) +
  geom_errorbar(aes(ymin = meanVR-SEVR, ymax=meanVR+SEVR), width = 0.4) +
  geom_hline(yintercept = 1, linetype = "dashed") +
  geom_point(aes(fill=VR_type), 
       colour="black",pch=21, size=4) +
  scale_fill_manual(values = c("#c8c8c8", "#4f4f4f")) +  
  ylab("TSVR dominant sp") + xlab("") +
  coord_cartesian(ylim = c(0.4, 3.75)) +
  theme(legend.title = element_text(size=14)) +  theme(text = element_text(size = 14)) #change font sizes

ndtsvrplot <- ndmeantsVR %>%
  filter(VR_type != "ndclassicVR")

nd <- ggplot(ndtsvrplot, aes(x=TREATMENT, y=meanVR)) +
  geom_point(size = 2.5) +
  geom_errorbar(aes(ymin = meanVR-SEVR, ymax=meanVR+SEVR), width = 0.4) +
  geom_hline(yintercept = 1, linetype = "dashed") +
  geom_point(aes(fill=VR_type), 
       colour="black",pch=21, size=4) +
  scale_fill_manual(values = c("#c8c8c8", "#4f4f4f")) +  
  ylab("TSVR subordinate sp") + xlab("") +
  coord_cartesian(ylim = c(0.4, 3.75)) +
  theme(legend.title = element_text(size=14)) +  theme(text = element_text(size = 14)) #change font sizes


ggarrange(full, b5, nd, 
          ncol= 3, nrow = 1, 
          align = "hv", 
          common.legend = TRUE, 
          labels = "AUTO")
```


### Figure S3: Dominance over time
```{r, echo=FALSE, fig.align='center', fig.height=6, fig.width=8}
## Graph dominance over time
domtime <- ggplot(dominance, aes(x=Date_final, y=mean_dom, col=TREATMENT)) +
  geom_line(size = 1) +
  ylab("Dominance") + xlab("Date") +
  scale_color_scico_d(palette = "batlow", direction = -1) +
  theme(legend.title = element_text(size=14)) +
  theme(text = element_text(size = 14)) +
  labs(col = "Treatment") #change legend title

## Graph richness over time
richtime <- ggplot(meanannrich, aes(x=Date_final, y=meanrich, col=TREATMENT)) +
  geom_line(size = 0.75) +
  ylab("Species Richness") + xlab("Date") +
  scale_color_scico_d(palette = "batlow", direction = -1) +
  theme(legend.title = element_text(size=14)) +
  theme(text = element_text(size = 14)) +
  labs(col = "Treatment") #change legend title

ggarrange(domtime, richtime, ncol = 1, nrow = 2, 
          common.legend = TRUE,
          legend = "right",
          labels = "AUTO")
```

### Total Cover Over Time
```{r, echo = FALSE, fig.width=9, fig.height=3}
meancov <- totcov %>%
  mutate(type = "Full") %>%
  group_by(TREATMENT, Date_final, type) %>%
  summarise(meancov = mean(totcov))

b5totcov <- big5annual %>%
  group_by(BLOCK, TREATMENT, Unique_ID, Date_final) %>% #group by block, treatment, and date 
  summarise(totcov = sum(Pin_Hits, na.rm=T)) %>% #sum abundances to calculate tot cover
  mutate(type = "Dominant") #%>%
  
meanb5cov <- b5totcov %>%
  group_by(TREATMENT, Date_final, type) %>%
  summarise(meancov = mean(totcov))

ndtotcov <- nondom %>%
  group_by(BLOCK, TREATMENT, Unique_ID, Date_final) %>% #group by block, treatment, and date 
  summarise(totcov = sum(Pin_Hits, na.rm=T)) %>% #sum abundances to calculate tot cover
  mutate(type = "Subordinate") #%>%

meanndcov <- ndtotcov %>%
  group_by(TREATMENT, Date_final, type) %>%
  summarise(meancov = mean(totcov))

j <- rbind(meancov, meanb5cov)
cover <- rbind(j, meanndcov) 
cover$TREATMENT <- as.factor(cover$TREATMENT)

cover <- cover %>%
  mutate(TREATMENT = fct_relevel(TREATMENT, "O", "W", "MW", "C", "WC", "MWC")) %>% #reorder treatments
  mutate(type = fct_relevel(type, "Full", "Dominant", "Subordinate"))

ggplot(cover, aes(x= Date_final, y=meancov, color = type)) +
  geom_line(size = 1) +
  facet_wrap(~TREATMENT) +
  ylab("Total Cover") + xlab("Date") +
  scale_color_manual(values = c("#000000", "#4f4f4f", "#ababab"))


ggplot(cover, aes(x= Date_final, y=meancov, color = TREATMENT)) +
  geom_line(size = 0.75) +
  facet_wrap(~type) +
  scale_color_scico_d(palette = "batlow", direction = -1) +
  ylab("Total Cover") + xlab("Date")
```

### Variance in richness & dominance
```{r, echo=FALSE, fig.height=3, fig.width=7}
domvar <- ggplot(meanstab_mech, aes(x=TREATMENT, y=mean_vardom)) +
  geom_point(size = 3) +
  geom_errorbar(aes(ymin = mean_vardom-SE_vardom, ymax = mean_vardom+SE_vardom), width = 0.2)+
  ylab("Variance of Dominance") + xlab("") +
  geom_point(aes(fill=TREATMENT), 
       colour="black",pch=21, size=4) +
  scale_fill_scico_d(palette = "batlow", direction = -1) #+
  #scale_color_manual(values = colors)

richvar <- ggplot(meanstab_mech, aes(x=TREATMENT, y=mean_varrich)) +
  geom_point(size = 3) +
  geom_errorbar(aes(ymin = mean_varrich-SE_varrich, ymax = mean_varrich+SE_varrich), width = 0.2)+
  ylab("Variance of Richness") + xlab("") +
  geom_point(aes(fill=TREATMENT), 
       colour="black",pch=21, size=4) +
  scale_fill_scico_d(palette = "batlow", direction = -1)


ggarrange(domvar, richvar, ncol = 2, align = "hv", 
          common.legend = TRUE, 
          legend = "right")
```


## Population Stability Figure
```{r, echo=FALSE, fig.width=6, fig.height=7}
ggplot(dompopstab, aes(x=SPECIES, y=popstability)) +
  geom_point(size = 2) +
  geom_errorbar(aes(ymin = popstability-SEpop, ymax = popstability+SEpop), width = 0.2) +
  geom_point(aes(fill=TREATMENT), 
       colour="black",pch=21, size=4) +
  scale_fill_scico_d(palette = "batlow", direction = -1) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  ylab("Population Stability") + xlab("")

```


# Poster Figures 
## Poster Fig 1
```{r, fig.width=12.5, fig.height=3.5}
pstab <- ggplot(meanstab_mech, aes(x=TREATMENT, y=mean_st)) +
  geom_errorbar(aes(ymin = mean_st-SE_st, ymax=mean_st+SE_st), width = 0.2) + #add standard error bars
  geom_point(aes(fill=TREATMENT), 
       colour="black",pch=21, size=4) +
  scale_fill_scico_d(palette = "batlow", direction = -1) +
  ylab("Stability") + xlab("") +
  theme(legend.title = element_text(size=14)) +  theme(text = element_text(size = 16)) + #change font sizes
  labs(col = "Time Period") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))



## synchrony by herbivory
psyn <- ggplot(meanstab_mech, aes(x=TREATMENT , y=mean_syn)) +
  geom_point(size=4) +
  scale_color_manual(values = colors) + 
  geom_errorbar(aes(ymin = mean_syn-SE_syn, ymax=mean_syn+SE_syn), width = 0.3) +
  ylab("Synchrony (All)") + xlab("") +  
  theme(legend.title = element_text(size=14)) +  theme(text = element_text(size = 16)) + #change font sizes
  labs(col = "Time Period")

pb5syn <- ggplot(meanstab_mech, aes(x=TREATMENT , y=b5mean_syn)) +
  geom_point(size = 3.5) +
  scale_color_manual(values = colors) + 
  geom_errorbar(aes(ymin = b5mean_syn-b5SE_syn, ymax=b5mean_syn+b5SE_syn), width = 0.3) +
  ylab("Big 5 Synchrony") + xlab("Treatment") +  
  theme(legend.title = element_text(size=14)) +  theme(text = element_text(size = 15)) + #change font sizes
  labs(col = "Time Period")


ggplot(syn_plot, aes(x=TREATMENT, y=mean_syn, color = community_type, shape = community_type)) +
  geom_point(size = 3.5) +
  scale_color_manual(values = c("#000000", "#4f4f4f", "#919191")) + 
  scale_shape_manual(values = c(16,17,18)) +
  theme(legend.title = element_text(size=14)) +  theme(text = element_text(size = 15)) + #change font sizes
  geom_errorbar(aes(ymin = mean_syn-SE_syn, ymax=mean_syn+SE_syn), width = 0.2) +
  xlab("") + ylab("Synchrony") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggplot(syn_plot, aes(x=TREATMENT, y=mean_syn, fill = TREATMENT, shape = community_type)) +
  geom_errorbar(aes(ymin = mean_syn-SE_syn, ymax=mean_syn+SE_syn), width = 0.2) +
  geom_point(size = 4) +
  geom_point(size = 4, fill = NA, colour = "black") +
  scale_shape_manual(values = c(24,22,18)) +
  #geom_point(aes(color=TREATMENT), size=3.6) +
  scale_fill_scico_d(palette = "batlow", direction = -1) +
 # scale_shape_manual(values = c(16,17,18)) +
  theme(legend.title = element_text(size=14)) +  theme(text = element_text(size = 16)) + #change font sizes
  xlab("") + ylab("Synchrony") +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))


ggplot(syn_plot, aes(x=TREATMENT, y=mean_syn, shape = community_type)) +
  geom_errorbar(aes(ymin = mean_syn-SE_syn, ymax=mean_syn+SE_syn), width = 0.2) +
  geom_point(aes(y=mean_syn, shape = community_type), size = 4.25) +
  geom_point(aes(color=TREATMENT), size=3.6) +
  scale_color_scico_d(palette = "batlow", direction = -1) +
  scale_shape_manual(values = c(16,17,18)) +
  theme(legend.title = element_text(size=14)) +  theme(text = element_text(size = 15)) + #change font sizes
  xlab("Treatment") + ylab("Synchrony") #+
  facet_wrap(~community_type)




ggarrange(pstab, psynall, pdom, prich,
          ncol = 4,
          align = "hv",
          labels = "AUTO",
          common.legend = TRUE, 
          legend = "none")



```

## Mechanisms Poster Figure
```{r, echo = FALSE, fig.width=12, fig.height=3.5}
pb5synstab <- ggplot(meanstab_mech, aes(x=b5mean_syn, y=mean_st)) +
  geom_errorbar(aes(ymin = mean_st-SE_st, ymax=mean_st+SE_st), width = 0.01) +
  geom_errorbarh(aes(xmin = b5mean_syn-b5SE_syn, xmax=b5mean_syn+b5SE_syn), height = 0.1) + #add standard error bars
  geom_point(aes(fill=TREATMENT), 
       colour="black",pch=21, size=4) +
  scale_fill_scico_d(palette = "batlow", direction = -1) +
  ylab("Stability") + xlab("Synchrony: Dominant Sp") +  
  theme(legend.title = element_text(size=14)) +  theme(text = element_text(size = 16)) + #change font sizes 
  labs(col = "Treatment")


ggarrange(psynstab, pb5synstab, pdomstab, prichstab,
          ncol = 4, nrow = 1,
          align = "hv",
          labels = "AUTO",
          common.legend = TRUE, 
          legend = "none")

ggarrange(psynstab, pb5synstab, pdomstab, prichstab,
          ncol = 4, nrow = 1,
          align = "hv",
          labels = "AUTO",
          common.legend = TRUE, 
          legend = "right")
```

## More poster figs
```{r, fig.width=9, fig.height=3.5}

ggarrange(psynstab, pdomstab, prichstab, 
          ncol = 3, nrow = 1,
          align = "hv",
          labels = "AUTO",
          common.legend = TRUE, 
          legend = "none")

ggarrange(psynstab, pdomstab, prichstab, 
          ncol = 3, nrow = 1,
          align = "hv",
          labels = "AUTO",
          common.legend = TRUE, 
          legend = "bottom")

```



