---
title: "The top down control of stability by herbivores"
author: "Carmen Ebel"
date: "4/1/2021"
output: html_document
---

# Data Prep
## Read in Data
```{r, echo=FALSE, include=FALSE}
## Load Packages, Read in Data ##
## set working directory
setwd("~/Repositories/klee-stability")

## Load packages
library(tidyverse)
library(lubridate)
library(codyn)
library(tsvr)
library(RColorBrewer)
library(forcats)
library(knitr)
library(bookdown)
library(ggpubr)
library(data.table)

## source cleaned data
source("klee_data_cleaning_current.R")
source("precipitation_data_cleaning.R")
```

# Calculations

## Calculate Stability & Variance
``` {r,  echo=FALSE}
## Calculate Community Stability ##
## calc community stability metric for each plot
commstab <- community_stability(klee_long, 
                                time.var = "Date_numeric", 
                                abundance.var = "Pin_Hits", 
                                replicate.var = "Unique_ID")

## join with treatment info & calculate CV
stability <- left_join(commstab, treats, by = "Unique_ID") %>% #join community stability with treatment info
  mutate(CV = 1/stability) #calculate the CV by taking the inverse of stability

rm(commstab)

## create a dataframe with mean & standard error of stability & CV by treatment
mean_stability <- stability %>%
  group_by(TREATMENT) %>%
  summarize(mean_st = mean(stability), SEst = calcSE(stability), mean_cv = mean(CV), SECV = calcSE(CV))

## reorder treatments to match grazing pressure.
mean_stability$TREATMENT <- as.factor(mean_stability$TREATMENT) #change treatment to factor
mean_stability$TREATMENT <- factor(mean_stability$TREATMENT, levels = c("0", "W",  "MW",  "C", "MWC", "WC"))

## Calculate Variance
## calculate the variance of each plot over time
varian <- klee_long %>%
  group_by(TREATMENT, Unique_ID) %>%
  summarise(variance = var(Pin_Hits)) %>%
  group_by(TREATMENT) %>%
  summarise(meanvar = mean(variance), SEvar = calcSE(variance)) ## calculate mean and standard error

variance <- klee_long %>%
  group_by(TREATMENT, Unique_ID) %>%
  summarise(variance = var(Pin_Hits))

pinhits <- meantotcov %>%
  group_by(TREATMENT, Unique_ID) %>%
  summarize(pinhits = mean(Mean_TotCov))


meanvar18 <- left_join(variance, pinhits, by = c("TREATMENT", "Unique_ID"))

meanvar6 <- meanvar18 %>%
  group_by(TREATMENT) %>%
  summarize(meanvar = mean(variance),
            SEvar = calcSE(variance), 
            meanbio = mean(pinhits), 
            SEbio = mean(pinhits))

## reorder treatments to match grazing pressure.
varian$TREATMENT <- as.factor(varian$TREATMENT) #change treatment to factor
varian$TREATMENT <- factor(varian$TREATMENT, levels = c("0", "W",  "MW",  "C", "MWC", "WC"))


## How does the change in sampling frequency affect stability?
## Look at the bi-annual samples & compare stability using all and June only

sort(unique(klee_long$Date_final)) #sort unique sampling dates
    ## looks like bi-annual sampling stops after 2010

## create the bi-annual data frame (before 2011)
biannual <- klee_long %>%
  filter(Date_numeric < 20110601)

annual1 <- klee_long[klee_long$Date_final %like% "-06", ]        # Extract matching rows with %like%
annual2 <- klee_long[klee_long$Date_final %like% "-05", ]  

annual_all <- rbind(annual1, annual2)

annual <- rbind(annual1, annual2) %>%
  filter(Date_numeric < 20110601)

sort(unique(annual$Date_final))

biannual_stab <- community_stability(biannual, 
                                time.var = "Date_numeric", 
                                abundance.var = "Pin_Hits", 
                                replicate.var = "Unique_ID")

annual_stab <- community_stability(annual, 
                                time.var = "Date_numeric", 
                                abundance.var = "Pin_Hits", 
                                replicate.var = "Unique_ID")



colnames(biannual_stab) <- c("Unique_ID", "biannual")
colnames(annual_stab) <- c("Unique_ID", "annual")

stabfreq_test <- left_join(biannual_stab, annual_stab, by="Unique_ID")

stabfreq_test <- left_join(stabfreq_test, treats) %>%
  pivot_longer(2:3, names_to = "frequency", values_to = "stability")

meanfreqstab <- stabfreq_test %>%
  group_by(TREATMENT, frequency) %>%
  summarize(mean = mean(stability), SE = calcSE(stability))

ggplot(meanfreqstab, aes(x=TREATMENT, y=mean, color=frequency)) +
  geom_point() +
  geom_errorbar(aes(ymin=mean-SE, ymax=mean+SE), width=0.25) +
  xlab("Treatment") + ylab("Mean Stability") +
  theme_bw()

rm(list = c("biannual", "annual1", "annual2", "annual", "annual_stab", "biannual_stab", "stabfreq_test"))

## Calculate Stability over a Moving Window ##
## create function
movingwindow_func <- function(input_data, timestep, ...) { ## function inputs = data frame and number of time steps
  
  n_samples <- length(unique(input_data$Date_final)) ## number of sampling points
  n_windows <- n_samples - timestep + 1 ## how many windows to iterate over 
  movingwindow <- data.frame(matrix(ncol=3,nrow=(n_windows*length(unique(input_data$Unique_ID))))) ## create empty dataframe to contain output ## dimensions = # cols (3) x (uniqueID x timesteps)
  colnames(movingwindow) <- c("Unique_ID", "stability", "timestep")
  sample_points <- sort(unique(input_data$Date_numeric)) ## create ordered list of sample points
  
  n_plots <- length(unique(input_data$Unique_ID)) ## number of unique plots
  
  for (i in 1:n_windows){
    
    temp_samplepts <- sample_points[i:(i+timestep-1)] ## create a vector of sample points for each iteration
    
    temp <- input_data %>%
      filter(Date_numeric %in% temp_samplepts) ## filter the correct sample points from input data to run through the community stability function
    
    temp_commstab <- community_stability(temp,  ## run the community stability function from codyn
                                time.var = "Date_numeric", 
                                abundance.var = "Pin_Hits", 
                                replicate.var = "Unique_ID")
    temp_commstab$timestep <- i ## create a column for timestep in the temporary data frame
    
    movingwindow[((i-1)*n_plots + 1):(i*n_plots),] <- temp_commstab ## add stability calculations for one iteration to the moving window data frame
    ## ((i-1)*n_plots + 1):(i*n_plots) -> where to put each iteration of the loop
    
  }
  
  return(movingwindow) ## retrieve data frame at the end
  
}

## Use moving window function to calculate stability with ONLY June sampling points
annual_stab3 <- movingwindow_func(input_data = annual_all, timestep = 3)
annual_stab5 <- movingwindow_func(input_data = annual_all, timestep = 5)
annual_stab7 <- movingwindow_func(input_data = annual_all, timestep = 7)
annual_stab10 <- movingwindow_func(input_data = annual_all, timestep = 10)
```
Biannual: Uses data from February and June samplings. Annual: Uses data from only June samplings. Given that there are differences in the mean stability calculations depending on whether the February points are included, we will use only June data for the moving window analyses.


## Synchrony

### Calculate Synchrony Metrics
```{r,  echo=FALSE}
## Calculate Synchrony Metrics ##
## Calculate Loreau synchrony metric
loreau_synchrony <- synchrony(
  klee_long,
  time.var = "Date_numeric",
  species.var = "SPECIES",
  abundance.var = "Pin_Hits",
  metric = "Loreau",
  replicate.var = "Unique_ID"
)
colnames(loreau_synchrony) <- c("Unique_ID", "loreau_synchrony") #rename columns

## Calculate Gross synchrony metric
gross_synchrony <- synchrony(
  klee_long,
  time.var = "Date_numeric",
  species.var = "SPECIES",
  abundance.var = "Pin_Hits",
  replicate.var = "Unique_ID",
  metric="Gross")
colnames(gross_synchrony) <- c("Unique_ID", "gross_synchrony") #rename columns

## join two synchrony metrics into one data frame
synchrony <- left_join(loreau_synchrony, gross_synchrony, by = "Unique_ID") 

## join with treatment data
synchrony_tx <- inner_join(synchrony, treats, by = "Unique_ID")
synchrony_stability <- left_join(synchrony, stability, by = "Unique_ID")
rm(loreau_synchrony)
rm(gross_synchrony)

## calculate mean & SE of metrics to get ready for graphing
mean_synchrony <- left_join(synchrony, treats, by = "Unique_ID") %>%
  pivot_longer(cols = loreau_synchrony:gross_synchrony, names_to = "Metric_Name", values_to = "Synchrony") %>% #pivot to long format
  group_by(TREATMENT, Metric_Name) %>%
  summarise(mean_value = mean(Synchrony), SE_value = calcSE(Synchrony))

## reorder treatments to match grazing pressure.
mean_synchrony$TREATMENT <- as.factor(mean_synchrony$TREATMENT) #change treatment to factor
mean_synchrony$TREATMENT <- factor(mean_synchrony$TREATMENT, levels = c("0", "W",  "MW",  "C", "MWC", "WC"))

## join synchrony & stability data frames to get ready for graphing
syn_stab <- inner_join(mean_synchrony, mean_stability, by = "TREATMENT")




## Synchrony over a Moving Window ##
## create function
synchronymw_func <- function(input_data, timestep, ...) { ## function inputs = data frame and number of time steps
  
  n_samples <- length(unique(input_data$Date_final)) ## number of sampling points
  n_windows <- n_samples - timestep + 1 ## how many windows to iterate over 
  mw_synchrony <- data.frame(matrix(ncol=4,nrow=(n_windows*length(unique(input_data$Unique_ID))))) ## create empty dataframe to contain output ## dimensions = # cols (3) x (uniqueID x timesteps)
  colnames(mw_synchrony) <- c("Unique_ID", "loreau_synchrony", "timestep", "gross_synchrony")
  
  sample_points <- sort(unique(input_data$Date_numeric)) ## create ordered list of sample points
  
  n_plots <- length(unique(input_data$Unique_ID)) ## number of unique plots
  
  for (k in 1:n_windows){
    
    temp_samplepts <- sample_points[k:(k+timestep-1)] ## create a vector of sample points for each iteration
    
    temp <- input_data %>%
      filter(Date_numeric %in% temp_samplepts) ## filter the correct sample points from input data to run through the community stability function
    
    
    ## Calculate Loreau synchrony metric
    temp_lsyn <- synchrony(
      temp,
      time.var = "Date_numeric",
      species.var = "SPECIES",
      abundance.var = "Pin_Hits",
      metric = "Loreau",
      replicate.var = "Unique_ID"
      )
    
    colnames(temp_lsyn) <- c("Unique_ID", "loreau_synchrony") #rename columns
    temp_lsyn$timestep <- k ## create a column for timestep in the temporary data frame

  ## Calculate Gross synchrony metric
    temp_gsyn <- synchrony(
      temp,
      time.var = "Date_numeric",
      species.var = "SPECIES",
      abundance.var = "Pin_Hits",
      replicate.var = "Unique_ID",
      metric="Gross")
    
    colnames(temp_gsyn) <- c("Unique_ID", "gross_synchrony") #rename columns
    temp_gsyn$timestep <- k ## create a column for timestep in the temporary data frame
    
    ## join synchrony dataframes together
    tempsynch <- left_join(temp_lsyn, temp_gsyn, by= c("Unique_ID", "timestep"))
    
    mw_synchrony[((k-1)*n_plots + 1):(k*n_plots),] <- tempsynch ## add synchrony calculations for one iteration to the moving window data frame
    ## ((i-1)*n_plots + 1):(i*n_plots) -> where to put each iteration of the loop
    
  }
  
  return(mw_synchrony) ## retrieve data frame at the end
  
}


#synchrony3 <- synchronymw_func(input_data = annual_all, timestep = 3)
#this returned the message "One or more species has non-varying abundance within a subplot and has been omitted" many times. Probably too short of a timescale to run the synchrony functions over
synchrony4 <- synchronymw_func(input_data = annual_all, timestep = 4)
#got same error message, but only once
synchrony5 <- synchronymw_func(input_data= annual_all, timestep = 5)
#this only returned 11 timesteps. Not sure what happened?
#this is because it has only the June sampling points. 
synchrony7 <- synchronymw_func(input_data = annual_all, timestep = 7)
synchrony10 <- synchronymw_func(input_data = annual_all, timestep = 10)
```


### Calculate TSVR
```{r,  echo=FALSE}
## Calculate Timescale Specific VR ##
#set up data frame to put tsvr into
outnames <- c("Unique_ID", "TREATMENT", "classicVR", "longVR", "shortVR") #column names
siteout <- as.data.frame(matrix(nrow=0, ncol = 5)) #make empty dataframe
names(siteout) <- outnames #set names for empty dataframe
plots <- unique(klee_long$Unique_ID) #make vector of unique plots

## Use for loop to calculate TSVR for each plot
for (i in 1:length(plots)) {
  
  #subset by replicate (gives all observations from one plot over time)
  plot <- subset(klee_long, Unique_ID == plots[i]) %>%
    tbl_df()
  
  #select species and fill 0's 
  plot2 <- plot %>%
    select(Date_numeric, SPECIES, Pin_Hits) %>% #selecting only these three columns
    spread(SPECIES, Pin_Hits, fill = 0) #changing to wide format
  
  #transpose the data 
  dat <- t(as.matrix(plot2[,2:dim(plot2)[2]]))
  
  #create a dataframe with replicate info to attach VR metrics to
  VR_plots <- plot %>%
    select(Unique_ID, TREATMENT, BLOCK) %>%
    unique()
  
  #calculate classic VR
  res0 <- vreq_classic(dat)
  VR_plots$classicVR <- res0[[3]]
  
  #calculate tsvr 
  res <- tsvreq_classic(dat)
  
  #aggregate short vs. long variance ratios
  resLong <- aggts(res, res$ts[res$ts>=4]) #grabbing tsvr with time period >= 4 years
  resShort <- aggts(res, res$ts[res$ts<4]) #grabbing tsvr with time period <4 years
  
  #attach short & long variance ratios
  VR_plots$longVR <- resLong[[3]]
  VR_plots$shortVR <- resShort[[3]]
  
  #append to external dataframe
  siteout<-rbind(siteout, VR_plots)
}

#rename data frame
tsVR <- siteout


## Calculate the mean and standard error of VR metrics
meantsVR <- tsVR %>%
  pivot_longer(cols = classicVR:shortVR, names_to = "VR_type", values_to = "VR_value" ) %>% #change to long format
  group_by(TREATMENT, VR_type) %>%
  summarise(meanVR = mean(VR_value), SEVR = calcSE(VR_value))

#reorder treatments to match grazing pressure.
meantsVR$TREATMENT <- as.factor(meantsVR$TREATMENT) #change treatment to factor
meantsVR$TREATMENT <- factor(meantsVR$TREATMENT, levels = c("0", "W",  "MW",  "C", "MWC", "WC"))

## Compare VR & Stability ##

## join mean stability & mean tsVR data frames. 
tsvr_stab <- inner_join(mean_stability, meantsVR, by = "TREATMENT") 

## Create a data frame with all synchrony and variance ratio metrics in order to make a table.
## change mean synchrony to wide format
meansyn <- mean_synchrony %>%
  pivot_wider(names_from = "Metric_Name", values_from = "mean_value") %>% #make unique columns for each synchrony metric
  group_by(TREATMENT) %>%
  summarise(GS=mean(gross_synchrony, na.rm = T), LS=mean(loreau_synchrony, na.rm = T)) #calculate the mean for each treatment and remove NAs to get rid of the weird column format that pivot wider creates here

## change mean tsvr to wide format
tsvrmean <- tsvr_stab %>%
  pivot_wider(names_from = "VR_type", values_from = "meanVR") %>% #make unique column for each variance ratio metric
  group_by(TREATMENT) %>%
  summarise(classic=mean(classicVR, na.rm = TRUE), short = mean(shortVR, na.rm=TRUE), long=mean(longVR, na.rm = TRUE)) #calculate the mean for each treatment and remove NAs to get rid of the weird column format that pivot wider creates here

## join synchrony and variance ratio data frames
comp_dyn <- left_join(meansyn, tsvrmean, by = "TREATMENT") 
```

## Dominance
### Calculate Berger-Parker Dominance

```{r, echo=FALSE}
## Calculate Berger-Parker Dominance ##
#BP dominance: d = Nmax/N (relative abundance of most dominant species)
BP_dom <- klee_long %>%
  group_by(TREATMENT, Unique_ID, Date_final) %>% #group by treatment, plot, and date
  mutate(rank = rank(Pin_Hits, na.last = NA, ties.method = "average")) %>% #rank species in order of abundance
  mutate(tot_abund = sum(Pin_Hits)) %>% #calculate total abundance
  filter(rank == max(rank)) %>% #only include most abundant species in each plot
  summarise(BP_dominance = Pin_Hits/tot_abund) %>% #calculate Berger-Parker dominance index
  group_by(TREATMENT, Date_final) %>% #group by treatment and date
  summarise(mean_dom = mean(BP_dominance), SEdom = calcSE(BP_dominance)) #calculate mean and SE for each treatment at each date

BP_dom2 <- klee_long %>%
  group_by(TREATMENT, Unique_ID, Date_final) %>% #group by treatment, plot, and date
  mutate(rank = rank(Pin_Hits, na.last = NA, ties.method = "average")) %>% #rank species in order of abundance
  mutate(tot_abund = sum(Pin_Hits)) %>% #calculate total abundance
  filter(rank == max(rank)) %>% #only include most abundant species in each plot
  summarise(BP_dominance = Pin_Hits/tot_abund) %>% #calculate Berger-Parker dominance index
  group_by(TREATMENT, Unique_ID, Date_final) %>% #group by treatment and date
  summarise(mean_dom = mean(BP_dominance), SEdom = calcSE(BP_dominance))

#reorder treatments to match grazing pressure.
BP_dom$TREATMENT <- as.factor(BP_dom$TREATMENT) #change treatment to factor
BP_dom$TREATMENT <- factor(BP_dom$TREATMENT, levels = c("0", "W",  "MW",  "C", "MWC", "WC"))

## calculate the mean dominance index by treatment
avg_BPdom <- BP_dom %>%
  group_by(TREATMENT) %>% #group by treatment
  summarise(avg_dom = mean(mean_dom), SE = calcSE(mean_dom)) #take mean across time for each treatment

dominance <- BP_dom2 %>%
  group_by(Unique_ID) %>%
  summarize(dominance = mean(mean_dom))

dominance <- left_join(dominance, treats, by = "Unique_ID")
dominance <- left_join(dominance, stability, by = c("Unique_ID", "BLOCK", "TREATMENT"))

#reorder treatments to match grazing pressure.
avg_BPdom$TREATMENT <- as.factor(avg_BPdom$TREATMENT) #change treatment to factor
avg_BPdom$TREATMENT <- factor(avg_BPdom$TREATMENT, levels = c("0", "W",  "MW",  "C", "MWC", "WC"))

## join stability & dominance data frames
dom_stab <- inner_join(mean_stability, avg_BPdom, by = "TREATMENT")
```


### Calculate Dominance over a Moving Window

```{r}

## use annual all data frame



test <- annual_all %>%
  group_by(TREATMENT, Unique_ID, Date_final) %>% #group by treatment, plot, and date
  mutate(rank = rank(Pin_Hits, na.last = NA, ties.method = "average")) %>% #rank species in order of abundance
  mutate(tot_abund = sum(Pin_Hits)) %>% #calculate total abundance
  filter(rank == max(rank)) %>% #only include most abundant species in each plot
  summarise(BP_dominance = Pin_Hits/tot_abund) %>% #calculate Berger-Parker dominance index
  group_by(TREATMENT, Date_final) %>% #group by treatment and date
  summarise(mean_dom = mean(BP_dominance), SEdom = calcSE(BP_dominance)) #calculate mean and SE for each treatment at each date


dominancemw_func <- function(input_data, timestep, ...) { ## function inputs = data frame and number of time steps
  
  n_samples <- length(unique(input_data$Date_final)) ## number of sampling points
  n_windows <- n_samples - timestep + 1 ## how many windows to iterate over 
  movingwindow <- data.frame(matrix(ncol=5,nrow=(n_windows*length(unique(input_data$Unique_ID))))) ## create empty dataframe to contain output ## dimensions = # cols (3) x (uniqueID x timesteps)
  colnames(movingwindow) <- c("TREATMENT", "Unique_ID", "Date_final", "BP_dominance","timestep")
  sample_points <- sort(unique(input_data$Date_numeric)) ## create ordered list of sample points
  
  n_plots <- length(unique(input_data$Unique_ID)) ## number of unique plots
  
  for (i in 1:n_windows){
    
    temp_samplepts <- sample_points[i:(i+timestep-1)] ## create a vector of sample points for each iteration
    
    temp <- input_data %>%
      filter(Date_numeric %in% temp_samplepts) ## filter the correct sample points from input data to run through the community stability function
    
    temp_dom <- temp %>%
      group_by(TREATMENT, Unique_ID, Date_final) %>%
      mutate(rank = rank(Pin_Hits, na.last = NA, ties.method = "average")) %>% #rank species in order of abundance
      mutate(tot_abund = sum(Pin_Hits)) %>% #calculate total abundance
      filter(rank == max(rank)) %>% #only include most abundant species in each plot
      summarise(BP_dominance = Pin_Hits/tot_abund) #calculate Berger-Parker dominance index
      
    temp_dom$timestep <- i ## create a column for timestep in the temporary data frame
    
    movingwindow[((i-1)*n_plots + 1):(i*n_plots),] <- temp_dom ## add stability calculations for one iteration to the moving window data frame
    ## ((i-1)*n_plots + 1):(i*n_plots) -> where to put each iteration of the loop
    
  }
  
  return(movingwindow) ## retrieve data frame at the end
  
}



dom5 <- dominancemw_func(input_data = annual_all, timestep = 5)


```

### Calculate Species Rank and Stability
```{r, echo=FALSE}
## make for-loop to calculate dominant species by treatment
## rank species in order of abundance with 1 being most abundant.
rankneg <- klee_long %>%
  group_by(TREATMENT, Unique_ID, Date_final) %>%
  mutate(rank = rank(-Pin_Hits, na.last = NA, ties.method = "average")) %>% #rank species in order of abundance
  mutate(tot_abund = sum(Pin_Hits)) #calculate total abundance


trt <- unique(klee_long$TREATMENT) ## create vector of treatments for loop to iterate over

dominant.sp <- data.frame(SPECIES=NA, stability=NA, rank=NA, SE=NA, TREATMENT=NA) ## create empty dataframe to contain output. Don't know exact number of rows, will need to just make empty columns and bind in loop

domsp <- data.frame(TREATMENT=NA, Date_final=NA, SPECIES=NA,mean=NA, SE=NA)

## create for loop
for (j in 1:length(trt)) {
  
  ## pull out the jth sampling unit from the data
  temp <- rankneg %>%
    filter(TREATMENT == trt[j])
  
  ## filter to contain only the top 2 most abundant species at any point in the time series
  ranktemp <- temp %>%
    filter(rank < 3)
  
  ## make a unique vector of top 2 abundant sp at any point
  tempsp <- unique(ranktemp$SPECIES)
  
  ## filter by top 2 species
  tempspdf <- temp %>%
    filter(SPECIES %in% tempsp) %>%
    group_by(TREATMENT, Date_final, SPECIES) %>%
    summarize(mean=mean(Pin_Hits), SE=calcSE(Pin_Hits))
  
  ## save this to a new data frame
  domsp <- rbind(tempspdf, domsp)

  
  ## filter entire time series by top 2 species to get their full time series. Calculate stability
  tempstab <- temp %>%
    filter(SPECIES %in% tempsp) %>%
    group_by(BLOCK, SPECIES) %>%
    summarise(temp_mean = mean(Pin_Hits), sdhits = sd(Pin_Hits), sp_stability = temp_mean/sdhits, meanrank = mean(rank)) %>%
    ungroup() %>%
    group_by(SPECIES) %>%
    summarise(stability = mean(sp_stability), rank=mean(meanrank), SE = calcSE(sp_stability)) %>%
    mutate(TREATMENT = trt[j])
  
  ## save stability calculations in new dataframe
  dominant.sp <- rbind(tempstab, dominant.sp)
  
}

## Change mean rank to integer
dominant.sp <- dominant.sp %>%
  mutate(rank_int = ifelse(rank <= 1.49, 1, 
                           ifelse(rank > 1.49 & rank <=2.49, 2,  
                                  ifelse(rank > 2.49 & rank <=3.49, 3,
                                         ifelse(rank >3.49 & rank <=4.49, 4,
                                                ifelse(rank >4.49 & rank <=5.49, 5,
                                                       ifelse(rank > 5.49 & rank <=6.49, 6,
                                                              ifelse(rank >6.49 & rank <=7.49, 7,
                                                                     ifelse(rank>7.49 & rank <=8.49, 8,
                                                                            ifelse(rank>8.49 & rank <=9.49,9,
                                                                                   ifelse(rank>9.49 & rank <=10.49, 10, 
                                                                                          ifelse(rank>10.49 & rank <=11.49, 11,
                                                                                                 ifelse(rank >11.49 & rank <=12.49, 12, 
                                                                                                        ifelse(rank >12.49 & rank <= 13.49, 13,
                                                                                                               ifelse(rank >13.49 & rank <=14.49, 14, 15)))))))))))))))

```

## Richness
### Verify Portfolio Effect
```{r, echo=FALSE}
## Verify Portfolio Effect ##

## group by unique ID and species to calculate the mean and variance of each species
portfolio_effect <- klee_long %>%
  filter(!is.na(SPECIES), !is.na(Pin_Hits)) %>% #filter out any NA values
  filter(Pin_Hits > 0) %>% #filter out abundances of 0
  group_by(Unique_ID, SPECIES, TREATMENT) %>% #group by unique_ID & species
  summarise(variance = var(Pin_Hits, na.rm = TRUE), meanhits = mean(Pin_Hits)) %>% #calculate mean & variance
  mutate(logvar = log(variance), logmean = log(meanhits)) #log transform mean and variance

## remove log values less than 0
#linear model doesn't seem to work with NA and 0 values
portfolio <- portfolio_effect %>%
  filter(logvar > 0, logmean > 0)

#run a linear model to calculate the slope
taylor <- lm(logvar~ logmean, data = portfolio)
summary(taylor)
#check that slope is between 1-2
## slope is 1.90052 

## plot log variance and log mean
ggplot(portfolio, aes(x=logmean, y= logvar)) +
  geom_point() +
  geom_smooth(method = "lm")+
  geom_abline(slope = 1, intercept = 0) +
  theme_bw()

```

The slope between the log variance and log mean is 1.9. 

### Calculate Species Richness
```{r, echo=FALSE}
## Calculate total species richness across the time series 
#may need to eventually use presence-absence data (accounts for a lot more rare species)
totalrich <- klee_long %>%
  group_by(TREATMENT, Unique_ID) %>%
  select(Unique_ID, SPECIES, TREATMENT) %>%
  unique() %>%
  summarise(totalrich = n()) %>%
  group_by(TREATMENT) %>%
  summarise(meantotrich = mean(totalrich), totrichSE = calcSE(totalrich))

## Calculate Richness at each Time step 
#calculate richness by grouping by unique ID and date and counting # of observations.
ann_rich <- klee_long %>%
  group_by(Unique_ID, Date_final) %>%
  summarise(richness = n())

rich_time <- klee_long %>%
  group_by(TREATMENT, Unique_ID, Date_final) %>%
  summarise(richness = n()) %>%
  group_by(TREATMENT, Date_final) %>%
  summarise(meanrich = mean(richness), SErich = calcSE(richness))

## Mean Annual Richness
#calculate the average species richness for each plot then each treatment. Average by plot first then by treatment
richness <- left_join(ann_rich, treats, by="Unique_ID") %>%
  group_by(TREATMENT, Unique_ID) %>%
  summarise(meanSR_plot = mean(richness))

richness <- left_join(richness, stability, by = c("Unique_ID", "TREATMENT"))

avg_rich <- left_join(ann_rich, treats, by="Unique_ID") %>%
  group_by(TREATMENT, Unique_ID) %>%
  summarise(meanSR_plot = mean(richness)) %>%
  group_by(TREATMENT) %>%
  summarise(meanSR_tx = mean(meanSR_plot), SESR_tx = calcSE(meanSR_plot))

## Join richness and stability data
rtemp <- left_join(avg_rich, mean_stability, by = "TREATMENT")
richstab <- left_join(rtemp, totalrich, by="TREATMENT")

#reorder treatments to match grazing pressure.
richstab$TREATMENT <- as.factor(richstab$TREATMENT) #change treatment to factor
richstab$TREATMENT <- factor(richstab$TREATMENT, levels = c("0", "W",  "MW",  "C", "MWC", "WC"))

```




# Significance Testing
```{r}
## is stability significantly different by grazing treatment?
## use stability data frame

fitstability <- aov(stability~TREATMENT, data = stability)
summary(fitstability)

TukeyHSD(fitstability)
## O is significantly different from C, MW, MWC, WC
## WC-W are marginally significantly different
## other treatments not significantly different from each other


fitvariance <- aov(variance~TREATMENT, data=variance)
summary(fitvariance)

TukeyHSD(fitvariance)


fitpinhits <- aov(pinhits~TREATMENT, data=pinhits)
summary(fitpinhits)
TukeyHSD(fitpinhits)

## is the dominance index significantly different by grazing treatment?
fitdom <- aov(dominance~TREATMENT, data=dominance)
summary(fitdom)
## treatment not a significant effect


## is richness significantly different by grazing treatment?
fitrich <- aov(meanSR_plot~TREATMENT, data = richness)
summary(fitrich)
## treatment not a significant effect



## is synchrony significantly different by grazing treatment?
fitlsyn <- aov(loreau_synchrony~TREATMENT, data = synchrony_tx)
summary(fitlsyn)
TukeyHSD(fitlsyn)
## O is significantly different from C, MW, MWC, WC
## W-MWC significant
## WC-W are significantly different
## other treatments not significantly different from each other

fitgsyn <- aov(gross_synchrony~TREATMENT, data = synchrony_tx)
summary(fitgsyn)
TukeyHSD(fitgsyn)
## MWC-O marginally significant
## WC-0 significant
## nothing else is significantly different

fittsVRlong <- aov(longVR~TREATMENT, data=tsVR)
summary(fittsVRlong)
TukeyHSD(fittsVRlong)
## O significantly different from C, MW, MWC, WC
## MWC significantly different from C, W
## W-MW marginally significant
## WC-W significantly different

fittsVRshort <- aov(shortVR~TREATMENT, data=tsVR)
summary(fittsVRshort)
## treatment is not significantly different 

fittsVRcl <- aov(classicVR~TREATMENT, data=tsVR)
summary(fittsVRcl)
TukeyHSD(fittsVRcl)
## O significantly different from C, MW, MWC, WC
## MWC-C marginally significant
## WC-C marginally significant
## W-MWC significant
## WC-W significant



## Does synchrony predict stability?
fitstablsyn <- lm(stability~loreau_synchrony, data = synchrony_stability)
summary(fitstablsyn)
## significant

fitstabgsyn <- lm(stability~gross_synchrony, data = synchrony_stability)
summary(fitstabgsyn)


fitstabdom <- lm(stability~dominance, data = dominance)
summary(fitstabdom)
## marginally significant

fitstabrich <- lm(stability~meanSR_plot, data = richness)
summary(fitstabrich)
## marginally significant
```



# Figure Settings
```{r, echo=FALSE, include=FALSE}
green_scale <- c("#97e196", "#6cc08b", "#4c9b82", "#217a79", "#105965", "#074050") #make a vector of colors
colors <- c("#88CCEE", "#CC6677","#DDCC77","#117733","#332288","#AA4499","#44AA99","#999933","#882255","#661100","#6699CC","#888888")
theme_set(theme_classic()) #set the theme
```
  
***

# **Stability Figures**

## Stability: Mean and Variance
```{r, fig.width =10, fig.height=4, echo=FALSE, fig.cap='**Figure 1:** Points show the mean stability (A), total cover (B), and temporal variance (C) for each treatment. Bars show one standard error above and below the mean. Treatment abbreviations are as follows: O = No herbivores, W = Wild mesoherbivores, MW = Megaherbivores and wild mesoherbivores, C = cattle, MWC = Megaherbivores, wild mesoherbivores, and cattle, WC = Wild mesoherbivores and cattle'}

#graph the mean variance by treatment
v <- ggplot(varian, aes(x=TREATMENT, y=meanvar)) +
  geom_point(size=3) +
  geom_errorbar(aes(ymin = meanvar-SEvar, ymax = meanvar+SEvar), width=0.25) +
  ylab("Temporal Variance") + xlab("Treatment") +
  annotate("text", x =1, y=17000, label = "a") +
  annotate("text", x =2, y=15050, label = "ab") +
  annotate("text", x =3, y=12900, label = "ab") +
  annotate("text", x =4, y=11600, label = "bc") +
  annotate("text", x =5, y=9500, label = "c") +
  annotate("text", x =6, y=8500, label = "c")

#graph the mean total pin hits by treatment
b <- ggplot(avg_biomass, aes(x=TREATMENT, y=avgbio)) +
  geom_point(size=3) +
  geom_errorbar(aes(ymin=avgbio-SEbio, ymax=avgbio+SEbio), width = 0.2) + #include standard error bars
  ylab("Total Pin Hits") + xlab("Treatment") +
  annotate("text", x =1, y=1320, label = "a") +
  annotate("text", x =2, y=1290, label = "a") +
  annotate("text", x =3, y=1230, label = "a") +
  annotate("text", x =4, y=1110, label = "b") +
  annotate("text", x =5, y=1065, label = "b") +
  annotate("text", x =6, y=1030, label = "b")

## visualize mean stability & standard error
s <- ggplot(mean_stability, aes(x=TREATMENT, y=mean_st)) +
  geom_point(size=3) +
  geom_errorbar(aes(ymin = mean_st-SEst, ymax=mean_st+SEst), width = 0.2) + #add standard error bars
  ylab("Stability (mean/sd)") + xlab("Treatment") + #label axes
  annotate("text", x =1, y=5.56, label = "a") +
  annotate("text", x =2, y=4.56, label = "ab") +
  annotate("text", x =3, y=4, label = "bc") +
  annotate("text", x =4, y=4.1, label = "bc") +
  annotate("text", x =5, y=3.8, label = "bc") +
  annotate("text", x =6, y=3.5, label = "c")
  #theme(text = element_text(size = 14)) #change font size


## plot 3 panel figure of stability, total pin hits, and temporal variance
ggarrange(s, b, v, 
          labels = c("A", "B", "C"),
          ncol = 3, nrow = 1, 
          align = "hv")

```

## Graph Mean-Variance relationships
```{r}

ggplot(meanvar18, aes(x=log(pinhits), y= log(variance))) +
  geom_point() +
  geom_smooth(method = "lm") +
  geom_abline(slope = 1, intercept = 0) +
  theme_bw()


ggplot(meanvar6, aes(x=log(meanbio), y= log(meanvar), color = TREATMENT)) +
  geom_point() +
  geom_smooth(method = "lm")+
  geom_abline(slope = 1, intercept = 0) +
  theme_bw()
```


***

## Total Cover Time Series
```{r, echo=FALSE, fig.align='center', fig.cap='**Figure 2:** Points represent the mean stability of total cover (temporal mean/temporal standard deviation) for each grazing treatment at each point in time. Treatment abbreviations are as follows: O = No herbivores, W = Wild mesoherbivores, MW = Megaherbivores and wild mesoherbivores, C = cattle, MWC = Megaherbivores, wild mesoherbivores, and cattle, WC = Wild mesoherbivores and cattle'}

#graph the time series of total cover 
ggplot(meantotcov, aes(x=Date_final, y=Mean_TotCov, col=TREATMENT)) + #separate treatments by color
  geom_line(size = 0.5) +
  geom_point(aes(y=Mean_TotCov)) +
  scale_color_manual(values = green_scale) + #change color scheme
  ylab("Total Cover (# Pin Hits)") + xlab("Date") + labs(col = "Treatment") + #add labels
  theme(legend.title = element_text(size=12)) + theme(text = element_text(size = 14)) #change font sizes

```

***

## Stability Over a Moving Window - Annual Sampling
```{r, echo=FALSE, fig.width =12, fig.height=8, fig.cap='**Figure 3:** Stability is calculated over a sliding window of lengths 3 years (A), 5 years (B), 7 years (C), and 10 years (D). Points show the mean stability calculated for each time window. Stability was calculated using data from the annual samplings in June only in order to have consistent sampling frequency.'}
## Visualize annual only data ##
## 3 year time window
antime3 <- left_join(annual_stab3, treats, by="Unique_ID") %>%
  group_by(TREATMENT, timestep) %>%
  summarize(mean = mean(stability), SE = calcSE(stability))

antime3$TREATMENT <- as.factor(antime3$TREATMENT) #change treatment to factor
antime3$TREATMENT <- factor(antime3$TREATMENT, levels = c("0", "W",  "MW",  "C", "MWC", "WC"))

ts3 <- ggplot(antime3, aes(x=timestep, y=mean, color = TREATMENT)) +
  geom_line() +
  geom_point() +
  scale_color_manual(values = colors) + #change color scheme
  ggtitle("3 Year Time Step") +
  ylab("Mean Stability") + xlab("Timestep")


## 5 year time window
antime5 <- left_join(annual_stab5, treats, by="Unique_ID") %>%
  group_by(TREATMENT, timestep) %>%
  summarize(mean = mean(stability), SE = calcSE(stability))

antime5$TREATMENT <- as.factor(antime5$TREATMENT) #change treatment to factor
antime5$TREATMENT <- factor(antime5$TREATMENT, levels = c("0", "W",  "MW",  "C", "MWC", "WC"))

ts5 <- ggplot(antime5, aes(x=timestep, y=mean, color = TREATMENT)) +
  geom_line() +
  geom_point() +
  scale_color_manual(values = colors) + #change color scheme
  ggtitle("5 Year Time Step") +
  ylab("Mean Stability") + xlab("Timestep")


## 7 year time window
antime7 <- left_join(annual_stab7, treats, by="Unique_ID") %>%
  group_by(TREATMENT, timestep) %>%
  summarize(mean = mean(stability), SE = calcSE(stability))

antime7$TREATMENT <- as.factor(antime7$TREATMENT) #change treatment to factor
antime7$TREATMENT <- factor(antime7$TREATMENT, levels = c("0", "W",  "MW",  "C", "MWC", "WC"))

ts7 <- ggplot(antime7, aes(x=timestep, y=mean, color = TREATMENT)) +
  geom_line() +
  geom_point() +
  scale_color_manual(values = colors) + #change color scheme
  ggtitle("7 Year Time Step") +
  ylab("Mean Stability") + xlab("Timestep")


## 10 year time window
antime10 <- left_join(annual_stab10, treats, by="Unique_ID") %>%
  group_by(TREATMENT, timestep) %>%
  summarize(mean = mean(stability), SE = calcSE(stability))

antime10$TREATMENT <- as.factor(antime10$TREATMENT) #change treatment to factor
antime10$TREATMENT <- factor(antime10$TREATMENT, levels = c("0", "W",  "MW",  "C", "MWC", "WC"))

ts10 <- ggplot(antime10, aes(x=timestep, y=mean, color = TREATMENT)) +
  geom_line() +
  geom_point() +
  scale_color_manual(values = colors) + #change color scheme
  ggtitle("10 Year Time Step") +
  ylab("Mean Stability") + xlab("Timestep")


## plot 4 panel figure of different moving windows
ggarrange(ts3, ts5, ts7, ts10, 
          labels = c("A", "B", "C", "D"),
          ncol = 2, nrow = 2)

```


***

# Mechanism Figures

## Synchrony & VR Table
```{r, results='asis', echo=FALSE, fig.cap='**Table 1:** Points show the mean stability value for each grazing treatment. Bars are one standard error. Treatment abbreviations are as follows: 0 = No herbivores, W = Wild mesoherbivores, MW = Megaherbivores and wild mesoherbivores, C = cattle, MWC = Megaherbivores, wild mesoherbivores, and cattle, WC = Wild mesoherbivores and cattle'}

#create a table of all synchrony and variance ratio metrics
kable(comp_dyn, col.names = c("Treatment", "Gross Synchrony", "Loreau Synchrony", "Classic Variance Ratio", "Short Variance Ratio", "Long Variance Ratio"), caption = 'Table 1: Synchrony')

```


***

## Synchrony & grazing treatments
```{r, echo=FALSE, fig.align='center', fig.cap= '**Figure 4:** Points show the synchrony value for each treatment. Circles represent the Loreau synchrony metric and triangles represent the Gross synchrony metric. Points are colored according to grazing treatment, with lighter values indicating less grazing pressure. Treatment abbreviations are as follows: 0 = No herbivores, W = Wild mesoherbivores, MW = Megaherbivores and wild mesoherbivores, C = cattle, MWC = Megaherbivores, wild mesoherbivores, and cattle, WC = Wild mesoherbivores and cattle'}

### SYNCHRONY & Grazing Tx FINAL FIGURE 
ggplot(syn_stab, aes(x=TREATMENT , y=mean_value, col=TREATMENT, shape = Metric_Name)) +
  geom_point(size=3) +
  scale_color_manual(values = green_scale) +
  geom_errorbar(aes(ymin = mean_value-SE_value, ymax=mean_value+SE_value), width = 0.3) +
  ylab("Synchrony") + xlab("Treatment") +  
  theme(legend.title = element_text(size=12)) +  theme(text = element_text(size = 14)) + #change font sizes
  labs(col = "Treatment", shape = "Synchrony Metric") + #add legend titles
  scale_shape_discrete(labels = c("Gross", "Loreau")) #rename synchrony metrics in legend

syngraz <- ggplot(syn_stab, aes(x=TREATMENT , y=mean_value, shape= Metric_Name)) +
  geom_point(size=3) +
  scale_color_manual(values = colors, labels = c("Gross", "Loreau")) +
  geom_errorbar(aes(ymin = mean_value-SE_value, ymax=mean_value+SE_value), width = 0.3) +
  ylab("Synchrony") + xlab("Treatment") +  
  theme(legend.title = element_text(size=12)) +  theme(text = element_text(size = 14)) + #change font sizes
  labs(col = "Treatment", shape = "Synchrony Metric") +
    scale_shape_discrete(labels = c("Gross", "Loreau")) +#rename synchrony metrics in legend
#add legend titles
  annotate("text", x =1, y=0.125, label = "a") +
  annotate("text", x =2, y=0.14, label = "ab") +
  annotate("text", x =3, y=0.205, label = "b") +
  annotate("text", x =4, y=0.185, label = ".b") +
  annotate("text", x =5, y=0.231, label = "bc") +
  annotate("text", x =6, y=0.24, label = "bc") +
  ## gross synchrony
  annotate("text", x =1, y=0.055, label = "a") +
  annotate("text", x =2, y=0.1, label = "a") +
  annotate("text", x =3, y=0.11, label = "a") +
  annotate("text", x =4, y=0.08, label = "a") +
  annotate("text", x =5, y=0.12, label = "b") +
  annotate("text", x =6, y=0.14, label = "b")
  #scale_color_discrete(labels = c("Gross", "Loreau")) #rename synchrony metrics in legend
```

***


## Synchrony & Stability
```{r, echo=FALSE, fig.align='center', fig.cap='**Figure 5:** Points show the mean stability and synchrony values for each grazing treatment. Circles represent the Loreau synchrony metric and triangles represent the Gross synchrony metric. Points are colored according to grazing treatment, with lighter values indicating less grazing pressure. Treatment abbreviations are as follows: 0 = No herbivores, W = Wild mesoherbivores, MW = Megaherbivores and wild mesoherbivores, C = cattle, MWC = Megaherbivores, wild mesoherbivores, and cattle, WC = Wild mesoherbivores and cattle'}

### SYNCHRONY & STABILITY FINAL FIGURE 
ggplot(syn_stab, aes(x=mean_value , y=mean_st, col = TREATMENT, shape=Metric_Name)) +
  geom_point(size=3) +
  scale_color_manual(values = green_scale) +
  geom_errorbar(aes(ymin=mean_st-SEst, ymax=mean_st+SEst), width = 0.005) + #add standard error bars
  geom_errorbarh(aes(xmin = mean_value-SE_value, xmax=mean_value+SE_value), height = 0.1) + #add standard error bars
  ylab("Stability") + xlab("Synchrony") +  #label axes
  theme(legend.title = element_text(size=12)) + theme(text = element_text(size = 14)) + #change font sizes
  labs(col = "Treatment", shape = "Synchrony Metric") +
  scale_shape_discrete(labels = c("Gross", "Loreau"))


synstab <- ggplot(syn_stab, aes(x=mean_value , y=mean_st, col = TREATMENT, shape=Metric_Name)) +
  stat_smooth(method = "lm", col = "black") +
  geom_point(size=3) +
  scale_color_manual(values = green_scale) +
  geom_errorbar(aes(ymin=mean_st-SEst, ymax=mean_st+SEst), width = 0.005) + #add standard error bars
  geom_errorbarh(aes(xmin = mean_value-SE_value, xmax=mean_value+SE_value), height = 0.1) + #add standard error bars
  ylab("Stability") + xlab("Synchrony") +  #label axes
  theme(legend.title = element_text(size=12)) + theme(text = element_text(size = 14)) + #change font sizes
  labs(col = "Treatment", shape = "Synchrony Metric") +
  scale_shape_discrete(labels = c("Gross", "Loreau")) +
  annotate("text", x =0.15, y=6.25, label = "Loreau: y = -13.1211x + 6.1034") +
  annotate("text", x =0.15, y=6, label = "R2 = 0.7702, p-value = 1.05x10^-6") +
  annotate("text", x =0.15, y=5.75, label = "Gross: y = -13.6138x + 5.0258") +
  annotate("text", x =0.15, y=5.5, label = "R2 = 0.3176 , p-value = 0.00875")

```


***
## Synchrony over a moving window

```{r, echo=FALSE, fig.width =12, fig.height=3, fig.cap='**Figure 6:** Loreau synchrony calculated using a moving window of 5 years (A), 7 years (B), and 10 years (C).'}
## Visualize annual only data ##
## 5 year time window
syn5 <- left_join(synchrony5, treats, by="Unique_ID") %>%
  group_by(TREATMENT, timestep) %>%
  summarize(meanloreau = mean(loreau_synchrony), SEloreau = calcSE(loreau_synchrony), meangross = mean(gross_synchrony), SEgross=calcSE(gross_synchrony))

syn5$TREATMENT <- as.factor(syn5$TREATMENT) #change treatment to factor
syn5$TREATMENT <- factor(syn5$TREATMENT, levels = c("0", "W",  "MW",  "C", "MWC", "WC"))

s5 <- ggplot(syn5, aes(x=timestep, y=meanloreau, color = TREATMENT)) +
  geom_line() +
  geom_point() +
  scale_color_manual(values = colors) + #change color scheme
  ggtitle("5 Year Window") +
  ylab("Mean Loreau Synchrony") + xlab("Timestep")


## 7 year time window
syn7 <- left_join(synchrony7, treats, by="Unique_ID") %>%
  group_by(TREATMENT, timestep) %>%
  summarize(meanloreau = mean(loreau_synchrony), SEloreau = calcSE(loreau_synchrony), meangross = mean(gross_synchrony), SEgross=calcSE(gross_synchrony))

syn7$TREATMENT <- as.factor(syn7$TREATMENT) #change treatment to factor
syn7$TREATMENT <- factor(syn7$TREATMENT, levels = c("0", "W",  "MW",  "C", "MWC", "WC"))

s7 <- ggplot(syn7, aes(x=timestep, y=meanloreau, color = TREATMENT)) +
  geom_line() +
  geom_point() +
  scale_color_manual(values = colors) + #change color scheme
  ggtitle("7 Year Window") +
  ylab("Mean Loreau Synchrony") + xlab("Timestep")

## 10 year time window
syn10 <- left_join(synchrony10, treats, by="Unique_ID") %>%
  group_by(TREATMENT, timestep) %>%
  summarize(meanloreau = mean(loreau_synchrony), SEloreau = calcSE(loreau_synchrony), meangross = mean(gross_synchrony), SEgross=calcSE(gross_synchrony))

syn10$TREATMENT <- as.factor(syn10$TREATMENT) #change treatment to factor
syn10$TREATMENT <- factor(syn10$TREATMENT, levels = c("0", "W",  "MW",  "C", "MWC", "WC"))

s10 <- ggplot(syn10, aes(x=timestep, y=meanloreau, color = TREATMENT)) +
  geom_line() +
  geom_point() +
  scale_color_manual(values = colors) + #change color scheme
  ggtitle("10 Year Window") +
  ylab("Mean Loreau Synchrony") + xlab("Timestep")


## plot 3 panel figure of different moving windows
ggarrange(s5, s7, s10, 
          labels = c("A", "B", "C"),
          ncol = 3, nrow = 1)

```


***
## TSVR & Grazing treatment
```{r, echo=FALSE, fig.align='center', fig.cap='**Figure 7:** Points show the variance ratio for each grazing treatment. Color represents the variance ratio type: green is the classic variance ratio, orange is the long variance ratio (timescales > 4 years) and purple is the short variance ratio (timescales < 4 years). Bars show one standard error. Treatment abbreviations are as follows: 0 = No herbivores, W = Wild mesoherbivores, MW = Megaherbivores and wild mesoherbivores, C = cattle, MWC = Megaherbivores, wild mesoherbivores, and cattle, WC = Wild mesoherbivores and cattle'}

### TSVR & GRAZING TREATMENT FINAL FIGURE 
#variance ratio vs. treatment, grouped by VR type
ggplot(meantsVR, aes(x=TREATMENT, y=meanVR, col = VR_type)) +
  geom_hline(yintercept = 1, color = "grey", lty = "dashed") +
  geom_point(size = 3) +
  geom_errorbar(aes(ymin = meanVR-SEVR, ymax = meanVR+SEVR), width = 0.1) +
  theme_bw() +
  scale_color_brewer(palette = "Dark2", labels = c("Classic", "Long", "Short")) +
  ylab("Variance Ratio") + xlab("Treatment") +
  theme(legend.title = element_text(size=12)) +
  theme(text = element_text(size = 14)) +
  labs(col = "Variance Ratio Type") #change legend title

tsVRgraz <- ggplot(meantsVR, aes(x=TREATMENT, y=meanVR, col = VR_type)) +
  geom_hline(yintercept = 1, color = "grey", lty = "dashed") +
  geom_point(size = 3) +
  geom_errorbar(aes(ymin = meanVR-SEVR, ymax = meanVR+SEVR), width = 0.1) +
  theme_bw() +
  scale_color_brewer(palette = "Dark2", labels = c("Classic", "Long", "Short")) +
  ylab("Variance Ratio") + xlab("Treatment") +
  theme(legend.title = element_text(size=12)) +
  theme(text = element_text(size = 14)) +
  labs(col = "Variance Ratio Type") #change legend title
```

***


## Dominance over time
```{r, echo=FALSE, fig.align='center', fig.cap='**Figure 8:** Lines show the mean Berger-Parker dominance across time for each grazing treatment. Treatment abbreviations are as follows: 0 = No herbivores, W = Wild mesoherbivores, MW = Megaherbivores and wild mesoherbivores, C = cattle, MWC = Megaherbivores, wild mesoherbivores, and cattle, WC = Wild mesoherbivores and cattle'}
## Graph dominance over time
ggplot(BP_dom, aes(x=Date_final, y=mean_dom, col=TREATMENT)) +
  geom_line(size = 0.5) +
  theme_bw() +
  #scale_color_brewer(palette = "Dark2") +
  ylab("Berger-Parker Dominance") + xlab("Date") +
  scale_color_manual(values = green_scale) +
  theme(legend.title = element_text(size=12)) +
  theme(text = element_text(size = 14)) +
  labs(col = "Treatment") #change legend title

```


***
## Dominance & Stability
```{r, echo=FALSE, fig.align='center', fig.cap='**Figure 9:** Points represent the mean stability and mean Berger-Parker dominance for each grazing treatment. Points are colored according to grazing treatment. Bars show one standard error. Treatment abbreviations are as follows: 0 = No herbivores, W = Wild mesoherbivores, MW = Megaherbivores and wild mesoherbivores, C = cattle, MWC = Megaherbivores, wild mesoherbivores, and cattle, WC = Wild mesoherbivores and cattle'}
## Graph dominance and stability
ggplot(dom_stab, aes(x=avg_dom, y=mean_st, col=TREATMENT)) +
  geom_point(size = 3) +
  ylab("Stability") + xlab("Berger-Parker Dominance") +
  geom_errorbarh(aes(xmin=avg_dom-SE, xmax=avg_dom+SE)) +
  geom_errorbar(aes(ymin=mean_st-SEst, ymax=mean_st+SEst)) +
  scale_color_manual(values = green_scale) +
  theme(legend.title = element_text(size=12)) +
  theme(text = element_text(size = 14)) +
  labs(col = "Treatment") #change legend title

domstab <- ggplot(dom_stab, aes(x=avg_dom, y=mean_st, col=TREATMENT)) +
  stat_smooth(method = "lm", col = "black") +
  geom_point(size = 3) +
  ylab("Stability") + xlab("Berger-Parker Dominance") +
  geom_errorbarh(aes(xmin=avg_dom-SE, xmax=avg_dom+SE)) +
  geom_errorbar(aes(ymin=mean_st-SEst, ymax=mean_st+SEst)) +
  scale_color_manual(values = green_scale) +
  theme(legend.title = element_text(size=12)) +
  theme(text = element_text(size = 14)) +
  labs(col = "Treatment") + #change legend title
  annotate("text", x =0.31, y=6, label = "y = 8.752x + 1.029") +
  annotate("text", x =0.31, y=5.65, label = "R2 = 0.1431, p-value = 0.0678")


```

***

## Berger-Parker Dominance Table
```{r, echo=FALSE}
kable(avg_BPdom, col.names = c("Treatment", "Mean Berger-Parker Dominance", "Standard Error"), caption = 'Table 2: Dominance')

```


***



## Average Dominance by Treatment
```{r}

ggplot(avg_BPdom, aes(x=TREATMENT, y=avg_dom)) +
  geom_point(size = 3) +
  geom_errorbar(aes(ymin=avg_dom-SE, ymax=avg_dom+SE), width = 0.25) +
  xlab("Treatment") + ylab("Mean Berger-Parker Dominance")

domgraz <- ggplot(avg_BPdom, aes(x=TREATMENT, y=avg_dom)) +
  geom_point(size = 3) +
  geom_errorbar(aes(ymin=avg_dom-SE, ymax=avg_dom+SE), width = 0.25) +
  xlab("Treatment") + ylab("Berger-Parker Dominance") +  
  theme(legend.title = element_text(size=12)) +  theme(text = element_text(size = 14)) + #+ #change font sizes
  annotate("text", x =2, y=0.29, label = "No significant effects")


```

## Dominant species over time
```{r, echo=FALSE, fig.width =14, fig.height=8, fig.cap='**Figure 10:** Points show the mean pin hits for each species at a point in time. Included species were in the top 2 most abundant species in a given treatment at some point in the time series.'}
domsp <- domsp[-1031,]
domsp$TREATMENT <- as.factor(domsp$TREATMENT) #change treatment to factor
domsp$TREATMENT <- factor(domsp$TREATMENT, levels = c("0", "W",  "MW",  "C", "MWC", "WC"))

ggplot(domsp, aes(x=Date_final, y=mean, color=SPECIES)) +
  geom_line() +
  geom_point() +
  facet_wrap(~TREATMENT) +
  scale_color_manual(values = colors) +
  xlab("Date") + ylab("Mean Pin Hits")

```



***


## Dominant Species, Rank, & Stability
```{r, echo=FALSE, fig.width =12, fig.height=6, fig.cap='**Figure 11:** Species stability (mean/sd) for species that were in the top 2 most abundant species in a given treatment at any point in the time series. Bars indicate one standard error above and below the mean. The mean rank of a species was obtained by ranking their abundance in a treatment and taking the mean rank of each species across the time series. '}

dominant.sp <- dominant.sp[-40,]
dominant.sp$TREATMENT <- as.factor(dominant.sp$TREATMENT) #change treatment to factor
dominant.sp$TREATMENT <- factor(dominant.sp$TREATMENT, levels = c("0", "W",  "MW",  "C", "MWC", "WC"))


ggplot(dominant.sp, aes(x=rank, y=stability, col=SPECIES)) +
  geom_point(size=2) +
  ylab("Species Stability") + xlab("Species Mean Rank over Time") +
  #theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)) +
  scale_color_manual(values = colors) +
  geom_errorbar(aes(ymin=stability-SE, ymax=stability+SE), width=0.75) +
  #theme(legend.title = element_text(size=12)) +
  #theme(text = element_text(size = 14)) +
  labs(col = "Species") + #change legend title
  facet_wrap(~TREATMENT) 
```


***

## Richness
```{r, echo=FALSE, fig.width =10, fig.height=4, fig.cap='**Figure 12:** Points show the average annual species richness (A) and the total richness across the timeseries (B) in relation to grazing treatments.'}
## Preliminary Figures 
rich1 <- ggplot(richstab, aes(x=TREATMENT, y=meanSR_tx)) +
  geom_point(size=3) +
  geom_errorbar(aes(ymin=meanSR_tx-SESR_tx, ymax=meanSR_tx+SESR_tx), width=0.25) +
  ylab("Species Richness") +xlab("Treatment") +
  theme(legend.title = element_text(size=12)) +  theme(text = element_text(size = 14)) + #change font sizes
  annotate("text", x =2, y=18.5, label = "No significant effects")

rich2 <- ggplot(richstab, aes(x=TREATMENT, y=meantotrich)) +
  geom_point(size=3) +
  geom_errorbar(aes(ymin=meantotrich-totrichSE, ymax=meantotrich+totrichSE), width=0.25) +
  ylab("All Richness across Timeseries") +xlab("Treatment") +
  theme_bw()

## plot 2 panel figure of different moving windows
ggarrange(rich1, rich2, 
          labels = c("A", "B", "C"),
          ncol = 2, nrow = 1)

```

## Richness and Stability
```{r, echo=FALSE, fig.cap='**Figure 13:** Points show the mean stability and average annual species richness of each grazing treatment.' }
ggplot(richstab, aes(x=meanSR_tx, y=mean_st, color=TREATMENT)) +
  geom_point(size=3) +
  geom_errorbarh(aes(xmin=meanSR_tx-SESR_tx, xmax=meanSR_tx+SESR_tx)) +
  geom_errorbar(aes(ymin=mean_st-SEst, ymax=mean_st+SEst), width=0.15) +
  scale_color_manual(values = green_scale) +
  ylab("Mean Stability") +xlab("Average Species Richness") +
  theme_bw()

richstability <- ggplot(richstab, aes(x=meanSR_tx, y=mean_st, color=TREATMENT)) +
  stat_smooth(method = "lm", col = "black") +
  geom_point(size=3) +
  geom_errorbarh(aes(xmin=meanSR_tx-SESR_tx, xmax=meanSR_tx+SESR_tx)) +
  geom_errorbar(aes(ymin=mean_st-SEst, ymax=mean_st+SEst), width=0.15) +
  scale_color_manual(values = green_scale) +
  ylab("Mean Stability") +xlab("Species Richness") +
  theme(legend.title = element_text(size=12)) +  theme(text = element_text(size = 14)) + #change font sizes
  annotate("text", x =20, y=6, label = "y = -0.1836x + 7.5922") +
  annotate("text", x =20, y=5.7, label = "R2 = 0.00215, p-value = 0.3238")

```


## Richness over time
```{r, echo=FALSE, fig.cap='**Figure 14:** Mean richness over time.'}

rich_time$TREATMENT <- as.factor(rich_time$TREATMENT) #change treatment to factor
rich_time$TREATMENT <- factor(rich_time$TREATMENT, levels = c("0", "W",  "MW",  "C", "MWC", "WC"))

ggplot(rich_time, aes(x=Date_final, y=meanrich, color = TREATMENT)) +
  geom_line(size = 0.5) +
  geom_point() +
  theme_bw() +
  #scale_color_brewer(palette = "Dark2") +
  ylab("Richness") + xlab("Date") +
  scale_color_manual(values = green_scale) +
  theme(legend.title = element_text(size=12)) +
  theme(text = element_text(size = 14)) +
  labs(col = "Treatment") #change legend title

```

## All Mechanisms Combined
```{r, echo=FALSE, fig.width =10, fig.height=10}

ggarrange(syngraz, synstab, domgraz, domstab, rich1, richstability,
          #labels = c("A", "B", "C", "D", "E"),
          ncol = 2, nrow = 3,
          #align = "hv", 
          common.legend = TRUE, 
          labels = c("A", "B", "C", "D", "E", "F"), 
          #vjust = -0.25,
          legend = "bottom")






```




